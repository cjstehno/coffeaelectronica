<html>
<head>
    <title>Embedding Jetty 6 in Spring</title>
    <meta name="grackle.layout" content="post"/>
    <meta name="grackle.date-published" content="2008-08-05T18:13:00.000-05:00"/>
</head>
<body>A few years ago, I wrote a blog entry about <a
        href="http://www.coffeaelectronica.com/2006/02/embedding-jetty-in-spring.html">Embedding Jetty in Spring</a>. It
became quite popular, at least in relation to other pages on my site. Unfortunately, as I noted in the header of that
posting, it has become a bit out-dated as newer versions of Jetty have been released. Well, with a little prodding via
emails and a handful of free time, I have come up with an updated version for <a href="http://jetty.mortbay.com/">Jetty
    6.1.11</a> and <a href="http://springframework.org/">Spring 2.5.5</a> that requires no additional
helper-classes.<br/><a name='more'></a>For simplicity I came up with a spring context for embedding Jetty based on the
example included with Jetty which replicates the default full configuration, <a
        href="http://jetty.mortbay.org/jetty-6/xref/org/mortbay/jetty/example/LikeJettyXml.html">LikeJettyXml.java</a>.
This seemed a good place to start since you will either need all of that, or slightly less... and removing stuff is
simple.<br/><br/>For the most part the spring context configuration mirrors the java source from the example; the only
real deviation comes form the life-cycle addition method calls <tt>addLifeCycle()</tt>, which spring does not directly
support. To perform that one missing dependency injection, you can use the spring <tt>MethodInvokingFactoryBean</tt> to
create a bean and then call a method to inject it into the target bean. <br/><br/>
<pre class="brush:xml">    &lt;bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean"&gt;<br/>        &lt;property name="targetObject" ref="server.Server" /&gt;<br/>        &lt;property name="targetMethod" value="addLifeCycle" /&gt;<br/>        &lt;property name="arguments"&gt;<br/>            &lt;list&gt;&lt;ref local="server.ContextDeployer" /&gt;&lt;/list&gt;<br/>        &lt;/property&gt;<br/>    &lt;/bean&gt;<br/></pre>
<br/>which simply calls the <tt>addLifeCycle</tt> method on the server instance to add the two deployer instances. The
whole context file reads as follows: <br/><br/>
<pre class="brush:xml"> &lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/> &lt;beans xmlns="http://www.springframework.org/schema/beans"<br/>  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;<br/><br/>  &lt;bean id="server.Server" class="org.mortbay.jetty.Server" destroy-method="stop"&gt;<br/>   &lt;property name="threadPool"&gt;<br/>    &lt;bean class="org.mortbay.thread.QueuedThreadPool"&gt;<br/>     &lt;property name="maxThreads" value="100" /&gt;<br/>    &lt;/bean&gt;<br/>   &lt;/property&gt;<br/>   &lt;property name="connectors"&gt;<br/>    &lt;list&gt;<br/>     &lt;bean class="org.mortbay.jetty.nio.SelectChannelConnector"&gt;<br/>      &lt;property name="port" value="8080" /&gt;<br/>      &lt;property name="maxIdleTime" value="30000" /&gt;<br/>     &lt;/bean&gt;<br/>    &lt;/list&gt;<br/>   &lt;/property&gt;<br/>   &lt;property name="handler"&gt;<br/>    &lt;bean class="org.mortbay.jetty.handler.HandlerCollection"&gt;<br/>     &lt;property name="handlers"&gt;<br/>      &lt;list&gt;<br/>       &lt;ref local="server.ContextHandlerCollection" /&gt;<br/>       &lt;bean class="org.mortbay.jetty.handler.DefaultHandler" /&gt;<br/>       &lt;bean class="org.mortbay.jetty.handler.RequestLogHandler"&gt;<br/>        &lt;property name="requestLog"&gt;<br/>         &lt;bean class="org.mortbay.jetty.NCSARequestLog"&gt;<br/>          &lt;constructor-arg value="cfg/logs/jetty-yyyy_mm_dd.log" /&gt;<br/>          &lt;property name="extended" value="false"/&gt;<br/>         &lt;/bean&gt;<br/>        &lt;/property&gt;<br/>       &lt;/bean&gt;<br/>      &lt;/list&gt;<br/>     &lt;/property&gt;<br/>    &lt;/bean&gt;<br/>   &lt;/property&gt;<br/><br/>   &lt;property name="userRealms"&gt;<br/>    &lt;list&gt;<br/>     &lt;bean class="org.mortbay.jetty.security.HashUserRealm"&gt;<br/>      &lt;property name="name" value="Test Realm" /&gt;<br/>      &lt;property name="config" value="cfg/etc/realm.properties" /&gt;<br/>     &lt;/bean&gt;<br/>    &lt;/list&gt;<br/>   &lt;/property&gt;<br/><br/>   &lt;property name="stopAtShutdown" value="true" /&gt;<br/>   &lt;property name="sendServerVersion" value="true"/&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean"&gt;<br/>   &lt;property name="targetObject" ref="server.Server" /&gt;<br/>   &lt;property name="targetMethod" value="addLifeCycle" /&gt;<br/>   &lt;property name="arguments"&gt;<br/>    &lt;list&gt;&lt;ref local="server.ContextDeployer" /&gt;&lt;/list&gt;<br/>     &lt;/property&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean"&gt;<br/>   &lt;property name="targetObject" ref="server.Server" /&gt;<br/>   &lt;property name="targetMethod" value="addLifeCycle" /&gt;<br/>   &lt;property name="arguments"&gt;<br/>    &lt;list&gt;&lt;ref local="server.WebAppDeployer" /&gt;&lt;/list&gt;<br/>     &lt;/property&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean id="server.ContextHandlerCollection" class="org.mortbay.jetty.handler.ContextHandlerCollection" /&gt;<br/><br/>  &lt;bean id="server.ContextDeployer" class="org.mortbay.jetty.deployer.ContextDeployer"&gt;<br/>   &lt;property name="contexts" ref="server.ContextHandlerCollection" /&gt;<br/>   &lt;property name="configurationDir"&gt;<br/>    &lt;bean class="org.mortbay.resource.FileResource"&gt;<br/>     &lt;constructor-arg value="file://./cfg/contexts" /&gt;<br/>    &lt;/bean&gt;<br/>   &lt;/property&gt;<br/>   &lt;property name="scanInterval" value="1" /&gt;<br/>  &lt;/bean&gt;<br/><br/>  &lt;bean id="server.WebAppDeployer" class="org.mortbay.jetty.deployer.WebAppDeployer"&gt;<br/>   &lt;property name="contexts" ref="server.ContextHandlerCollection" /&gt;<br/>   &lt;property name="webAppDir" value="cfg/webapps" /&gt;<br/>   &lt;property name="parentLoaderPriority" value="false" /&gt;<br/>   &lt;property name="extract" value="true" /&gt;<br/>   &lt;property name="allowDuplicates" value="false" /&gt;<br/>   &lt;property name="defaultsDescriptor" value="cfg/etc/webdefault.xml" /&gt;<br/>  &lt;/bean&gt;<br/> &lt;/beans&gt;<br/></pre>
<br/>In order to start the server you need to be sure that the <tt>MethodInvokingFactoryBeans</tt> have been fired
before the server has been started; the easiest way is to start the server with an external class once the context has
loaded. <br/><br/>
<pre class="brush:java"> public class Main {<br/>  public static void main(String[] args) throws Exception {<br/>   ApplicationContext context = new FileSystemXmlApplicationContext("cfg/server-context.xml");<br/>   Server server = (Server)context.getBean("server.Server");<br/>   server.start();<br/>   server.join();<br/>  }<br/> }<br/></pre>
<br/>This should be a good starting point and general template for anything you need... just inject or modify whatever
configuration setup you need for your application. I have attached the zipped up Eclipse project I used to create and
run this test. You will need the following jars somewhere on your classpath: ant-1.6.5.jar, commons-el-1.0.jar,
commons-logging.jar, jasper-compiler-5.5.15.jar, jasper-runtime-5.5.1.5.jar, jetty-6.1.11.jar, jetty-util-6.1.11.jar,
jsp-api-2.0.jar, servlet-api-2.5-6.1.11.jar, and spring.jar... all of which can be found in the lib directories of the
Spring and Jetty distributions uses.
</body>
</html>
