
<html><head>
<title>Versioning with Jackrabbit (JCR)</title>
<meta name="grackle.layout" content="post" />
<meta name="grackle.date-published" content="2009-10-28T17:28:00.000-05:00" />
</head><body>With my recent exploration into <a href="http://jackrabbit.apache.org/">Jackrabbit</a>, the JCR implementation, I figured out the basics of how to use its versioning functionality and decided I should do a little post about it so that I don't lose the code somewhere in the shuffle that is my project-space. <br /><a name='more'></a>I'm going to start out by dumping out the code for my little test runner:  <br /><br /><pre class="brush:java">public class JcrVersioning {<br /><br />    private static final Logger log = LoggerFactory.getLogger(JcrVersioning.class);<br /><br />    public static void main(final String[] args) throws Exception {<br />        final Repository repository = new TransientRepository();<br />        final Session session = repository.login(new SimpleCredentials("username", "password".toCharArray()));<br /><br />        try {<br />            final Node root = session.getRootNode();<br /><br />            // Store content<br />            final Node textNode = root.addNode("mynode");<br /><br />            final Node noteNode = textNode.addNode("alpha");<br />            noteNode.addMixin("mix:versionable");<br />            noteNode.setProperty("content", "I like jackrabbit");<br /><br />            session.save();<br />            noteNode.checkin();<br /><br />            // Retrieve content<br />            final Node node = root.getNode("mynode/alpha");<br />            log.info("Path: " + node.getPath() + " --&gt; " + node.getProperty("content").getString());<br /><br />            noteNode.checkout();<br />            noteNode.setProperty("content","Jackrabbit is cool");<br /><br />            session.save();<br />            noteNode.checkin();<br /><br />            log.info("After Modification: " + noteNode.getPath() + " --&gt; " + noteNode.getProperty("content").getString());<br /><br />            ////<br />            final VersionHistory vh = noteNode.getVersionHistory();<br />            final VersionIterator vi = vh.getAllVersions();<br /><br />            vi.skip(1);<br />            while (vi.hasNext()) {<br />                final Version v = vi.nextVersion();<br />                final NodeIterator ni = v.getNodes();<br /><br />                while (ni.hasNext()) {<br />                    final Node nv = ni.nextNode();<br />                    log.info(" - Found version: " + v.getCreated().getTime() + " --&gt; " + nv.getProperty("content").getString());<br />                }<br />            }<br /><br />            noteNode.checkout();<br /><br />            final VersionHistory versionHistory = noteNode.getVersionHistory();<br />            final VersionIterator versionIterator = versionHistory.getAllVersions();<br /><br />            versionIterator.skip(versionIterator.getSize()-2);<br /><br />            noteNode.restore(versionIterator.nextVersion(), true);<br />            noteNode.checkin();<br /><br />            log.info("After Restore: " + noteNode.getPath() + " --&gt; " + noteNode.getProperty("content").getString());<br /><br />            // Remove content<br />            root.getNode("mynode").remove();<br />            session.save();<br /><br />        } finally {<br />            session.logout();<br />        }<br />    }<br />}<br /></pre><br />which creates a couple nodes, one of which has content. The content is set, modified and then restored to it's initial revision using the JCR versioning functionality. The enabler for versioning the the <tt>mix:versionable</tt> mixin set on the versionable node. Once that is set you need to be cautious of how your <tt>save()</tt> and <tt>checkout()</tt> and <tt>checkin()</tt> calls interact.  When you run this example you will get something like:  <br /><br /><pre class="brush:text">INFO  JcrVersioning  - Path: /mynode/alpha --&gt; I like jackrabbit<br />INFO  JcrVersioning  - After Modification: /mynode/alpha --&gt; Jackrabbit is cool<br />INFO  JcrVersioning  -  - Found version: Wed Oct 28 19:26:59 CDT 2009 --&gt; I like jackrabbit<br />INFO  JcrVersioning  -  - Found version: Wed Oct 28 19:26:59 CDT 2009 --&gt; Jackrabbit is cool<br />INFO  JcrVersioning  - After Restore: /mynode/alpha --&gt; I like jackrabbit<br /></pre><br />Like I said this is really just a storage are for some sample code I came up with... it is what it is. Hopefully it can help if you are stuck with JCR versioning.</body></html>
