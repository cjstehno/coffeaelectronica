<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CoffeaElectronica.com</title>

    <meta name="description" content="A technical blog.">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/favicon.ico">
</head>

<body onload="prettyPrint()">

<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <img src="/images/coffee-banner.jpg" class="img-responsive" />
        </div>
    </div>

    <nav class="navbar navbar-inverse" style="margin-bottom: 2px;">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/index.html">&nbsp;CoffeaElectronica</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/archive.html" title="Archives"><span class="glyphicon glyphicon-calendar"></span></a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" title="Tags"><span class="glyphicon glyphicon-tags"></span> <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            
                                    <li><a href="/tags/ant.html">ant</a></li>
                            
                                    <li><a href="/tags/blog.html">blog</a></li>
                            
                                    <li><a href="/tags/gradle.html">gradle</a></li>
                            
                                    <li><a href="/tags/groovy.html">groovy</a></li>
                            
                                    <li><a href="/tags/java.html">java</a></li>
                            
                                    <li><a href="/tags/javascript.html">javascript</a></li>
                            
                                    <li><a href="/tags/maven.html">maven</a></li>
                            
                                    <li><a href="/tags/python.html">python</a></li>
                            
                                    <li><a href="/tags/spring.html">spring</a></li>
                            
                                    <li><a href="/tags/testing.html">testing</a></li>
                            
                                    <li><a href="/tags/vanilla.html">vanilla</a></li>
                            
                        </ul>
                    </li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://stehno.com" title="Web Site" target="_blank"><span class="glyphicon glyphicon-user"></span></a></li>
                    <li><a href="http://github.com/cjstehno" title="Projects" target="_blank"><span class="glyphicon glyphicon-wrench"></span></a></li>
                    <li><a href="/feed.xml" title="Feed"><span class="glyphicon glyphicon-bullhorn"></span></a></li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>

	
	<h1>Copying Data with ObjectMappers</h1>

	<p><em><span class="glyphicon glyphicon-calendar"></span> 10 October 2015</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/vanilla.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> vanilla</span></a></p>

	<p><p>When working with legacy codebases, I tend to run into a lot of scenarios where I am copying data objects from one format to another while an API is in transition or due to some data model mismatch. </p><p>Suppose we have an object in one system - I am using Groovy because it keeps things simple, but it could be Java as well:</p>
<pre><code class="groovy">class Person {
    long id
    String firstName
    String lastName
    LocalDate birthDate
}
</code></pre><p>and then you are working with a legacy (or external) API which provides similar data in the form of:</p>
<pre><code class="groovy">class Individual {
    long id
    String givenName
    String familyName
    String birthDate
}
</code></pre><p>and now you have to integrate the conversion from the old/external format (<code>Individual</code>) to your internal format (<code>Person</code>).</p><p>You can write the code in Java using the <code>Transformer</code> interface from <a href="http://commons.apache.org/proper/commons-collections/">Apache Commons Collections</a>, which ends up with something like this:</p>
<pre><code class="java">public class IndividualToPerson implements Transformer&lt;Individual,Person&gt;{
    
    public Person transform(Individual indiv){
        Person person = new Person();
        person.setId( indiv.getId() );
        person.setFirstName( indiv.getGivenName() );
        person.setLastName( indiv.getFamilyName() );
        person.setBirthDate( LocalDate.parse(indiv.getBirthDate()) );
        return person;
    }
}
</code></pre><p>I wrote a blog post about this many years ago (<a href="http://coffeaelectronica.com/blog/2005/commons-collections-transformers.html">Commons Collections - Transformers</a>); however, if you have more than a handful of these conversions, you can end up handwriting a lot of the same code over and over, which can be error prone and time consuming. Even switching the code above to full-on Groovy does not really save you much, though it is better:</p>
<pre><code class="java">class IndividualToPerson implements Transformer&lt;Individual,Person&gt;{
    
    Person transform(Individual indiv){
        new Person(
            id: indiv.id,
            firstName: indiv.givenName,
            lastName: indiv.familyName,
            birthDate: LocalDate.parse(indiv.birthDate)
        )
    }
}
</code></pre><p>What I came up with was a simple mapping DSL which allows for straight-forward definitions of the property mappings in the simplest code possible:</p>
<pre><code class="groovy">ObjectMapper inividualToPerson = mapper {
    map &#39;id&#39;
    map &#39;givenName&#39; into &#39;firstName&#39;
    map &#39;familyName&#39; into &#39;lastName&#39;
    map &#39;birthDate&#39; using { d-&gt; LocaleDate.parse(d) }
}
</code></pre><p>which builds an instance of <code>RuntimeObjectMapper</code> which is stateless and thread-safe. The <code>ObjectMapper</code> interface has a method <code>copy(Object source, Object dest)</code> which will copy the properties from the source object to the destination object. Your transformation code ends up something like this:</p>
<pre><code class="groovy">def people = individuals.collect { indiv-&gt;
    Person person = new Person()
    individualToPerson.copy(indiv, person)
    person
}
</code></pre><p>or we can use the <code>create(Object, Class)</code> method as:</p>
<pre><code class="groovy">def people = individuals.collect { indiv-&gt;
    individualToPerson.create(indiv, Person)
}
</code></pre><p>which is just a shortcut method for the same code, as long as you are able to create your destination object with a default constructor, which we are able to do.</p><p>There is also a third, slightly more useful option in this specific collector case:</p>
<pre><code class="groovy">def people = individuals.collect( individualToPerson.collector(Person) )
</code></pre><p>The <code>collector(Class)</code> method returns a <code>Closure</code> that is also a shortcut to the conversion code shown previously. It's mostly syntactic sugar, but it's nice and clean to work with.</p><p>Notice the 'using' method - this allows for conversion of the source data before it is set into the destination object. This is one of the more powerful features of the DSL. Consider the case where your <code>Person</code> class has an embedded <code>Name</code> class:</p>
<pre><code class="groovy">class Person {
    long id
    Name name
    LocalDate birthDate
}

@Canonical
class Name {
    String first
    String last
}
</code></pre><p>Now we want to map the name properties into this new embedded object rather than into the main object. The mapper DSL can do this too:</p>
<pre><code class="groovy">ObjectMapper individualToPerson = mapper {
    map &#39;id&#39;
    map &#39;givenName&#39; into &#39;name&#39; using { p,src-&gt; 
        new Name(src.givenName, src.familyName)
    }
    map &#39;birthDate&#39; using { d-&gt; LocaleDate.parse(d) }
}
</code></pre><p>It's a bit odd since you are mapping two properties into one property, but it gets the job done. The conversion closure will accept up to three parameters (or none) - the first being the source property being converted, the second is the source object instance and the third is the destination object instance. The one thing to keep in mind when using the two and three parameter versions is that the order of your property mapping definitions may begin to matter, especially if you are working with the destination object.</p><p>So far, we have been talking about runtime-based mappers that take your configuration and resolve your property mappings at runtime. It's reasonably efficient since it doesn't do all that much, but consider the case where you have a million objects to transform; those extra property mapping operations start to add up - that's when you go back to hand-coding it unless there is a way to build the mappers at compile time rather than run time...</p><p>There is. This was something I have really wanted to get a hold of for this project and others; the ability to use a DSL to control the AST transformations used in code generation... or, using the mapper DSL in an annotation to create the mapper class at compile time so that it is closer to what you would have hand-coded yourself (and also becomes a bit more performant since there are fewer operations being executed at runtime).</p><p>Using the static approach is simple, you just write the DSL code in the <code>@Mapper</code> annotation on a method, property or field:</p>
<pre><code class="groovy">class Mappers {

    @Mapper({
        map &#39;id&#39;
        map &#39;givenName&#39; into &#39;firstName&#39;
        map &#39;familyName&#39; into &#39;lastName&#39;
        map &#39;birthDate&#39; using { d-&gt; LocaleDate.parse(d) }    
    })
    static final ObjectMapper personMapper(){}
}
</code></pre><p>When the code compiles, a new implementation of <code>ObjectMapper</code> will be created and installed as the return value for the <code>personMapper()</code> method. The static version of the DSL has all of the same functionality of the dynamic version except that it does not support using <code>ObjectMappers</code> direction in the <code>using</code> command; however, a workaround for this is to use a closure.</p><p>Object property mapping/copying is one of those things you don't run into all that often, but it is useful to have a simple alternative to hand-writing the code for it. Both the dynamic and static version of the object mappers discussed here are available in my <a href="http://stehno.com/vanilla">Vanilla</a> library.</p></p>


            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <hr>
                    <div style="text-align:center;">
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a> CoffeaElectronica.com content is copyright &copy; 2016 <a href="http://stehno.com">Christopher J. Stehno</a> and available under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
                    </div>
                </div>
            </div>

        </div>

        <script src="/js/jquery-1.12.4.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/prettify.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-27165855-1', 'auto');
            ga('send', 'pageview');
        </script>
    </body>
</html>
