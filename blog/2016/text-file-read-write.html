<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CoffeaElectronica.com</title>

    <meta name="description" content="A technical blog.">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/favicon.ico">
</head>

<body onload="prettyPrint()">

<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <img src="/images/coffee-banner.jpg" class="img-responsive" />
        </div>
    </div>

    <nav class="navbar navbar-inverse" style="margin-bottom: 2px;">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/index.html">&nbsp;CoffeaElectronica</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/archive.html" title="Archives"><span class="glyphicon glyphicon-calendar"></span></a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" title="Tags"><span class="glyphicon glyphicon-tags"></span> <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            
                                    <li><a href="/tags/ant.html">ant</a></li>
                            
                                    <li><a href="/tags/blog.html">blog</a></li>
                            
                                    <li><a href="/tags/gradle.html">gradle</a></li>
                            
                                    <li><a href="/tags/groovy.html">groovy</a></li>
                            
                                    <li><a href="/tags/java.html">java</a></li>
                            
                                    <li><a href="/tags/javascript.html">javascript</a></li>
                            
                                    <li><a href="/tags/maven.html">maven</a></li>
                            
                                    <li><a href="/tags/python.html">python</a></li>
                            
                                    <li><a href="/tags/spring.html">spring</a></li>
                            
                                    <li><a href="/tags/testing.html">testing</a></li>
                            
                                    <li><a href="/tags/vanilla.html">vanilla</a></li>
                            
                        </ul>
                    </li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://stehno.com" title="Web Site" target="_blank"><span class="glyphicon glyphicon-user"></span></a></li>
                    <li><a href="http://github.com/cjstehno" title="Projects" target="_blank"><span class="glyphicon glyphicon-wrench"></span></a></li>
                    <li><a href="/feed.xml" title="Feed"><span class="glyphicon glyphicon-bullhorn"></span></a></li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>

	
	<h1>Vanilla TextFileReader/Writer</h1>

	<p><em><span class="glyphicon glyphicon-calendar"></span> 06 March 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/vanilla.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> vanilla</span></a></p>

	<p><div class="paragraph"> 
 <p>Something I have found myself doing quite often over my whole career as a developer is reading and writing simple text file data. Whether it is a quick data dump or a data set to be loaded from a 3rd party, it is something I end up doing a lot and usually it is something coded mostly from scratch since, surprisingly enough, there are very few tools available for working with formatted text files. Sure, there are a few for CSV, but quite often I get a reqest to read or write a format that is kind of similar to CSV, but just enough different that it breaks a standard CSV parser for whatever reason. Recently, I decided to add some utility components to my <a href="http://stehno.com/vanilla">Vanilla project</a> with the aim of making these readers and writers simpler to build.</p> 
</div> 
<div class="paragraph"> 
 <p>Let’s start off with the <code>com.stehno.vanilla.text.TextFileWriter</code> and say we have a data source of <code>Person</code> objects in our application that the business wants dumped out to a text file (so they can import it into some business tools that only ever seem capable of importing simple text files). In the application, the data structure looks something like this:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class Person {
    String firstName
    String middleName
    String lastName
    int age
    float height
    float weight
}</code></pre> 
 </div> 
</div> 
<div class="paragraph"> 
 <p>with the <code>TextFileWriter</code> you need to define a <code>LineFormatter</code> which will be used to format the generated lines of text, one per object written. The <code>LineFormatter</code> defines two methods, <code>String formatComment(String)</code> for formatting a comment line, and <code>String formatLine(Object)</code> for formatting a data line. A simple implementation is provided, the <code>CommaSeparatedLineFormatter</code> will generate comment lines prefixed with a <code>#</code> and will expect a <code>Collection</code> object to be formatted and will format it as a CSV line.</p> 
</div> 
<div class="paragraph"> 
 <p>The available implementation will not work for our case, so we will need to define our own <code>LineFormatter</code>. We want the formatted data lines to be of the form:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-text" data-lang="text"># Last-Name,First-Name-Middle-Initial,Attrs
Smith,John Q,{age:42, height:5.9, weight:230.5}</code></pre> 
 </div> 
</div> 
<div class="paragraph"> 
 <p>Yes, that’s a bit of a convoluted format, but I have had to generate worse. Our <code>LineFormatter</code> ends up being something like this:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class PersonLineFormatter implements LineFormatter {

    @Override
    String formatComment(String text) {
        "# $text" <b class="conum">(1)</b>
    }

    @Override
    String formatLine(Object object) {
        Person person = object as Person
        "${person.lastName},${person.firstName} ${person.middleName[0]},{age:${person.age}, height:${person.height}, weight:${person.weight}}" <b class="conum">(2)</b>
    }
}</code></pre> 
 </div> 
</div> 
<div class="colist arabic"> 
 <ol> 
  <li> <p>We specify the comment as being prefixed by a <code>#</code> symbol.</p> </li> 
  <li> <p>Write out the <code>Person</code> object as the formatted <code>String</code></p> </li> 
 </ol> 
</div> 
<div class="paragraph"> 
 <p>We see that implementing the <code>LineFormatter</code> keeps all the application specific logic isolated from the common operation of actually writing the file. Now we can use our formatter as follows:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">TextFileWriter writer = new TextFileWriter(
    lineFormatter: new PersonLineFormatter(),
    filePath: new File(outputDir, 'people.txt')
)

writer.writeComment('Last-Name,First-Name-Middle-Initial,Attrs')

Collection&lt;Person&gt; people = peopleDao.listPeople()

people.each { Person p-&gt;
    writer.write(p)
}</code></pre> 
 </div> 
</div> 
<div class="paragraph"> 
 <p>This will write out the text file in the desired format with very little new coding required.</p> 
</div> 
<div class="paragraph"> 
 <p>Generally, writing out text representations of application data is not really all that challenging, since you have access to the data you need and some control over the formatting of the objects to be represented. The real challenge is usually going in the other direction, when you are reading in a data file from some external source, this is where the <code>com.stehno.vanilla.text.TextFileReader</code> becomes useful.</p> 
</div> 
<div class="paragraph"> 
 <p>Let’s say you receive a request to import the data file we described above, maybe it was generated by the same business tools I mentioned earlier. We have something like this:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-text" data-lang="text"># Last-Name,First-Name-Middle-Initial,Attrs
Smith,John Q,{age:42, height:5.9, weight:230.5}
Jones,Robert M,{age:38, height:5.6, weight:240.0}
Mendez,Jose R,{age:25, height:6.1, weight:232.4}
Smalls,Jessica X,{age:30, height:5.5, weight:175.2}</code></pre> 
 </div> 
</div> 
<div class="paragraph"> 
 <p>The <code>TextFileReader</code> requires a <code>LineParser</code> to parse the input file lines into objects; it defines three methods, <code>boolean parseable(String)</code> which is used to determine whether or not the line should be parsed, <code>Object[] parseLine(String)</code> which is used to parse the line of text, and <code>Object parseItem(Object, int)</code> which is used to parse an individual element of the comma-separated line. There is a default implementation provided, the <code>CommaSeparatedLineParser</code> will parse simple comma-separated lines of text into arrays of Objects based on configured item converters; however, this will not work in the case of our file since there are commas in the data items themselves (the JSON-like format of the last element). So we need to implement one. Our <code>LineParser</code> will look something like the following:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class PersonLineParser implements LineParser {

    boolean parsable(String line){
        line &amp;&amp; !line.startsWith(HASH) <b class="conum">(1)</b>
    }

    Object[] parseLine(String line){ <b class="conum">(2)</b>
        int idx = 0
        def elements = line.split(',').collect { parseItem(it, idx++) }

        [
            new Person(
                firstName:elements[1][0],
                middleName:elements[1][1],
                lastName:elements[0],
                age:elements[2],
                height:elements[3],
                weight:elements[4],
            )
        ] as Object[]
    }

    // Smith,John Q,{age:42, height:5.9, weight:230.5}
    // 0    ,1     ,2      ,3          ,4
    Object parseItem(Object item, int index){ <b class="conum">(3)</b>
        switch(index){
            case 0:
                return item as String
            case 1:
                return item.split(' ')
            case 2:
                return item.split(':')[1] as int
            case 3:
                return item.split(':')[1] as float
            case 4:
                return item.split(':')[1][0..-2] as float
        }
    }
}</code></pre> 
 </div> 
</div> 
<div class="colist arabic"> 
 <ol> 
  <li> <p>We want to ignore blank lines or lines that start with a <code>#</code> symbol.</p> </li> 
  <li> <p>We extract the line items and build the <code>Person</code> object</p> </li> 
  <li> <p>We convert the line items to our desired types</p> </li> 
 </ol> 
</div> 
<div class="paragraph"> 
 <p>It’s not pretty, but it does the job and keeps all the line parsing logic out of the main file loading functionality. Our code to read in the file would look somethign like:</p> 
</div> 
<div class="listingblock"> 
 <div class="content"> 
  <pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">setup:
TextFileReader reader = new TextFileReader(
    filePath: new File(inputDir, 'people.txt'),
    lineParser: new PersonLineParser(),
    firstLine: 2 <b class="conum">(1)</b>
)

when:
def people = []

reader.eachLine { Object[] data -&gt;
    lines &lt;&lt; data[0]
}</code></pre> 
 </div> 
</div> 
<div class="colist arabic"> 
 <ol> 
  <li> <p>We skip the first line, since it will always be the header</p> </li> 
 </ol> 
</div> 
<div class="paragraph"> 
 <p>The provided implementations for both the <code>LineFormatter</code> and <code>LineParser</code> will not account for every scenario, but hopefully they will hit some of them and provide a guideline for implementing your own. If nothing else, these components help to streamline the readign and writing of formatted text data so that you can get it done and focus on other more challenging development tasks.</p> 
</div></p>


            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <hr>
                    <div style="text-align:center;">
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a> CoffeaElectronica.com content is copyright &copy; 2016 <a href="http://stehno.com">Christopher J. Stehno</a> and available under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
                    </div>
                </div>
            </div>

        </div>

        <script src="/js/jquery-1.12.4.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/prettify.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-27165855-1', 'auto');
            ga('send', 'pageview');
        </script>
    </body>
</html>
