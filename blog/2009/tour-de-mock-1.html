<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CoffeaElectronica.com</title>

    <meta name="description" content="A technical blog.">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/favicon.ico">
</head>

<body onload="prettyPrint()">

<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <img src="/images/coffee-banner.jpg" class="img-responsive" />
        </div>
    </div>

    <nav class="navbar navbar-inverse" style="margin-bottom: 2px;">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/index.html">&nbsp;CoffeaElectronica</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/archive.html" title="Archives"><span class="glyphicon glyphicon-calendar"></span></a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" title="Tags"><span class="glyphicon glyphicon-tags"></span> <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            
                                    <li><a href="/tags/ant.html">ant</a></li>
                            
                                    <li><a href="/tags/blog.html">blog</a></li>
                            
                                    <li><a href="/tags/gradle.html">gradle</a></li>
                            
                                    <li><a href="/tags/groovy.html">groovy</a></li>
                            
                                    <li><a href="/tags/java.html">java</a></li>
                            
                                    <li><a href="/tags/javascript.html">javascript</a></li>
                            
                                    <li><a href="/tags/maven.html">maven</a></li>
                            
                                    <li><a href="/tags/python.html">python</a></li>
                            
                                    <li><a href="/tags/spring.html">spring</a></li>
                            
                                    <li><a href="/tags/testing.html">testing</a></li>
                            
                                    <li><a href="/tags/vanilla.html">vanilla</a></li>
                            
                        </ul>
                    </li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://stehno.com" title="Web Site" target="_blank"><span class="glyphicon glyphicon-user"></span></a></li>
                    <li><a href="http://github.com/cjstehno" title="Projects" target="_blank"><span class="glyphicon glyphicon-wrench"></span></a></li>
                    <li><a href="/feed.xml" title="Feed"><span class="glyphicon glyphicon-bullhorn"></span></a></li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>

	
	<h1>Tour de Mock 1 - Spring Mock</h1>

	<p><em><span class="glyphicon glyphicon-calendar"></span> 20 July 2009</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/java.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> java</span></a> <a href='/tags/testing.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> testing</span></a> <a href='/tags/spring.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> spring</span></a></p>

	<p><p>A common practice used in unit testing is the use of "<a href="http://en.wikipedia.org/wiki/Mock_object">Mock Objects</a>", usually called "mocking". There are a handful of robust, mature mocking APIs available and it can be difficult to determine which approach works best for you and your project. With this series of posts I intend to compare some (if not all, over time) of the more well-known and seasoned mocking APIs to showcase their usage, benefits, and drawbacks. To accomplish this comparison I will be writing tests using each API to exercise a simple, yet not-too-trivial test case,<br/>requiring the mocking of both interfaces and concrete classes.</p><p>I will be writing the test cases using <a href="http://junit.org/">JUnit 4</a> with annotations. For example purposes, let's suppose we have a servlet which is used to retrieve a list of email addresses when given a list name, <code>listName</code> request parameter:</p>
<pre><code class="java">public class EmailListServlet extends HttpServlet {

    private EmailListService emailListService;

    public void init() throws ServletException {
        final ServletContext servletContext = getServletContext();
        this.emailListService = (EmailListService)servletContext.getAttribute(EmailListService.KEY);

        if(emailListService == null) throw new ServletException(&quot;No ListService available!&quot;);
    }

    protected void doGet(final HttpServletRequest req, final HttpServletResponse res) throws ServletException, IOException {
        final String listName = req.getParameter(&quot;listName&quot;);
        final List&lt;String&gt; list = emailListService.getListByName(listName);
        PrintWriter writer = null;
        try {
            writer = res.getWriter();
            for(final String email : list){
                writer.println(email);
            }
        } finally {
            if(writer != null) writer.close();
        }
    }
}
</code></pre><p>You will notice that the servlet pulls the list from an <code>EmailListService</code> service interface:</p>
<pre><code class="java">public interface EmailListService {
    public static final String KEY = &quot;com.stehno.mockery.service.EmailListService&quot;;

    /**
     * Retrieves the list of email addresses with the specified name. If no list
     * exists with that name an IOException is thrown.
     */
    List&lt;String&gt; getListByName(String listName) throws IOException;
}
</code></pre><p>Okay, so it's not great design, but this is what you get sometimes... if it makes you feel better you can say that you started working on a project and this is one of the servlets you are supposed to write a test for. Feel better now?</p><p>To start off with, let's just say we are going to write a unit test for the servlet without any help from<br/>a mocking API. You create the test case (just a plain old class with <code>@Test</code> annotations in it with JUnit 4 and realize that the first thing you need to do is mock out the <code>EmailListService</code> interface. That's not too hard; it's an interface so you can simply implement it with your own <code>MockEmailListService</code> class. Not bad at all.</p><p>Next you realize that you need to get this service class into the <code>ServletContext</code> by way of a <code>ServletConfig</code> instance. Both of these are interfaces with no server-independent implementations... and they have quite a few methods to implement. What's worse is that you will eventually need to implement <code>HttpServletRequest</code> and <code>HttpServletResponse</code>. Go look at their JavaDocs. You will end up writing more code for your mock implementations than there are lines of code in the rest of the project and you won't be using more than about 25% of it for this test. Now, you could figure it's just the price you pay for testing and trudge onward, but wait, <a href="http://http//springsource.org">SpringFramework</a> to the rescue.</p><p>The spring-mock (called spring-test in later releases) module provides a good set of web-related mock implementations, and this is the first stop on our mocking tour. The <code>org.springframework.mock.web</code> package provides <code>ServletConfig</code>, <code>ServletContext</code>, <code>MockHttpServletRequest</code> and a <code>MockHttpServletResponse</code> mock implementations so that we don't have to implement them ourselves. Let's create our first example test, called <code>EmailListServlet_SpringMockTest</code>. In the <code>@Before public void before()</code> method you will see the instantiation of our <code>MockEmailListService</code> (yes, we still have to create that one) and it's injection into<br/>the <code>ServletContext</code> by way of the <code>ServletConfig</code>. The request and response mocks are also instantiated for use in the test methods. (If you are unfamiliar with JUnit 4 testing, you may want to check out the documentation, or just understand that the <code>@Before</code> annotation means that the method will be called before each test method, annotated with <code>@Test</code>).</p>
<pre><code class="java">@Before
public void before() throws ServletException {
    final MockEmailListService emailListService = new MockEmailListService();
    final MockServletConfig servletConfig = new MockServletConfig();

    servletConfig.getServletContext().setAttribute(EmailListService.KEY, emailListService);
    this.servlet = new EmailListServlet();
    servlet.init(servletConfig);
    this.request = new MockHttpServletRequest();
    this.response = new MockHttpServletResponse();
}
</code></pre><p>Our implementation of the <code>EmailListService</code> simply returns a list of emails when a non-null list name is used, and throws an exception if a null list name is passed:</p>
<pre><code class="java">private static class MockEmailListService implements EmailListService {

    @Override
    public List&lt;String&gt; getListByName(final String listName) throws IOException {
        if(listName == null){
            throw new IOException();
        } else {
            return Arrays.asList(&quot;larry@stooge.com&quot;,&quot;moe@stooge.com&quot;,&quot;curley@stooge.com&quot;);
        }
    }
}
</code></pre><p>The first test to write is a simple test of the exception thrown when no list name is specified:</p>
<pre><code class="java">@Test(expected=IOException.class)
public void doGet_without_list() throws Exception {
    servlet.doGet(request, response);
}
</code></pre><p>That's pretty simple. Now, let's test the case when a list name is actually passed in:</p>
<pre><code class="java">@Test
public void doGet_with_list() throws Exception {
    request.setParameter(&quot;listName&quot;, &quot;foolist&quot;);
    servlet.doGet(request, response);
    assertEquals(
        &quot;larry@stooge.com&quot; + sep + &quot;moe@stooge.com&quot; + sep + &quot;curley@stooge.com&quot; + sep,
        response.getContentAsString()
    );
}
</code></pre><p>Again, it's pretty straight-forward. The whole test class is as follows:</p>
<pre><code class="java">public class EmailListServlet_SpringMockTest {
    private static final String sep = System.getProperty(&quot;line.separator&quot;);
    private EmailListServlet servlet;
    private MockHttpServletRequest request;
    private MockHttpServletResponse response;

    @Before
    public void before() throws ServletException {
        final MockEmailListService emailListService = new MockEmailListService();
        final MockServletConfig servletConfig = new MockServletConfig();
        servletConfig.getServletContext().setAttribute(EmailListService.KEY, emailListService);
        this.servlet = new EmailListServlet();
        servlet.init(servletConfig);
        this.request = new MockHttpServletRequest();
        this.response = new MockHttpServletResponse();
    }

    @Test(expected=IOException.class)
    public void doGet_without_list() throws Exception {
        servlet.doGet(request, response);
    }

    @Test
    public void doGet_with_list() throws Exception {
        request.setParameter(&quot;listName&quot;, &quot;foolist&quot;);
        servlet.doGet(request, response);
        assertEquals(&quot;larry@stooge.com&quot; + sep + &quot;moe@stooge.com&quot; + sep + &quot;curley@stooge.com&quot; + sep,response.getContentAsString());
    }

    private static class MockEmailListService implements EmailListService {

        @Override
        public List&lt;String&gt; getListByName(final String listName) throws IOException {
            if(listName == null){
                throw new IOException();
            } else {
                return Arrays.asList(&quot;larry@stooge.com&quot;,&quot;moe@stooge.com&quot;,&quot;curley@stooge.com&quot;);
            }
        }
    }
}
</code></pre><p>The spring mocking API is great, when you can use it, but it only has mocks for common (known) APIs; for anything beyond that you will have to do the mocking yourself. I try to use it whenever I can since it provides the implementation plumbing that you would need for some of the other mocking techniques.</p>
<blockquote><p>You can find the source code used in this posting in my <a href="http://github.com/cjstehno/coffeaelectronica/tree/master/tourdemock">TourDeMock</a> project.</p>
</blockquote></p>


            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <hr>
                    <div style="text-align:center;">
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a> CoffeaElectronica.com content is copyright &copy; 2016 <a href="http://stehno.com">Christopher J. Stehno</a> and available under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
                    </div>
                </div>
            </div>

        </div>

        <script src="/js/jquery-1.12.4.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/prettify.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-27165855-1', 'auto');
            ga('send', 'pageview');
        </script>
    </body>
</html>
