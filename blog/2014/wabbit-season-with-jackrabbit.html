<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Wabbit Season with Jackrabbit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="shortcut icon" href="/favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
   
	
		<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">CoffeaElectronica.com</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/about.html">About</a></li>
            <li><a href="/archive.html">Archive</a></li>
            
             <li role="presentation" class="dropdown">
	      <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-expanded="false">
		Tags <span class="caret"></span>
	      </a>
	      <ul class="dropdown-menu" role="menu">
		
		  <li><a href="/tags/ant.html">ant</a></li>
		
		  <li><a href="/tags/blog.html">blog</a></li>
		
		  <li><a href="/tags/gradle.html">gradle</a></li>
		
		  <li><a href="/tags/groovy.html">groovy</a></li>
		
		  <li><a href="/tags/java.html">java</a></li>
		
		  <li><a href="/tags/javascript.html">javascript</a></li>
		
		  <li><a href="/tags/maven.html">maven</a></li>
		
		  <li><a href="/tags/python.html">python</a></li>
		
		  <li><a href="/tags/spring.html">spring</a></li>
		
		  <li><a href="/tags/testing.html">testing</a></li>
		
		
	      </ul>
	    </li>
            
            <li><a href="/feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
    

	
	<div class="page-header">
		<h1>Wabbit Season with Jackrabbit</h1>
	</div>

	<p><em>23 August 2014</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/java.html'>java</a>, <a href='/tags/groovy.html'>groovy</a></p>

	<p><p>I have been playing with <a href="http://jackrabbit.apache.org">Apache Jackrabbit</a> today, while doing some research for one of my personal projects, and while it seems to have matured a bit since the last time I looked into it, the documentation has stagnated. Granted, it still works as a jump-start better than nothing at all, but it really does not reflect the current state of the API. I present here a more modern take on the "<a href="http://jackrabbit.apache.org/first-hops.html">First Hops</a>" document based on what I did for my research - I am using Gradle, Groovy, and generally more modern versions of the libraries involved. Maybe this can help others, or myself at a later date.</p><h2>Getting Started</h2><p>The quickest and easiest way to get started is using an embedded <code>TransientRepository</code>. Create a project directory and create a <code>build.groovy</code> Gradle build file similar to the following:</p>
<pre><code class="groovy">apply plugin: &#39;groovy&#39;

repositories {
    jcenter()
}

dependencies {
    compile &#39;org.codehaus.groovy:groovy-all:2.3.6&#39;

    compile &#39;javax.jcr:jcr:2.0&#39;
    compile &#39;org.apache.jackrabbit:jackrabbit-core:2.8.0&#39;
    compile &#39;org.slf4j:slf4j-log4j12:1.7.7&#39;
}
</code></pre><p>This will give you the required dependencies and a nice playground project to work with.</p><h2>Logging in to Jackrabbit</h2><p>In the <code>src/main/groovy</code> directory of the project, create a file called <code>Rabbits.groovy</code> with the following code:</p>
<pre><code class="groovy">import groovy.util.logging.Slf4j
import org.apache.jackrabbit.core.TransientRepository

import javax.jcr.Repository
import javax.jcr.Session

@Slf4j
class Rabbits {

    static void main(args) throws Exception {
        Repository repository = new TransientRepository(
            new File(&#39;./build/repository&#39;)
        )

        Session session = repository.login()
        try {
            String user = session.getUserID()
            String name = repository.getDescriptor(Repository.REP_NAME_DESC)

            log.info &#39;Logged in as {} to a {} repository.&#39;, user, name

        } finally {
            session.logout()
        }
    }
}
</code></pre><p>The important part here is the <code>TransientRepository</code> code, which allows you to use/reuse a repository for testing. I found that specifying a repository directory in my build directory was useful since by default it will put a bunch of files and directories in the root of your project when you run the project - it's just a little cleaner when you can run <code>gradle clean</code> to wipe out your development repository when needed. The downside of specifying the directory seems to be that your repository is not completely transient. I was not clear whether or not this was always the case or just when I set the directory, hence the need to wipe it out sometimes.</p><p>The rest of the code is pretty clear, it just does a login to the repository and writes out some information. When run, you should get something like the following:</p>
<pre><code class="2014-08-23 15:23:09 Rabbits [INFO] Logged in as anonymous to a Jackrabbit repository.```"><br/>The `finally` block is used to always logout of the repository, though this seems a bit dubious because it seemed quite easy to lock the repository in a bad state when errors caused application failure - this will require some additional investigation.

Lastly, to round out the first version of the project, create a `log4j.properties` file in `src/main/resources` so that your logger has some configuration. I used:

</code></pre><p>log4j.rootCategory=INFO, Cons</p><h1>log4j.logger.com.something=ERROR</h1><p>log4j.logger.org.apache.jackrabbit=WARN</p><p>log4j.appender.Cons = org.apache.log4j.ConsoleAppender<br/>log4j.appender.Cons.layout = org.apache.log4j.PatternLayout<br/>log4j.appender.Cons.layout.ConversionPattern = %d{yyyy-MM-dd HH:mm:ss} %c{1} [%p] %m%n<br/>```</p>
<blockquote><p>If you want to see more about what Jackrabbit is doing, set the logging level for <code>log4j.logger.org.apache.jackrabbit</code> to <code>INFO</code> - it gets a little verbose, so I turned it down to WARN.</p>
</blockquote><h2>Working with Content</h2><p>When using a content repository, you probably want to do something with actual content, so let's start off with a simple case of some nodes with simple text content. The <code>main</code> method of the <code>Rabbits</code> class now becomes:</p>
<pre><code class="groovy">Repository repository = new TransientRepository(
    new File(&#39;./build/repository&#39;)
)

Session session = repository.login(
    new SimpleCredentials(&#39;admin&#39;,&#39;admin&#39;.toCharArray())
)

try {
    String username = session.userID
    String name = repository.getDescriptor(Repository.REP_NAME_DESC)
    log.info &#39;User ({}) logged into repository ({})&#39;, username, name

    Node root = session.rootNode

    // Store content
    Node hello = root.addNode(&#39;hello&#39;)
    Node world = hello.addNode(&#39;world&#39;)
    world.setProperty(&#39;message&#39;, &#39;Hello, World!&#39;)
    session.save()

    // Retrieve content
    Node node = root.getNode(&#39;hello/world&#39;)
    log.info &#39;Found node ({}) with property: {}&#39;, node.path, node.getProperty(&#39;message&#39;).string

    // Remove content
    root.getNode(&#39;hello&#39;).remove()
    log.info &#39;Removed node.&#39;

    session.save()

} finally {
    session.logout()
}
</code></pre><p>Notice, that the login code now contains credentials so that we can login with a writable session rather than the read-only default session (previous example).</p><p>First, we need to store some content in the repository. Since Jackrabbit is a hierarchical data store, you need to get a reference to the root node, and then add a child node to it with some content:</p>
<pre><code class="groovy">Node root = session.rootNode

// Store content
Node hello = root.addNode(&#39;hello&#39;)
Node world = hello.addNode(&#39;world&#39;)
world.setProperty(&#39;message&#39;, &#39;Hello, World!&#39;)
session.save()
</code></pre><p>We create a node named "hello", the add a child named "world" to that node, and give the child node a "message" property. Notice that we save the session to persist the changes to the underlying data store.</p><p>Next, we want to read the data back out:</p>
<pre><code class="groovy">Node node = root.getNode(&#39;hello/world&#39;)
log.info &#39;Found node ({}) with property: {}&#39;, node.path, node.getProperty(&#39;message&#39;).string
</code></pre><p>You just get the node by it's relative path, in this case from the root, and then retrieve its data.</p><p>Lastly, for this example, we want to remove the nodes we just added:</p>
<pre><code class="groovy">root.getNode(&#39;hello&#39;).remove()
session.save()
log.info &#39;Removed node.&#39;
</code></pre><p>Removing the "hello" node removes it and it's children (i.e. the "world" node). We then save the session to commit the node removal.</p><p>When you run this version of the code, you should see something like this:</p>
<pre><code>2014-08-23 15:45:18 Rabbits [INFO] User (admin) logged into repository (Jackrabbit)
2014-08-23 15:45:18 Rabbits [INFO] Found node (/hello/world) with property: Hello, World!
2014-08-23 15:45:18 Rabbits [INFO] Removed node.
</code></pre><h2>Working with Binary Content</h2><p>This is where my tour diverts from the original wiki document, which goes on to cover XML data imports. I was more interested in loading binary content, especially image files. To accomplish this, we need to consider how the data is stored in JCR. I found a very helpful article "<a href="https://docs.jboss.org/author/display/MODE/Storing+files+and+folders?_sscc=t">Storing Files and Folders</a>" from the ModeShape documentation (another JCR implementation) - since it's standard JCR, it is still relevant with Jackrabbit.</p><p>Basically you need a node for the file and it's metadata, which has a child node for the actual file content. The article has some nice explanations and diagrams, so if you want more than code and quick discussion I recommend you head over there and take a look at it. For my purpose, I am just going to ingest a single image file and then read out the data to ensure that it was actually stored. The code for the <code>try/finally</code> block of our example becomes:</p>
<pre><code class="groovy">String username = session.userID
String name = repository.getDescriptor(Repository.REP_NAME_DESC)
log.info &#39;User ({}) logged into repository ({})&#39;, username, name

Node root = session.rootNode

// Assume that we have a file that exists and can be read ...
File file = IMAGE_FILE

// Determine the last-modified by value of the file (if important) ...
Calendar lastModified = Calendar.instance
lastModified.setTimeInMillis(file.lastModified())

// Create an &#39;nt:file&#39; node at the supplied path ...
Node fileNode = root.addNode(file.name, &#39;nt:file&#39;)

// Upload the file to that node ...
Node contentNode = fileNode.addNode(&#39;jcr:content&#39;, &#39;nt:resource&#39;)
Binary binary = session.valueFactory.createBinary(file.newInputStream())
contentNode.setProperty(&#39;jcr:data&#39;, binary)
contentNode.setProperty(&#39;jcr:lastModified&#39;,lastModified)

// Save the session (and auto-created the properties) ...
session.save()

log.info &#39;Stored image file data into node ({})...&#39;, file.name

// now get the image node data back out

def node = root.getNode(file.name)
dumpProps node

dumpProps node.getNode(&#39;jcr:content&#39;)
</code></pre><p>Where <code>IMAGE_FILE</code> is a <code>File</code> object pointing to a JPEG image file.</p><p>The first thing we do is create the file node:</p>
<pre><code class="groovy">Node fileNode = root.addNode(file.name, &#39;nt:file&#39;)
</code></pre><p>Notice, it's of type <code>nt:file</code> to designate that it's a file node - you will want to brush up on NodeTypes in the Jackrabbit or JCR documentation if you don't already have a basic understanding; I won't do much more than use them in these examples. For the name of the node, we just use the file name.</p><p>Second, we create the file content node as a child of the file node:</p>
<pre><code class="groovy">Node contentNode = fileNode.addNode(&#39;jcr:content&#39;, &#39;nt:resource&#39;)
Binary binary = session.valueFactory.createBinary(file.newInputStream())
contentNode.setProperty(&#39;jcr:data&#39;, binary)
contentNode.setProperty(&#39;jcr:lastModified&#39;,lastModified)

// Save the session (and auto-created the properties) ...
session.save()
</code></pre><p>Notice that the child node is named "jcr:content" and is of type "nt:resource" and that it has a property named "jcr:data" containing the binary data content for the file. Of course, the session is saved to persist the changes.</p><p>Once we have the file data stored, we want to pull it back out to see that we stored everything as intended:</p>
<pre><code class="groovy">def node = root.getNode(file.name)
dumpProps node

dumpProps node.getNode(&#39;jcr:content&#39;)
</code></pre><p>The <code>dumpProps</code> method just iterates the properties of a given node and writes them to the log file:</p>
<pre><code class="groovy">private static void dumpProps( Node node ){
    log.info &#39;Node: ({})&#39;, node.name

    def iter = node.properties
    while( iter.hasNext() ){
        def prop = iter.nextProperty()
        if( prop.type != PropertyType.BINARY ){
            log.info &#39; - {} : {}&#39;, prop.name, prop.value.string
        } else {
            log.info &#39; - {} : &lt;binary-data&gt;&#39;, prop.name
        }
    }
}
</code></pre><p>When you run this version of the code, you will have output similar to:</p>
<pre><code>2014-08-23 16:09:18 Rabbits [INFO] User (admin) logged into repository (Jackrabbit)
2014-08-23 16:09:18 Rabbits [INFO] Stored image file data into node (2014-08-19 20.49.40.jpg)...
2014-08-23 16:09:18 Rabbits [INFO] Node: (2014-08-19 20.49.40.jpg)
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:createdBy : admin
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:created : 2014-08-23T15:59:26.155-05:00
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:primaryType : nt:file
2014-08-23 16:09:18 Rabbits [INFO] Node: (jcr:content)
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:lastModified : 2014-08-19T20:49:44.000-05:00
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:data : &lt;binary-data&gt;
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:lastModifiedBy : admin
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:uuid : cbdefd4a-ec2f-42d2-b58a-a39942766723
2014-08-23 16:09:18 Rabbits [INFO]  - jcr:primaryType : nt:resource
</code></pre><h2>Conclusion</h2><p>Jackrabbit seems to still have some development effort behind it, and it's still a lot easier to setup and use when compared with something like ModeShape, which seems to be the only other viable JCR implementation which is not specifically geared to a target use case.</p><p>The documentation is lacking, but with some previous experience and a little experimentation, it was not too painful getting things to work.</p></p>

	<hr />
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 <a href="https://plus.google.com/+ChristopherStehno">Christopher J. Stehno</a> | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../js/jquery-1.11.1.min.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/prettify.js"></script>
    
  </body>
</html>