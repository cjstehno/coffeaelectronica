<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>CoffeaElectronica.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="shortcut icon" href="/favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
   

		<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">CoffeaElectronica.com</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/about.html">About</a></li>
            <li><a href="/archive.html">Archive</a></li>
            
             <li role="presentation" class="dropdown">
	      <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-expanded="false">
		Tags <span class="caret"></span>
	      </a>
	      <ul class="dropdown-menu" role="menu">
		
		  <li><a href="/tags/ant.html">ant</a></li>
		
		  <li><a href="/tags/blog.html">blog</a></li>
		
		  <li><a href="/tags/gradle.html">gradle</a></li>
		
		  <li><a href="/tags/groovy.html">groovy</a></li>
		
		  <li><a href="/tags/java.html">java</a></li>
		
		  <li><a href="/tags/javascript.html">javascript</a></li>
		
		  <li><a href="/tags/maven.html">maven</a></li>
		
		  <li><a href="/tags/python.html">python</a></li>
		
		  <li><a href="/tags/spring.html">spring</a></li>
		
		  <li><a href="/tags/testing.html">testing</a></li>
		
		  <li><a href="/tags/vanilla.html">vanilla</a></li>
		
		
	      </ul>
	    </li>
            
            <li><a href="/feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
    


	
		<a href="blog/2016/httpbuilder-ng-demo.html"><h1>HTTP Builder NG for Groovy and Java</h1></a>
		<p><em>18 September 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a></p>
		<p><div class="paragraph">
<p>The <a href="https://github.com/jgritman/httpbuilder"><code>HttpBuilder</code></a> project has been a go-to library for the simplification of HTTP requests for years; however, development on the project has stalled and seemingly
died. A friend of mine (<a href="https://github.com/dwclark">Dave Clark</a>) decided to pick up where the project left off and to bring it up-to-date with modern Groovy and Java 8 support. The
<a href="https://github.com/dwclark/http-builder-ng">HTTP Builder NG</a> project is a major update and refactor of the original project. I joined on to help with development, documentation and testing. In my opinion,
this effort has brought the library back from the dead, better than ever. In this post, I will walk through accessing a simple REST service using the <code>HttpBuilder</code> with both Groovy and Java examples -
yes, the new version of the library supports standard Java 8 coding.</p>
</div>
<div class="paragraph">
<p>First, we need a REST service to work with. I have thrown together a simple set of endpoints using the <a href="http://sparkjava.com">Spark Web Framework</a> to make a "message of the day" service. There are three
endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /message</code> - retrieves the current stored message</p>
</li>
<li>
<p><code>POST /message</code> - saves the <code>text</code> field of the JSON body content as the new message</p>
</li>
<li>
<p><code>DELETE /message</code> - deletes the current message</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is not much to it, but it should be enough to play with. You can find the code in the [repo for this post](<a href="https://github.com/cjstehno/httpb-demo" class="bare">https://github.com/cjstehno/httpb-demo</a>). Startup the server by running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew run</pre>
</div>
</div>
<div class="paragraph">
<p>In the root of the project. The server will be running on <a href="http://localhost:4567" class="bare">http://localhost:4567</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start off by retrieving the current message from the server. We need a base configured <code>HttpBuilder</code> object to make requests from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">HttpBuilder http = HttpBuilder.configure {
    request.uri = 'http://localhost:4567'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we need to make a <code>GET</code> request to the <code>/message</code> path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def result = http.get {
    request.uri.path = '/message'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run this code, you will get the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[text:n/a, timestamp:2016-09-16T12:47:55+0000]</pre>
</div>
</div>
<div class="paragraph">
<p>which is a <code>Map</code> of the parsed JSON data coming back from the server - the <code>HttpBuilder</code> recognizes the <code>application/json</code> response content and parses it for you. In this case
all we really want is the text, so let&#8217;s transform the response data a bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String text = http.get(String){
    request.uri.path = '/message'
    response.success { FromServer from, Object body-&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added an expected result type of <code>String</code> and a <code>response.success()</code> handler. This handler will be called when a successful response code is received (code &lt; 400). When
it is called it will pull the text field out of our body object, which in this case, is the already-parsed JSON data. The return value from the <code>success()</code> method is returned
as the result - the text of the current message. When you run this version of the code you get the current message text:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>n/a</pre>
</div>
</div>
<div class="paragraph">
<p>This is the default "empty" message content. How do we update the message to something more interesting? The service exposes <code>POST /message</code> which will take the <code>text</code> field of the request body
content and use it as the new message. We can write a <code>POST</code> request just as easily as our <code>GET</code> request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String updated = http.post(String) {
    request.uri.path = '/message'
    request.contentType = 'application/json'
    request.body = { text 'HttpBuilder is alive!' }
    response.success { FromServer from, Object body -&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, we will expect the text of the new message back from the server, but this time we are calling the <code>post()</code> method with a JSON content type. Note that our body content is using the Groovy
<code>JsonBuilder</code> closure format, it could have just as easily been a <code>Map</code> of the data to be encoded. Similar to the response decoding, the request body is automatically encoded based on the content
type.</p>
</div>
<div class="paragraph">
<p>If you run the code now, you will get:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>HttpBuilder is alive!</pre>
</div>
</div>
<div class="paragraph">
<p>You could also call the <code>get()</code> method again and verify that it is the current message.</p>
</div>
<div class="paragraph">
<p>As a final example with our service, let&#8217;s call the <code>DELETE /message</code> endpoint to reset the message back to it&#8217;s "empty" state. A <code>DELETE</code> request is just as simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String deleted = http.delete(String){
    request.uri.path = '/message'
    response.success { FromServer from, Object body -&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be the new message after deletion:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>n/a</pre>
</div>
</div>
<div class="paragraph">
<p>which is the "empty" state.</p>
</div>
<div class="paragraph">
<p>One thing we notice now that we have written all of the verb calls is that there are a lot of similarities between them. They all call the same <code>path</code> and they all handle the successful response
content in the same manner. I am not a fan of duplication, so we can move the common configuration up into the main <code>configure</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">HttpBuilder http = HttpBuilder.configure {
    request.uri = 'http://localhost:4567/message'
    response.success { FromServer from, Object body -&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and our verb methods, now contain only what they need to do their work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String message = http.get(String) {}

String updated = http.post(String) {
    request.contentType = 'application/json'
    request.body = { text 'HttpBuilder is alive!' }
}

String deleted = http.delete(String) {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice and clean. Now wait, I know, I promised something similar in plain old Java, well Java 8 anyway&#8230;&#8203; ok, you can do the same operations in Java with a fairly similar expressiveness:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">HttpBuilder http = HttpBuilder.configure(config -&gt; {
    config.getRequest().setUri("http://localhost:4567/message");
    config.getResponse().success(new BiFunction&lt;FromServer, Object, String&gt;() {
        @Override public String apply(FromServer fromServer, Object body) {
            return ((Map&lt;String, Object&gt;) body).get("text").toString();
        }
    });
});

String message = http.get(String.class, config -&gt; {});

System.out.println("Starting content: " + message);

// update the content

String updated = http.post(String.class, config -&gt; {
    config.getRequest().setContentType("application/json");
    config.getRequest().setBody(singletonMap("text", "HttpBuilder works from Java too!"));
});

System.out.println("Updated content: " + updated);

// delete the content

String deleted = http.delete(String.class, config -&gt; {});

System.out.println("Post-delete content: " + deleted);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the Java 8 lambdas make the syntax about as simple as the Groovy DSL. When you run this version of the client you get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Starting content: n/a
Updated content: HttpBuilder works from Java too!
Post-delete content: n/a</pre>
</div>
</div>
<div class="paragraph">
<p>In Java or Groovy, the library makes HTTP interactions much easier to work with. Check out the <a href="https://github.com/dwclark/http-builder-ng">project</a> and feel free to submit bug reports and feature
requests, or even suggested details to be documented.</p>
</div></p>
  	
		<a href="blog/2016/nd4j-math.html"><h1>ND4J Matrix Math</h1></a>
		<p><em>12 August 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a></p>
		<p><div class="paragraph">
<p>In my last post (<a href="http://coffeaelectronica.com/blog/2016/commons-math-matrix.html">Commons Math - RealMatrix</a>), I discussed the matrix operations support provided by the Apache Commons Math API. In doing my research I also stumbled on a library that is much closer in functionality to the Python NumPy library (commonly used in Machine Learning examples). The <a href="http://nd4j.org/">ND4J</a> library is a scientific computing library for the JVM, meant to be used in production environments, which means routines are designed to run fast with minimum RAM requirements.</p>
</div>
<div class="paragraph">
<p>The main draw I had at this point was that their support for array-style element-by-element operations was much deeper than the matrix operations provided by the Apache Commons Math API and much closer to what I was seeing in the Python code I was working with, which makes conversion simpler.</p>
</div>
<div class="paragraph">
<p>With NumPy in Python you can multiply two arrays such that the result is the multiplication of each value of the array by the corresponding value in the second array. This is not so simple with matrices (as shown in my last post). With ND4J, it becomes much simpler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def arrA = Nd4j.create([1.0, 2.0, 3.0] as double[])
def arrB = Nd4j.create([2.0, 4.0, 6.0] as double[])
def arrC = arrA.mul(arrB)
println "$arrA + $arrB = $arrC"</code></pre>
</div>
</div>
<div class="paragraph">
<p>will result in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[1.00, 2.00, 3.00] * [2.00, 4.00, 6.00] = [ 2.00,  8.00, 18.00]</pre>
</div>
</div>
<div class="paragraph">
<p>which is as we would expect from the Python case. ND4J also has the ability to do two-dimensional (matrix-style) arrays:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def matA = Nd4j.create([
    [1.0, 2.0, 3.0] as double[],
    [4.0, 5.0, 6.0] as double[]
] as double[][])
println "Matrix: $matA\n"</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will produce:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Matrix: [[1.00, 2.00, 3.00],
 [4.00, 5.00, 6.00]]</pre>
</div>
</div>
<div class="paragraph">
<p>All of the other mathematical operations I mentioned in the previous post are available and with data structures that feel a lot more rich and refined for general use. This is barely scratching the surface of the available functionality. Also, the underlying code is native-based and has support for running on CUDA cores for higher performance. This library is definitely one to keep in mind for cases when you have a lot of array and matrix-based operations.</p>
</div></p>
  	
		<a href="blog/2016/commons-math-matrix.html"><h1>Apache Commons Math - RealMatrix</h1></a>
		<p><em>11 August 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a></p>
		<p><div class="paragraph">
<p>I have been reading <a href="https://www.manning.com/books/machine-learning-in-action">Machine Learning in Action</a>, which is a great book; however, all of the examples are in Python. While Python seems like a decent language, it is not one of my primary languages. With that in mind, I have been converting the Python examples into Groovy so that a few months from now when I come back and try to understand what I learned, I will be able to decipher the code.</p>
</div>
<div class="paragraph">
<p>What I have found is that, at least in the examples for this book, there are numerous Matrix-based operations. My Linear Algebra was a long time ago, but I think I remember some of the basics; however, it&#8217;s nice to have a Java-based implementation in the <a href="http://commons.apache.org/proper/commons-math/">Apache Commons Math</a> <code>RealMatrix</code> implementations (there are others but this is what I have been focussing on). It took me a little time to get back up to speed, especially since the Python examples will have something like:</p>
</div>
<div class="paragraph">
<p>someMatrix = someMatrix * anotherMatrix + thirdMatrix * number</p>
</div>
<div class="paragraph">
<p>where the resulting matrix is the product of two matrices added to the product of a matrix and a scalar number. Conceptually, this boils down to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Multiply <code>someMatrix</code> by <code>anotherMatrix</code></p>
</li>
<li>
<p>Multiply every element of <code>thirdMatrix</code> by the scalar <code>number</code> value</p>
</li>
<li>
<p>Add every element of the matrix in step 1 with the element at the same position of the matrix from step 2.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Not hard to grasp, and not even all that hard to code; however, this is something I&#8217;d rather push off to someone else&#8217;s implementation instead of writing it myself. That is where the Commons Math library comes into play. The <code>RealMatrix</code> interface defines matrix support for <code>double</code> values - there is also a more flexible <code>FieldMatrix&lt;T&gt;</code> interface, but <code>double</code> values work well as an example. Let&#8217;s start by setting up a simple Groovy script for playing with matrices. Create a file named <code>matrix-math.groovy</code> and add the following to it:</p>
</div>
<div class="listingblock">
<div class="title">matrix-math.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Grapes(
   @Grab('org.apache.commons:commons-math3:3.6.1')
)

import org.apache.commons.math3.linear.*

def mat = new Array2DRowRealMatrix(4,3)

println mat</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script will download the artifacts for the Apache Commons Math library and create a simple <code>RealMatrix</code> with 4 rows and 3 columns. It will then be printed to the console. When you run it, you should see</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Array2DRowRealMatrix{{0.0,0.0,0.0},{0.0,0.0,0.0},{0.0,0.0,0.0},{0.0,0.0,0.0}}</pre>
</div>
</div>
<div class="paragraph">
<p>which represents our empty 4x3 matrix. While this is not a bad representation, it would be nicer if we could get a better representation of the rows and columns of data for our poor human eyes. The library provides a <code>RealMatrixFormat</code> for this. Add the following to the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def formatter = new RealMatrixFormat('{', '}', '{', '}', ',\n ', ',\t')

println formatter.format(mat)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>println</code> line replaces the existing one. Now we get a better, more human-readable representation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{0,    0,      0},
 {0,    0,      0},
 {0,    0,      0},
 {0,    0,      0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Interesting so far, but we would really like some data. With the existing matrix, you can add data in rows or columns by index, similar to an array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">mat.setRow(0, [1.0, 2.0, 3.0] as double[])
mat.setColumn(1, [9.0, 8.0, 7.0, 6.0] as double[])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you run the code, notice that you get the first row and the second column populated with the provided data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    9,      3},
 {0,    8,      0},
 {0,    7,      0},
 {0,    6,      0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Also notice that the column data overwrote the row data we set for the second column (index 1). In our row data it was <code>2.0</code>, but the <code>9.0</code> value from the column was applied after and is the final value. The other main method of creating a matrix is by providing the data directly in the constructor. Say we want to create a matrix with the same dimensions, but with a sequential collection of values, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1  2  3
4  5  6
7  8  9
10 11 12</pre>
</div>
</div>
<div class="paragraph">
<p>You can do the following in the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def seqMat = new Array2DRowRealMatrix([
    [1.0, 2.0, 3.0] as double[],
    [4.0, 5.0, 6.0] as double[],
    [7.0, 8.0, 9.0] as double[],
    [10.0, 11.0, 12.0] as double[]
] as double[][])

println formatter.format(seqMat)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code creates a matrix with an array of arrays, where the inner arrays are the rows of data. When printed out, you get the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    2,      3},
 {4,    5,      6},
 {7,    8,      9},
 {10,   11,     12}}</pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s do some operations on our matrices. You can do common math operations on two matrices. Adding two matrices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def sum = mat.add(seqMat)
println formatter.format(sum)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives you the element-by-element sum of the values and yields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{2,    11,     6},
 {4,    13,     6},
 {7,    15,     9},
 {10,   17,     12}}</pre>
</div>
</div>
<div class="paragraph">
<p>Subtracting one matrix from another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def diff = seqMat.subtract(mat)
println formatter.format(diff)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{0,    -7,     0},
 {4,    -3,     6},
 {7,    1,      9},
 {10,   5,      12}}</pre>
</div>
</div>
<div class="paragraph">
<p>Multiplication of matrices is not what you might intuitively think it is, unless you are up on your Linear Algebra. Since there are whole wiki pages devoted to <a href="https://en.wikipedia.org/wiki/Matrix_multiplication">Matrix Multiplication</a>, I won&#8217;t go into it here beyond stating that it can be done when you have square matrices (ours are not). Not being a tutorial on Linear Algebra, I am going to leave it at that. You can also multiply a matrix by a scalar number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def prod = mat.scalarMultiply(2)
println formatter.format(prod)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which multiplies every element by the given value and results in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{2,    18,     6},
 {0,    16,     0},
 {0,    14,     0},
 {0,    12,     0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, there is a <code>scalarAdd(double)</code> method.</p>
</div>
<div class="paragraph">
<p>Other useful operations may be performed on matrices. You can "transpose" the matrix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def trans = seqMat.transpose()
println formatter.format(trans)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rotates the values of the matrix to turn rows into columns, as in our example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    2,      3},
 {4,    5,      6},
 {7,    8,      9},
 {10,   11,     12}}</pre>
</div>
</div>
<div class="paragraph">
<p>becomes</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    4,      7,      10},
 {2,    5,      8,      11},
 {3,    6,      9,      12}}</pre>
</div>
</div>
<div class="paragraph">
<p>There are a handful of other built-in operations available to matrices that are probably useful if you know what you are doing, but at this point, I do not. Another useful construct is the set of "walker" methods that allow you to walk through the elements of the matrix in various ways, allowing you to modify the elements or simply read them. Let&#8217;s take our initial matrix as an example and multiply every element by <code>2.0</code> both in place and in an external collection.</p>
</div>
<div class="paragraph">
<p>For the in-place modification we need a <code>RealMatrixChangingVisitor</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class MultiplicationVisitor extends DefaultRealMatrixChangingVisitor {

    double factor

    double visit(int row, int column, double value){
        value * factor
    }
}

mat.walkInOptimizedOrder(new MultiplicationVisitor(factor:2.0))
println formatter.format(mat)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This visitor simply multiplies each value by the provided <code>factor</code> and returns it, which will update the value in the matrix. The resulting matrix has the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{2,    18,     6},
 {0,    16,     0},
 {0,    14,     0},
 {0,    12,     0}}</pre>
</div>
</div>
<div class="paragraph">
<p>You can also walk a matrix without the ability to change the internal values. This requires a <code>RealMatrixPreservingVisitor</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class CollectingVisitor extends DefaultRealMatrixPreservingVisitor {

    List values = []

    void visit(int row, int column, double value){
        values &lt;&lt; value
    }
}

def collectingVisitor = new CollectingVisitor()
mat.walkInOptimizedOrder(collectingVisitor)
println collectingVisitor.values</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the values are collected into a list and no matrix value is modified. You get the following result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[2.0, 18.0, 6.0, 0.0, 16.0, 0.0, 0.0, 14.0, 0.0, 0.0, 12.0, 0.0]</pre>
</div>
</div>
<div class="paragraph">
<p>This contains a list of all the values from our original matrix after the previous visitor has modified it.</p>
</div>
<div class="paragraph">
<p>Matrix operations can seem quite complicated; however, they are not bad with a helpful library. So far the Commons Math API seems pretty useful for these more advanced math concepts.</p>
</div>
<div class="paragraph">
<p>The entire script for this tutorial is provided below for completeness:</p>
</div>
<div class="listingblock">
<div class="title">matrix-math.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Grapes(
   @Grab('org.apache.commons:commons-math3:3.6.1')
)

import org.apache.commons.math3.linear.*

def formatter = new RealMatrixFormat('{', '}', '{', '}', ',\n ', ',\t')

def mat = new Array2DRowRealMatrix(4,3)
mat.setRow(0, [1.0, 2.0, 3.0] as double[])
mat.setColumn(1, [9.0, 8.0, 7.0, 6.0] as double[])

println formatter.format(mat)
println()

def seqMat = new Array2DRowRealMatrix([
    [1.0, 2.0, 3.0] as double[],
    [4.0, 5.0, 6.0] as double[],
    [7.0, 8.0, 9.0] as double[],
    [10.0, 11.0, 12.0] as double[]
] as double[][])

println formatter.format(seqMat)
println()

def sum = mat.add(seqMat)
println formatter.format(sum)
println()

def diff = seqMat.subtract(mat)
println formatter.format(diff)
println()

def prod = mat.scalarMultiply(2)
println formatter.format(prod)
println()

def trans = seqMat.transpose()
println formatter.format(trans)
println()

class MultiplicationVisitor extends DefaultRealMatrixChangingVisitor {

    double factor

    double visit(int row, int column, double value){
        value * factor
    }
}

mat.walkInOptimizedOrder(new MultiplicationVisitor(factor:2.0))
println formatter.format(mat)
println()

class CollectingVisitor extends DefaultRealMatrixPreservingVisitor {

    List values = []

    void visit(int row, int column, double value){
        values &lt;&lt; value
    }
}

def collectingVisitor = new CollectingVisitor()
mat.walkInOptimizedOrder(collectingVisitor)
println collectingVisitor.values
println()</code></pre>
</div>
</div></p>
  	
		<a href="blog/2016/dependencies-behind-the-wall.html"><h1>Gradle Dependencies Behind the Wall</h1></a>
		<p><em>10 July 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/gradle.html'>gradle</a></p>
		<p><div class="paragraph">
<p>Some companies like to take full control of their build environments and disallow builds that pull artifacts from external sources so that only approved internal artifact repositories are used containing only approved artifacts. While the validity of this is debatable, it exists and in my experience tends to add roadblocks to development, especially when working with new frameworks and libraries.</p>
</div>
<div class="paragraph">
<p>Consider the scenario where you are working on a poject that uses a newer version of the Spring Framework than has been previously used in the company. Now you need to get the new Spring artifacts into your approved repository, which requires an issue ticket of some sort and at least one or two architects to approve it. I am sure I am not shocking you when I say that Spring has numerous dependencies if you are doing anything interesting with it and they are all transient. How do you get a list of the dependencies that you need to have added without an arduous catalogging of artifacts and their dependencies or numerous iterations of the list-ticket-approval work flow( which is not generally speedy)? You write a Gradle plugin to do it for you.</p>
</div>
<div class="paragraph">
<p>I have added a <code>checkAvailability</code> task to my <a href="http://stehno.com/dependency-checker/">Dependency Checker Plugin</a>. This task allows you to do your development work using the standard <code>jcenter</code> or <code>mavenCentral</code> artifact repositories so that you can get things working, but when you are ready to lock down your dependencies you can run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew checkAvailability -PrepoUrls=http://artifacts.mycompany.com/repository</pre>
</div>
</div>
<div class="paragraph">
<p>Which will list out the dependencies missing from the specified repository without affecting your build. The reported console entries will look something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Availability check for (commons-lang:commons-lang:2.1.2): FAILED</pre>
</div>
</div>
<div class="paragraph">
<p>You can provide additional configuration to futher configure the task:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>checkAvailability {
    repoUrls = ['http://artifacts.mycompany.com/repository']
    configurations = ['runtime']
    ignored = ['com.something:thingifier:1.2.3']
    failOnMissing = true
}</pre>
</div>
</div>
<div class="paragraph">
<p>This configuration will specify the default <code>repoUrls</code> to be used, which may still be overridden on the command line. The <code>configurations</code> property allows you to limit the dependency configurations searched (to only <code>runtime</code> in this case). The <code>ignored</code> property allows specified artifacts to be ignored even if they are missing. And finally, the <code>failOnMissing</code> property will cause the build to fail when set to <code>true</code> after reporting all the missing dependencies - the default is <code>false</code> so that it will only list the status of the dependencies and allow the build to continue.</p>
</div>
<div class="paragraph">
<p>Now, armed with a full list of the dependencies missing from your internal artifact repository, you can create your issue ticket and get the approvals once and get back to actual work faster.</p>
</div></p>
  	
		<a href="blog/2016/custom-shell-banner.html"><h1>Custom Spring Boot Shell Banner</h1></a>
		<p><em>25 March 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/spring.html'>spring</a></p>
		<p><div class="paragraph">
<p>I did a <a href="http://dfw2gug.org/blog/2016/march-2016.html">Groovy User Group talk</a> recently related to my <a href="http://coffeaelectronica.com/blog/2015/spring-shell.html">Spring Boot Remote Shell</a> blog post and while putting the talk together I stumbled across a bug in the integration between Spring Boot and the Crash shell (see <a href="https:///github.com/spring-projects/spring-boot/issues/3988">Spring-Boot-3988</a>). The custom banner you can add to your Spring Boot application (as /resources/banner.txt) is not applied by default to your crash shell, so you get the boring Spring logo every time you startup the shell. I had worked with the Crash shell previously and I remember that the banner was customizable so I did a little digging and figured out how to code a work-around - I also added this information to the bug ticket; I considered contributing a pull request, but I am not sure how this would be coded into the default application framework.</p>
</div>
<div class="paragraph">
<p>The work-around is pretty simple and straight-forward if you have worked with the crash shell before. You use their method of customization and then have it pull in your Spring Boot custom banner. In your <code>/src/main/resources/commands</code> directory you add a <code>login.groovy</code> file, which Crash will load with every shell connection. The file allows the customization of the banner and the prompt. We can then load our spring banner from the classpath. The basic code is as follows:</p>
</div>
<div class="listingblock">
<div class="title">login.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">welcome = { -&gt;
    def hostName;
    try {
        hostName = java.net.InetAddress.getLocalHost().getHostName();
    } catch (java.net.UnknownHostException ignore) {
        hostName = 'localhost';
    }

    String banner = YourApplication.getResourceAsStream('/banner.txt').text

    return """
${banner}
Logged into $hostName @ ${new Date()}
"""
}

prompt = { -&gt;
    return "% ";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a silly little thing to worry about, but sometimes it&#8217;s the little things that make an application feel more like your own.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I have created a <a href="https://github.com/spring-projects/spring-boot/pull/5453">pull request</a> in the spring-boot project to address this issue&#8230;&#8203; we&#8217;ll see what happens.</p>
</div>
</blockquote>
</div></p>
  	
		<a href="blog/2016/groovy-di.html"><h1>Groovy Dependency Injection</h1></a>
		<p><em>19 March 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a></p>
		<p><div class="paragraph">
<p>Dependency Injection frameworks were a dime a dozen for a while - everybody had their own and probably a spare just in case. For the most part the field has settled down to a few big players, the <a href="http://springframework.org">Spring Framework</a> and <a href="https://github.com/google/guice">Google Guice</a> are the only two that come to mind. While both of these have their pluses and minuses, they both have a certain level of overhead in libraries and understanding. Sometimes you want to throw something together quickly or you are in a scenario where you can&#8217;t use one of these off the shelf libraries. I had to do this recently and while I still wanted to do something spring/guice-like, I could not use either of them, but I did have Groovy available.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I want to preface the further discussion here to say that I am not suggesting you stop using Spring or Guice or whatever you are using now in favor of rolling your own Groovy DI - this is purely a sharing of information about how you can if you ever need to.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s use as an example a batch application used to process some game scores and report on the min/max/average values. We will use a database (H2) just to show a little more configuration depth and I will use the <code>TextFileReader</code> class from my <a href="http://stehno.com/vanilla">Vanilla</a> project to keep things simple and focussed on DI rather than logic.</p>
</div>
<div class="paragraph">
<p>First, we need the heart of our DI framework, the configuration class. Let&#8217;s call it <code>Config</code>; we will also need a means of loading external configuration properties and this is where our first Groovy helper comes in, the <code>ConfigSlurper</code>. The <code>ConfigSlurper</code> does what it sounds like, it slurps up a configuration file with a Groovy-like syntax and converts it to a <code>ConfigObject</code>. To start with, our <code>Config</code> class looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class Config {
    private final ConfigObject config

    Config(final URL configLocation) {
        config = new ConfigSlurper().parse(configLocation)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The backing configuration file we will use, looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>inputFile = 'classpath:/scores.csv'

datasource {
    url = 'jdbc:h2:mem:test'
    user = 'sa'
    pass = ''
}</pre>
</div>
</div>
<div class="paragraph">
<p>This will live in a file named <code>application.cfg</code> and as can be seen, it will store our externalized config properties.</p>
</div>
<div class="paragraph">
<p>Next, let&#8217;s configure our <code>DataSource</code>. Both Spring and Guice have a similar "bean definition" style, and what I am sure is based on those influences, I came up with something similar here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Memoized(protectedCacheSize = 1, maxCacheSize = 1)
DataSource dataSource() {
    JdbcConnectionPool.create(
        config.datasource.url,
        config.datasource.user,
        config.datasource.pass
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that I used the <code>@Memoized</code> Groovy transformation annotation. This ensures that once the "bean" is created, the same instance is reused, and since I will only ever have one, I can limit the cache size and make sure it sicks around. As an interesting side-item, I created a collected annotation version of the memoized functionality and named it <code>@OneInstance</code> since <code>@Singleton</code> was alread taken.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Memoized(protectedCacheSize = 1, maxCacheSize = 1)
@AnnotationCollector
@interface OneInstance {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It just keeps things a little cleaner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@OneInstance DataSource dataSource() {
    JdbcConnectionPool.create(
        config.datasource.url,
        config.datasource.user,
        config.datasource.pass
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, notice how the <code>ConfigObject</code> is used to retrieve the configuration property values, very clean and concise.</p>
</div>
<div class="paragraph">
<p>Next, we need to an input file to read and a <code>TextFileReader</code> to read it so we will configure those as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@OneInstance Path inputFilePath() {
    if (config.inputFile.startsWith('classpath:')) {
        return Paths.get(Config.getResource(config.inputFile - 'classpath:').toURI())
    } else {
        return new File(config.inputFile).toPath()
    }
}

@OneInstance TextFileReader fileReader() {
    new TextFileReader(
        filePath: inputFilePath(),
        firstLine: 2,
        lineParser: new CommaSeparatedLineParser(
            (0): { v -&gt; v as long },
            (2): { v -&gt; v as int }
        )
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I added a little configuration sugar so that you can define the input file as a classpath file or an external file. The <code>TextFileReader</code> is setup to convert the data csv file as three columns of data, an id (long), a username (string) and a score (int). The data file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># id,username,score
100,bhoser,4523
200,ripplehauer,235
300,jegenflur,576
400,bobknows,997</pre>
</div>
</div>
<div class="paragraph">
<p>The last thing we need in the configuration is our service which will do that data management and the stat calculations, we&#8217;ll call it the <code>StatsService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@TypeChecked
class StatsService {

    private Sql sql

    StatsService(DataSource dataSource) {
        sql = new Sql(dataSource)
    }

    StatsService init() {
        sql.execute('create table scores (id bigint PRIMARY KEY, username VARCHAR(20) NOT NULL, score int NOT NULL )')
        this
    }

    void input(long id, String username, int score) {
        sql.executeUpdate(
            'insert into scores (id,username,score) values (?,?,?)',
            id,
            username,
            score
        )
    }

    void report() {
        def row = sql.firstRow(
            '''
            select
                count(*) as score_count,
                avg(score) as average_score,
                min(score) as min_score,
                max(score) as max_score
            from scores
            '''
        )

        println "Count  : ${row.score_count}"
        println "Min    : ${row.min_score}"
        println "Max    : ${row.max_score}"
        println "Average: ${row.average_score}"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m just going to dump it out there since it&#8217;s mostly SQL logic to load the data into the table and then report the stats out to the standard output. We will wire this in like the others in <code>Config</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@OneInstance StatsService statsService() {
    new StatsService(dataSource()).init()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that, our configuration is done. Now we need to use it in an application, which we&#8217;ll call <code>Application</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class Application {

    static void main(args){
        Config config = Config.fromClasspath('/application.cfg')

        StatsService stats = config.statsService()
        TextFileReader reader = config.fileReader()

        reader.eachLine { Object[] line-&gt;
            stats.input(line[0], line[1], line[2])
        }

        stats.report()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We instantiate a <code>Config</code> object, call the bean accessor methods and use the beans to do the desired work. I added the <code>fromClasspath(String)</code> helper method to simplify loading config from the classpath.</p>
</div>
<div class="paragraph">
<p>Like I said, this is no fulltime replacement for a real DI framework; however, when I was in a pinch, this came in pretty handy and worked really well. Also, it was easy to extend the <code>Config</code> class in the testing source so that certain parts of the configuration could be overridden and mocked as needed during testing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The demo code for this post is on <a href="https://github.com/cjstehno/groovy-di">GitHub: cjstehno/groovy-di</a>.
</td>
</tr>
</table>
</div></p>
  	
		<a href="blog/2016/dependency-duplication-check.html"><h1>Dependency Duplication Checking</h1></a>
		<p><em>12 March 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/gradle.html'>gradle</a></p>
		<p><div class="paragraph">
<p>Sometimes it takes a critical mass threshold of running into the same issue repeatedly to really do something about it. How often, when working with a dependency manager like <a href="http://gradle.org">Gradle</a> or <a href="http://maven.org">Maven</a>, have you run into some runtime issue only to find that it was caused by a build dependency that you had two (or more) different versions of at runtime? More often than you would like, I am sure. It can be a real surprise when you actually go digging into your aggregated dependency list only to find out you have more than one duplicate dependency just waiting to become a problem.</p>
</div>
<div class="paragraph">
<p>What do I mean by duplicate dependency? Basically, it&#8217;s just what it sounds like. You have two dependencies with different versions. Something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.codehaus.groovy:groovy-all:2.4.4
org.codehaus.groovy:groovy-all:2.4.5</pre>
</div>
</div>
<div class="paragraph">
<p>Most likely, your project defines one of them and some other dependency brought the other along for the ride. It is usually pretty easy to resolve these extra dependencies; in <a href="http://gradle.org">Gradle</a> you can run the <code>dependency</code> task to see which dependency is bringing the extra library in:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew dependencies &gt; deps.txt</pre>
</div>
</div>
<div class="paragraph">
<p>I like to dump the output to a text file for easier viewing. Then, once you find the culprit, you can exclude the transitive dependency:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>compile( 'com.somebody:coollib:2.3.5' ){
    exclude group:'org.codehaus.groovy', module:'groovy-all'
}</pre>
</div>
</div>
<div class="paragraph">
<p>Then you can run the <code>dependency</code> task again to ensure that you got of it. Generally, this is a safe procedure; however, sometimes you get into a situation where different libraries depend on different versions that have significant code differences - that&#8217;s when the fun begins and it usually ends in having to up or down-grade various dependencies until you get a set that works and is clean.</p>
</div>
<div class="paragraph">
<p>What is the problem with having multiple versions of the same library in your project? Sometimes nothing, sometimes everything. The classloader will load whichever one is defined first in the classpath. If your project needs a class <code>Foo</code> with a method <code>bar()</code> and the version you expect to use has it but the previous version does not, bad things can happen at runtime.</p>
</div>
<div class="paragraph">
<p>Ok, now we know generally how to solve the multiple dependency problem, we&#8217;re done right? Sure, for a month or so. Unless your project is done and no longer touched, new dependencies and duplicates will creep in over time. I did this duplicataion purge on a project at work a few months ago and just last week I took a peek at the aggregated dependency list and was truely not so shocked to see three duplicated libraries. One of which was probably the cause of some major performance issues we were facing. That&#8217;s what inspired me to solve the problem at least to the point of letting you know when duplications creep in.</p>
</div>
<div class="paragraph">
<p>I created the <a href="https://github.com/cjstehno/dependency-checker">dependency-checker</a> Gradle plugin. It is available in the <a href="https://plugins.gradle.org/plugin/com.stehno.gradle.dependency-checker">Gradle Plugin Repository</a>. At this point, it has one added task, <code>checkDependencies</code> which, as the name suggests, searches through all the dependencies of the project to see if you have any duplicates within a configuration. If it finds duplicates, it will write them to the output log and fail the build.</p>
</div>
<div class="paragraph">
<p>Currently, you need to run the task for the checking to occur. I would like to get it to run with the default <code>check</code> task, or <code>build</code> task, but the code I had for that was not working - later version I guess. You can add that functionality into your own build by adding one or two lines to your <code>build.gradle</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>tasks.check.dependsOn checkDependencies
tasks.build.dependsOn checkDependencies</pre>
</div>
</div>
<div class="paragraph">
<p>These will make the appropriate tasks depend on the dependency check so that it will be run with every <code>build</code> - that way you will know right away that you have a potential problem.</p>
</div>
<div class="paragraph">
<p>I did take a tour around Google and the plugin repository just to make sure there was nothing else providing this functionality - so hopefully I am not duplicating anyone else&#8217;s work.</p>
</div></p>
  	
		<a href="blog/2016/text-file-read-write.html"><h1>Vanilla TextFileReader/Writer</h1></a>
		<p><em>06 March 2016</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/vanilla.html'>vanilla</a></p>
		<p><div class="paragraph">
<p>Something I have found myself doing quite often over my whole career as a developer is reading and writing simple text file data. Whether it is a quick data dump or a data set to be loaded from a 3rd party, it is something I end up doing a lot and usually it is something coded mostly from scratch since, surprisingly enough, there are very few tools available for working with formatted text files. Sure, there are a few for CSV, but quite often I get a reqest to read or write a format that is kind of similar to CSV, but just enough different that it breaks a standard CSV parser for whatever reason. Recently, I decided to add some utility components to my <a href="http://stehno.com/vanilla">Vanilla project</a> with the aim of making these readers and writers simpler to build.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start off with the <code>com.stehno.vanilla.text.TextFileWriter</code> and say we have a data source of <code>Person</code> objects in our application that the business wants dumped out to a text file (so they can import it into some business tools that only ever seem capable of importing simple text files). In the application, the data structure looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class Person {
    String firstName
    String middleName
    String lastName
    int age
    float height
    float weight
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>with the <code>TextFileWriter</code> you need to define a <code>LineFormatter</code> which will be used to format the generated lines of text, one per object written. The <code>LineFormatter</code> defines two methods, <code>String formatComment(String)</code> for formatting a comment line, and <code>String formatLine(Object)</code> for formatting a data line. A simple implementation is provided, the <code>CommaSeparatedLineFormatter</code> will generate comment lines prefixed with a <code>#</code> and will expect a <code>Collection</code> object to be formatted and will format it as a CSV line.</p>
</div>
<div class="paragraph">
<p>The available implementation will not work for our case, so we will need to define our own <code>LineFormatter</code>. We want the formatted data lines to be of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-text" data-lang="text"># Last-Name,First-Name-Middle-Initial,Attrs
Smith,John Q,{age:42, height:5.9, weight:230.5}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yes, that&#8217;s a bit of a convoluted format, but I have had to generate worse. Our <code>LineFormatter</code> ends up being something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class PersonLineFormatter implements LineFormatter {

    @Override
    String formatComment(String text) {
        "# $text" <b class="conum">(1)</b>
    }

    @Override
    String formatLine(Object object) {
        Person person = object as Person
        "${person.lastName},${person.firstName} ${person.middleName[0]},{age:${person.age}, height:${person.height}, weight:${person.weight}}" <b class="conum">(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We specify the comment as being prefixed by a <code>#</code> symbol.</p>
</li>
<li>
<p>Write out the <code>Person</code> object as the formatted <code>String</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We see that implementing the <code>LineFormatter</code> keeps all the application specific logic isolated from the common operation of actually writing the file. Now we can use our formatter as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">TextFileWriter writer = new TextFileWriter(
    lineFormatter: new PersonLineFormatter(),
    filePath: new File(outputDir, 'people.txt')
)

writer.writeComment('Last-Name,First-Name-Middle-Initial,Attrs')

Collection&lt;Person&gt; people = peopleDao.listPeople()

people.each { Person p-&gt;
    writer.write(p)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will write out the text file in the desired format with very little new coding required.</p>
</div>
<div class="paragraph">
<p>Generally, writing out text representations of application data is not really all that challenging, since you have access to the data you need and some control over the formatting of the objects to be represented. The real challenge is usually going in the other direction, when you are reading in a data file from some external source, this is where the <code>com.stehno.vanilla.text.TextFileReader</code> becomes useful.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say you receive a request to import the data file we described above, maybe it was generated by the same business tools I mentioned earlier. We have something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-text" data-lang="text"># Last-Name,First-Name-Middle-Initial,Attrs
Smith,John Q,{age:42, height:5.9, weight:230.5}
Jones,Robert M,{age:38, height:5.6, weight:240.0}
Mendez,Jose R,{age:25, height:6.1, weight:232.4}
Smalls,Jessica X,{age:30, height:5.5, weight:175.2}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>TextFileReader</code> requires a <code>LineParser</code> to parse the input file lines into objects; it defines three methods, <code>boolean parseable(String)</code> which is used to determine whether or not the line should be parsed, <code>Object[] parseLine(String)</code> which is used to parse the line of text, and <code>Object parseItem(Object, int)</code> which is used to parse an individual element of the comma-separated line. There is a default implementation provided, the <code>CommaSeparatedLineParser</code> will parse simple comma-separated lines of text into arrays of Objects based on configured item converters; however, this will not work in the case of our file since there are commas in the data items themselves (the JSON-like format of the last element). So we need to implement one. Our <code>LineParser</code> will look something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class PersonLineParser implements LineParser {

    boolean parsable(String line){
        line &amp;&amp; !line.startsWith(HASH) <b class="conum">(1)</b>
    }

    Object[] parseLine(String line){ <b class="conum">(2)</b>
        int idx = 0
        def elements = line.split(',').collect { parseItem(it, idx++) }

        [
            new Person(
                firstName:elements[1][0],
                middleName:elements[1][1],
                lastName:elements[0],
                age:elements[2],
                height:elements[3],
                weight:elements[4],
            )
        ] as Object[]
    }

    // Smith,John Q,{age:42, height:5.9, weight:230.5}
    // 0    ,1     ,2      ,3          ,4
    Object parseItem(Object item, int index){ <b class="conum">(3)</b>
        switch(index){
            case 0:
                return item as String
            case 1:
                return item.split(' ')
            case 2:
                return item.split(':')[1] as int
            case 3:
                return item.split(':')[1] as float
            case 4:
                return item.split(':')[1][0..-2] as float
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We want to ignore blank lines or lines that start with a <code>#</code> symbol.</p>
</li>
<li>
<p>We extract the line items and build the <code>Person</code> object</p>
</li>
<li>
<p>We convert the line items to our desired types</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It&#8217;s not pretty, but it does the job and keeps all the line parsing logic out of the main file loading functionality. Our code to read in the file would look somethign like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">setup:
TextFileReader reader = new TextFileReader(
    filePath: new File(inputDir, 'people.txt'),
    lineParser: new PersonLineParser(),
    firstLine: 2 <b class="conum">(1)</b>
)

when:
def people = []

reader.eachLine { Object[] data -&gt;
    lines &lt;&lt; data[0]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We skip the first line, since it will always be the header</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The provided implementations for both the <code>LineFormatter</code> and <code>LineParser</code> will not account for every scenario, but hopefully they will hit some of them and provide a guideline for implementing your own. If nothing else, these components help to streamline the readign and writing of formatted text data so that you can get it done and focus on other more challenging development tasks.</p>
</div></p>
  	
		<a href="blog/2015/spring-shell.html"><h1>Spring Boot Remote Shell</h1></a>
		<p><em>07 November 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/spring.html'>spring</a></p>
		<p><div class="paragraph">
<p><a href="http://projects.spring.io/spring-boot/">Spring Boot</a> comes with a ton of useful features that you can enable as needed, and in general the documentation is pretty good; however, sometimes it feels like they gloss over a feature that eventually realize is much more useful than it originally seemed. The remote shell support is one of those features.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start off with a simple Spring Boot project based on the example provided with the Boot documentation. Our <code>build.gradle</code>
file is:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath 'org.springframework.boot:spring-boot-gradle-plugin:1.2.7.RELEASE'
    }
}

version = "0.0.1"
group = "com.stehno"

apply plugin: 'groovy'
apply plugin: 'spring-boot'

sourceCompatibility = 8
targetCompatibility = 8

mainClassName = 'com.stehno.SampleController'

repositories {
    jcenter()
}

dependencies {
    compile "org.codehaus.groovy:groovy-all:2.4.5"

    compile 'org.springframework.boot:spring-boot-starter-web'
}

task wrapper(type: Wrapper) {
    gradleVersion = "2.8"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, our simple controller and starter class looks like:</p>
</div>
<div class="listingblock">
<div class="title">SampleController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Controller
@EnableAutoConfiguration
public class SampleController {

    @RequestMapping('/')
    @ResponseBody
    String home() {
        'Hello World!'
    }

    static void main(args) throws Exception {
        SpringApplication.run(SampleController, args)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew clean build bootRun</pre>
</div>
</div>
<div class="paragraph">
<p>and you get your run of the mill "Hello world" application. For our demonstration purposes, we need something a bit more
interesting. Let&#8217;s make the controller something like a "Message of the Day" server which will return a fixed configured
message. Remove the <code>hello</code> controller action and add in the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String message = 'Message for you, sir!'

@RequestMapping('/') @ResponseBody
String message() {
    message
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will return the static message "Message for you, sir!" for every request. Running the application now, will still
be pretty uninteresting, but wait, it gets better.</p>
</div>
<div class="paragraph">
<p>Now, we would like to have the ability to change the message as needed without rebuilding or even restarting the server.
There are handful of ways to do this; however, I&#8217;m going to discuss one of the seemingly less used options&#8230;&#8203; The
<a href="http://www.crashub.org/">CRaSH Shell</a> integration provided in Spring Boot
(<a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready-remote-shell">43. Production Ready Remote Shell</a>).</p>
</div>
<div class="paragraph">
<p>To add the remote shell support in Spring Boot, you add the following line to your <code>dependencies</code> block in your <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>compile 'org.springframework.boot:spring-boot-starter-remote-shell'</pre>
</div>
</div>
<div class="paragraph">
<p>Now, when you run the application, you will see an extra line in the server log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Using default password for shell access: 44b3556b-ff9f-4f82-9f1b-54a16da471d5</pre>
</div>
</div>
<div class="paragraph">
<p>Since no password was configured, Boot has provided a randomly generated one for you (obviously you would configure this in a real system). You now have an SSH connection available to your application. Using the ssh client of your choice you can login using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ssh -p 2000 user@localhost</pre>
</div>
</div>
<div class="paragraph">
<p>Which will ask you for the provided password. Once you have logged in you are connected to a secure shell running inside your application. You can run <code>help</code> at the prompt to get a list of available commands, which will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; help
Try one of these commands with the -h or --help switch:

NAME       DESCRIPTION
autoconfig Display auto configuration report from ApplicationContext
beans      Display beans in ApplicationContext
cron       manages the cron plugin
dashboard  a monitoring dashboard
egrep      search file(s) for lines that match a pattern
endpoint   Invoke actuator endpoints
env        display the term env
filter     a filter for a stream of map
java       various java language commands
jmx        Java Management Extensions
jul        java.util.logging commands
jvm        JVM informations
less       opposite of more
mail       interact with emails
man        format and display the on-line manual pages
metrics    Display metrics provided by Spring Boot
shell      shell related command
sleep      sleep for some time
sort       sort a map
system     vm system properties commands
thread     JVM thread commands
help       provides basic help
repl       list the repl or change the current repl</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, you get quite a bit of functionality right out of the box. I will leave the discussion of each of the provided commands to another post. What we are interested at this point is adding our own command to update the message displayed by our controller.</p>
</div>
<div class="paragraph">
<p>The really interesting part of the shell integration is the fact that you can extend it with your own commands.</p>
</div>
<div class="paragraph">
<p>Create a new directory <code>src/main/resources/commands</code> which is where your extended commands will live, and then add a simple starting point class for our command:</p>
</div>
<div class="listingblock">
<div class="title">message.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-goovy" data-lang="goovy">package commands

import org.crsh.cli.Usage
import org.crsh.cli.Command
import org.crsh.command.InvocationContext

@Usage('Interactions with the message of the day.')
class message {

    @Usage('View the current message of the day.')
    @Command
    def view(InvocationContext context) {
        return 'Hello'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Usage</code> annotations provide the help/usage documentation for the command, while the <code>@Command</code> annotation denotes that the <code>view</code> method is a command.</p>
</div>
<div class="paragraph">
<p>Now, when you run the application and list the shell commands, you will see our new command added to the list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>message    Interactions with the message of the day.</pre>
</div>
</div>
<div class="paragraph">
<p>If you run the command as <code>message view</code> you will get the static "Hello" message returned to you on the shell console.</p>
</div>
<div class="paragraph">
<p>Okay, we need the ability to view our current message of the day. The <code>InvocationContext</code> has <code>attributes</code> which are propulated by Spring, one of which is <code>spring.beanfactory</code> a reference to the Spring <code>BeanFactory</code> for your application. We can access the current message of the day by replacing the content of the <code>view</code> method with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">BeanFactory beans = context.attributes['spring.beanfactory']
return beans.getBean(SampleController).message</code></pre>
</div>
</div>
<div class="paragraph">
<p>where we find our controller bean and simply read the <code>message</code> property. Running the application and the shell command now, yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Message for you, sir!</pre>
</div>
</div>
<div class="paragraph">
<p>While that is pretty cool, we are actually here to modify the message, not just view it and this is just as easy. Add a new command named <code>update</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Usage('Update the current message of the day.')
@Command
def update(
    InvocationContext context,
    @Usage('The new message') @Argument String message
) {
    BeanFactory beans = context.attributes['spring.beanfactory']
    beans.getBean(SampleController).message = message
    return "Message updated to: $message"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, rebuild/restart the server and start up the shell. If you execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>message update "This is cool!"</pre>
</div>
</div>
<div class="paragraph">
<p>You will update the configured message, which you can verify using the <code>message view</code> command, or better yet, you can hit your server and see that the returned message has been updated&#8230;&#8203; no restart required. Indeed, this is cool.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can find a lot more information about writing your own commands in the CRaSH documentation for <a href="http://www.crashub.org/1.3/reference.html#developping_commands">Developing Commands</a>. There is a lot of functionality that I am not covering here.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, we are functionally complete. We can view and update the message of the day without requiring a restart of the server. But, there are still some added goodies provided by the shell, especially around shell UI support - yes, it&#8217;s text, but it can still be pretty and one of the ways CRaSH allows you to pretty things up is with colors and formatting via styles and the <code>UIBuilder</code> (which is sadly under-documented).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add another property to our controller to make things more interesting. Just add a <code>Date lastUpdated = new Date()</code> field. This will give us two properties to play with. Update the <code>view</code> action as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">SampleController controller = context.attributes['spring.beanfactory'].getBean(SampleController)

String message = controller.message
String date = controller.lastUpdated.format('MM/dd/yyyy HH:mm')

out.print new UIBuilder().table(separator: dashed, overflow: Overflow.HIDDEN, rightCellPadding: 1) {
    header(decoration: bold, foreground: black, background: white) {
        label('Date')
        label('Message')
    }

    row {
        label(date, foreground: green)
        label(message, foreground: yellow)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We still retrieve the instance of the controller as before; however, now our output rendering is a bit more complicated, though still pretty understandable. We are creating a new <code>UIBuilder</code> for a <code>table</code> and then applying the <code>header</code> and <code>row</code> contents to it. It&#8217;s actually a very powerful construct, I just had to dig around in the project source code to actually figure out how to make it work.</p>
</div>
<div class="paragraph">
<p>You will also need to update the <code>update</code> command to set the new date field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">SampleController controller = context.attributes['spring.beanfactory'].getBean(SampleController)
controller.message = message
controller.lastUpdated = new Date()

return "Message updated to: $message"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have that built and running you can run the <code>message view</code> command and get a much nicer multi-colored table output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; message view
Date             Message
-------------------------------------------------------------
11/05/2015 10:37 And now for something completely different.</pre>
</div>
</div>
<div class="paragraph">
<p>Which puts wraps up what we are trying to do here and even puts a bow on it. You can find more information on the remote shell configuration options in the Spring Boot documentation in <a href="http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#common-application-properties">Appendix A: Common Application Properties</a>. This is where you can configure the port, change the authentication settings, and even disable some of the default provided commands.</p>
</div>
<div class="paragraph">
<p>The remote shell support is one of the more interesting, but underused features in Spring Boot. Before Spring Boot was around, I was working on a project where we did a similar integration of CRaSH shell with a Spring-based server project and it provided a wealth of interesting and useful opportunities to dig into our running system and observe or make changes. Very powerful.</p>
</div></p>
  	
		<a href="blog/2015/multi-pagination.html"><h1>Multi-Collection Pagination</h1></a>
		<p><em>31 October 2015</em> ~ <a href='/tags/blog.html'>blog</a></p>
		<p><div class="paragraph">
<p>A few years ago, I was working on a project where we had collections of data spread across multiple rows of data&#8230;&#8203; and then we had to provide a paginated view of that data. This research was the result of those efforts. The discussion here is a bit more rigorous than I usually go into, so if you just want the implementation code jump to the bottom.</p>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider that you have a data set representing a collection of collections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
    [ A0, A1, A2, A3, A4, A5 ],
    [ B0, B1, B2, B3, B4, B5 ],
    [ C0, C1, C2, C3, C4, C5 ]
]</pre>
</div>
</div>
<div class="paragraph">
<p>We want to retrieve the data in a paginated fashion where the subset (page) with index <code>P</code> and subset size (page size) <code>S</code> is used to retrieve only the desired elements in the most efficient means possible.</p>
</div>
<div class="paragraph">
<p>Consider also that the data sets may be very large and that the internal collections may not be directly associated with the enclosing collection (e.g. two different databases).</p>
</div>
<div class="paragraph">
<p>Also consider that the subsets may cross collection boundaries or contain fewer than the desired number of elements.</p>
</div>
<div class="paragraph">
<p>Lastly, requests for data subsets will be more likely discrete events – one subset per request, rather than iterating over all results.</p>
</div>
<div class="paragraph">
<p>For a page size of four (<code>S = 4</code>) you would have the following five pages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>P0 : [ A0, A1, A2, A3 ]
P1 : [ A4, A5, B0, B1 ]
P2 : [ B2, B3, B4, B5 ]
P3 : [ C0, C1, C2, C3 ]
P4 : [ C4, C5 ]</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_computations">Computations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The overall collection is traversed to determine how many elements are contained within each sub-collection; this may be pre-computed or done at runtime. Three counts are calculated or derived for each sub-collection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Count (<code>CI</code>) - the number of elements in the sub-collection.</p>
</li>
<li>
<p>Count-before (<code>CB</code>) - the total count of all sub-collection elements counted before this collection, but not including this collection.</p>
</li>
<li>
<p>Count-with (<code>CW</code>) - the total count of all sub-collection elements counted before and including this collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For our example data set we would have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
    { CI:6, CB:0, CW:6 [ A0, A1, A2, A3, A4, A5 ] },
    { CI:6, CB:6, CW:12 [ B0, B1, B2, B3, B4, B5 ] },
    { CI:6, CB:12, CW:18 [ C0, C1, C2, C3, C4, C5 ] }
]</pre>
</div>
</div>
<div class="paragraph">
<p>This allows for a simple means of selecting only the sub-collections we are interested in; those containing the desired elements based on the starting and ending indices for the subset (<code>START</code> and <code>END</code> respectively). These indices can easily be calculated as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>START = P * S

END = START + S – 1</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The indices referenced here are for the overall collection, not the individual sub-collections.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The desired elements will reside in sub-collections whose inclusive count (<code>CW</code>) is greater than the starting index and whose preceding count (<code>CB</code>) is less than or equal to the ending index, or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CW &gt; START and CB ≤ END</pre>
</div>
</div>
<div class="paragraph">
<p>For the case of selecting the second subset of data (<code>P = 1</code>) with a page size of four (<code>S = 4</code>) we would have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>START = 4

END = 7</pre>
</div>
</div>
<div class="paragraph">
<p>This will select the first two or the three sub-collections as "interesting" sub-collections containing at least some of our desired elements, namely:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ CI:6, CB:0, CW:6 [ A0, A1, A2, A3, A4, A5 ] },
{ CI:6, CB:6, CW:12 [ B0, B1, B2, B3, B4, B5 ] }</pre>
</div>
</div>
<div class="paragraph">
<p>What remains is to gather from these sub-collections (call them <code>SC[0]</code>, <code>SC[1]</code>) the desired number of elements (<code>S</code>).</p>
</div>
<div class="paragraph">
<p>To achieve this, a local starting and ending index must be calculated while iterating through the "interesting" sub-collections to gather the elements until either the desired amount is obtained (<code>S</code>) or there are no more elements available.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Calculate the initial local starting index (<code>LOCAL_START</code>) by subtracting the non-inclusive preceding count value of the first selected collection (<code>SC[0]</code>) from the overall starting index.</p>
</li>
<li>
<p>Iterate the selected collections (in order) until the desired amount has been gathered</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is more clearly represented in pseudo code as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>LOCAL_START = START – SC[0].CB
REMAINING = S

for-each sc in SC while REMAINING &gt; 0

    if( REMAINING &lt; (sc.size() - LOCAL_START) )
        LOCAL_END = LOCAL_START + REMAINING - 1
    else
        LOCAL_END = sc.size()-1

    FOUND = sc.sub( LOCAL_START, LOCAL_END )
    G.addAll( FOUND )
    REMAINING = REMAINING – FOUND.size()
    LOCAL_START = 0

end</pre>
</div>
</div>
<div class="paragraph">
<p>Where the gathered collection of elements (<code>G</code>) is your resulting data set containing the elements for the specified data page.</p>
</div>
<div class="paragraph">
<p>It must be stated that the ordering of the overall collection and the sub-collections must be consistent across multiple data requests for this procedure to work properly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ok now, enough discussion. Let&#8217;s see what this looks like with some real Groovy code. First, we need our collections of collections data to work with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def data = [
    [ 'A0', 'A1', 'A2', 'A3', 'A4', 'A5' ],
    [ 'B0', 'B1', 'B2', 'B3', 'B4', 'B5' ],
    [ 'C0', 'C1', 'C2', 'C3', 'C4', 'C5' ]
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we need to implement the algorithm in Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">int page = 1
int pageSize = 4

// pre-computation

int before = 0
def prepared = data.collect {d -&gt;
    def result = [
        countIn: d.size(),
        countBefore: before,
        countWith: before + d.size(),
        values:d
    ]

    before += d.size()

    return result
}

// main computation

def localStart = (page * pageSize ) - prepared[0].countBefore
def remaining = pageSize

def gathered = []

prepared.each { sc-&gt;
    if( remaining ){
        def localEnd
        if( remaining &lt; (sc.values.size() - localStart) ){
            localEnd = localStart + remaining - 1
        } else {
            localEnd = sc.values.size() - 1
        }

        def found = sc.values[localStart..localEnd]
        gathered.addAll(found)

        remaining -= found.size()
        localStart = 0
    }
}

println "P$page : $gathered"</code></pre>
</div>
</div>
<div class="paragraph">
<p>which yields</p>
</div>
<div class="listingblock">
<div class="content">
<pre>P1 : [A4, A5, B0, B1]</pre>
</div>
</div>
<div class="paragraph">
<p>and if you look all the way back up to the beginning of the article, you see that this is the expected data set for page 1 of the example data.</p>
</div>
<div class="paragraph">
<p>It&#8217;s not a scenario I have run into often, but it was a bit of a tricky one to unravel. The pre-computation steps ended up being the key to keeping it simple and stable.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2015/gsp-view-resolver.html"><h1>Spring ViewResolver for "GSP"</h1></a>
		<p><em>26 October 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/vanilla.html'>vanilla</a>, <a href='/tags/spring.html'>spring</a></p>
		<p><div class="paragraph">
<p>Recently, while working on a <a href="http://springframework.org">Spring MVC</a> application, I was considering which template framework to use for my views and I was surprised to realize that there was no implementation using the Groovy <a href="http://docs.groovy-lang.org/latest/html/gapi/groovy/text/GStringTemplateEngine.html">GStringTemplateEngine</a>. There is one for the Groovy Markup Templates; however, in my opinion, that format seems pretty terrible - they are interesting in themselves, but they seem like they would be a
nightmare to maintain, and your designers would kill you if they ever had to work with them.</p>
</div>
<div class="paragraph">
<p>This obvious gap in functionality surprised me and even a quick Google search did not turn up any implementations, though there was some documentation around using the Grails GSP framework in a standard Spring Boot application, but this seemed like overkill for how simple the templates can be. Generally, implementing extensions to the Spring Framework is pretty simple so I decided to give it a quick try&#8230;&#8203; and I was right, it was not hard at all.</p>
</div>
<div class="paragraph">
<p>The <code>ViewResolver</code> implementation I came up with is an extension of the <code>AbstractTemplateViewResolver</code> with one main method of interest, the <code>buildView(String)</code> method
which contains the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">protected AbstractUrlBasedView buildView(final String viewName) throws Exception {
    GroovyTemplateView view = super.buildView(viewName) as GroovyTemplateView <b class="conum">(1)</b>

    URL templateUrl = applicationContext.getResource(view.url).getURL() <b class="conum">(2)</b>

    view.template = templateEngine.createTemplate(
        applicationContext.getResource(view.url).getURL()
    ) <b class="conum">(3)</b>

    view.encoding = defaultEncoding

    return view
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Call the super class to create a configured instance of the <code>View</code></p>
</li>
<li>
<p>Load the template from the <code>ApplicationContext</code> using the <code>url</code> property of the <code>View</code></p>
</li>
<li>
<p>Create the <code>Template</code> from the contents of the URL</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This method basically just uses the view resolver framework to find the template file
and load it with the <code>GSTringTemplateEngine</code> - the framework takes care of the
caching and model attribute management.</p>
</div>
<div class="paragraph">
<p>The <code>View</code> implementation is also quite simple; it is an extension of the <code>AbstractTemplateview</code>, with the only implmented method being the <code>renderMergedTemplateModel()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">protected void renderMergedTemplateModel(
    Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse res
) throws Exception {
    res.contentType = contentType
    res.characterEncoding = encoding

    res.writer.withPrintWriter { PrintWriter out -&gt;
        out.write(template.make(model) as String)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Template</code> content is rendered using the configured model data and then written to the <code>PrintWriter</code> from the <code>HttpServletResponse</code>, which sends it to the client.</p>
</div>
<div class="paragraph">
<p>Lastly, you need to configure the resolver in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Bean ViewResolver viewResolver() {
    new GroovyTemplateViewResolver(
        contentType: 'text/html',
        cache: true,
        prefix: '/WEB-INF/gsp/',
        suffix: '.gsp'
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to notice here is all the functionality you get by default from the Spring <code>ViewResolver</code> framework for very little added code on your part.</p>
</div>
<div class="paragraph">
<p>Another thing to note is that "GSP" file in this case is not really a true GSP; however, you have all the functionality provided by the <code>GStringTemplateEngine</code>, which is quite similar. An example template could be something like:</p>
</div>
<div id="app-listing" class="listingblock">
<div class="title">hello.gsp</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-gsp" data-lang="gsp">&lt;html&gt;
    &lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        [${new Date()}] Hello, ${name ?: 'stranger'}

        &lt;% if(personService.seen(name)){ %&gt;
            You have been here ${personService.visits(name)} times.
        &lt;% } %&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s definitely a nice clean template language if you are already coding everything else in Groovy anyway.</p>
</div>
<div class="paragraph">
<p>I will be adding a spring helper library to my vanilla project; the "vanilla-spring"
project will have the final version of this code, though it should be similar to
what is dicussed here. The full source for the code discussed above is provided below for reference until the actual code is released.</p>
</div>
<div id="app-listing" class="listingblock">
<div class="title">GroovyTemplateViewResolver.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.vanilla.spring.view

// imports removed...

@TypeChecked
class GroovyTemplateViewResolver extends AbstractTemplateViewResolver {

    /**
     * The default character encoding to be used by the template views. Defaults to UTF-8 if not specified.
     */
    String defaultEncoding = StandardCharsets.UTF_8.name()

    private final TemplateEngine templateEngine = new GStringTemplateEngine()

    GroovyTemplateViewResolver() {
        viewClass = requiredViewClass()
    }

    @Override
    protected Class&lt;?&gt; requiredViewClass() {
        GroovyTemplateView
    }

    @Override
    protected AbstractUrlBasedView buildView(final String viewName) throws Exception {
        GroovyTemplateView view = super.buildView(viewName) as GroovyTemplateView

        view.template = templateEngine.createTemplate(
            applicationContext.getResource(view.url).getURL()
        )

        view.encoding = defaultEncoding
        return view
    }
}</code></pre>
</div>
</div>
<div id="app-listing" class="listingblock">
<div class="title">GroovyTemplateView.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.vanilla.spring.view

// imports removed...

@TypeChecked
class GroovyTemplateView extends AbstractTemplateView {

    Template template
    String encoding

    @Override
    protected void renderMergedTemplateModel(
        Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse res
    ) throws Exception {
        res.contentType = contentType
        res.characterEncoding = encoding

        res.writer.withPrintWriter { PrintWriter out -&gt;
            out.write(template.make(model) as String)
        }
    }
}</code></pre>
</div>
</div></p>
  	
	
	<hr />
	
	<p>Older posts are available in the <a href="/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 <a href="https://plus.google.com/+ChristopherStehno">Christopher J. Stehno</a> | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-27165855-1', 'auto');
      ga('send', 'pageview');
    </script>
    
  </body>
</html>