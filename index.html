<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>CoffeaElectronica.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="shortcut icon" href="/favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
   

		<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">CoffeaElectronica.com</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/index.html">Home</a></li>
            <li><a href="/about.html">About</a></li>
            <li><a href="/archive.html">Archive</a></li>
            
             <li role="presentation" class="dropdown">
	      <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-expanded="false">
		Tags <span class="caret"></span>
	      </a>
	      <ul class="dropdown-menu" role="menu">
		
		  <li><a href="/tags/ant.html">ant</a></li>
		
		  <li><a href="/tags/blog.html">blog</a></li>
		
		  <li><a href="/tags/gradle.html">gradle</a></li>
		
		  <li><a href="/tags/groovy.html">groovy</a></li>
		
		  <li><a href="/tags/java.html">java</a></li>
		
		  <li><a href="/tags/javascript.html">javascript</a></li>
		
		  <li><a href="/tags/maven.html">maven</a></li>
		
		  <li><a href="/tags/python.html">python</a></li>
		
		  <li><a href="/tags/spring.html">spring</a></li>
		
		  <li><a href="/tags/testing.html">testing</a></li>
		
		  <li><a href="/tags/vanilla.html">vanilla</a></li>
		
		
	      </ul>
	    </li>
            
            <li><a href="/feed.xml">Subscribe</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
    


	
		<a href="blog/2015/spring-shell.html"><h1>Spring Boot Remote Shell</h1></a>
		<p><em>07 November 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/spring.html'>spring</a></p>
		<p><div class="paragraph">
<p><a href="http://projects.spring.io/spring-boot/">Spring Boot</a> comes with a ton of useful features that you can enable as needed, and in general the documentation is pretty good; however, sometimes it feels like they gloss over a feature that eventually realize is much more useful than it originally seemed. The remote shell support is one of those features.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start off with a simple Spring Boot project based on the example provided with the Boot documentation. Our <code>build.gradle</code>
file is:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath 'org.springframework.boot:spring-boot-gradle-plugin:1.2.7.RELEASE'
    }
}

version = "0.0.1"
group = "com.stehno"

apply plugin: 'groovy'
apply plugin: 'spring-boot'

sourceCompatibility = 8
targetCompatibility = 8

mainClassName = 'com.stehno.SampleController'

repositories {
    jcenter()
}

dependencies {
    compile "org.codehaus.groovy:groovy-all:2.4.5"

    compile 'org.springframework.boot:spring-boot-starter-web'
}

task wrapper(type: Wrapper) {
    gradleVersion = "2.8"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, our simple controller and starter class looks like:</p>
</div>
<div class="listingblock">
<div class="title">SampleController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Controller
@EnableAutoConfiguration
public class SampleController {

    @RequestMapping('/')
    @ResponseBody
    String home() {
        'Hello World!'
    }

    static void main(args) throws Exception {
        SpringApplication.run(SampleController, args)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew clean build bootRun</pre>
</div>
</div>
<div class="paragraph">
<p>and you get your run of the mill "Hello world" application. For our demonstration purposes, we need something a bit more
interesting. Let&#8217;s make the controller something like a "Message of the Day" server which will return a fixed configured
message. Remove the <code>hello</code> controller action and add in the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String message = 'Message for you, sir!'

@RequestMapping('/') @ResponseBody
String message() {
    message
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will return the static message "Message for you, sir!" for every request. Running the application now, will still
be pretty uninteresting, but wait, it gets better.</p>
</div>
<div class="paragraph">
<p>Now, we would like to have the ability to change the message as needed without rebuilding or even restarting the server.
There are handful of ways to do this; however, I&#8217;m going to discuss one of the seemingly less used options&#8230;&#8203; The
<a href="http://www.crashub.org/">CRaSH Shell</a> integration provided in Spring Boot
(<a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready-remote-shell">43. Production Ready Remote Shell</a>).</p>
</div>
<div class="paragraph">
<p>To add the remote shell support in Spring Boot, you add the following line to your <code>dependencies</code> block in your <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>compile 'org.springframework.boot:spring-boot-starter-remote-shell'</pre>
</div>
</div>
<div class="paragraph">
<p>Now, when you run the application, you will see an extra line in the server log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Using default password for shell access: 44b3556b-ff9f-4f82-9f1b-54a16da471d5</pre>
</div>
</div>
<div class="paragraph">
<p>Since no password was configured, Boot has provided a randomly generated one for you (obviously you would configure this in a real system). You now have an SSH connection available to your application. Using the ssh client of your choice you can login using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ssh -p 2000 user@localhost</pre>
</div>
</div>
<div class="paragraph">
<p>Which will ask you for the provided password. Once you have logged in you are connected to a secure shell running inside your application. You can run <code>help</code> at the prompt to get a list of available commands, which will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; help
Try one of these commands with the -h or --help switch:

NAME       DESCRIPTION
autoconfig Display auto configuration report from ApplicationContext
beans      Display beans in ApplicationContext
cron       manages the cron plugin
dashboard  a monitoring dashboard
egrep      search file(s) for lines that match a pattern
endpoint   Invoke actuator endpoints
env        display the term env
filter     a filter for a stream of map
java       various java language commands
jmx        Java Management Extensions
jul        java.util.logging commands
jvm        JVM informations
less       opposite of more
mail       interact with emails
man        format and display the on-line manual pages
metrics    Display metrics provided by Spring Boot
shell      shell related command
sleep      sleep for some time
sort       sort a map
system     vm system properties commands
thread     JVM thread commands
help       provides basic help
repl       list the repl or change the current repl</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, you get quite a bit of functionality right out of the box. I will leave the discussion of each of the provided commands to another post. What we are interested at this point is adding our own command to update the message displayed by our controller.</p>
</div>
<div class="paragraph">
<p>The really interesting part of the shell integration is the fact that you can extend it with your own commands.</p>
</div>
<div class="paragraph">
<p>Create a new directory <code>src/main/resources/commands</code> which is where your extended commands will live, and then add a simple starting point class for our command:</p>
</div>
<div class="listingblock">
<div class="title">message.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-goovy" data-lang="goovy">package commands

import org.crsh.cli.Usage
import org.crsh.cli.Command
import org.crsh.command.InvocationContext

@Usage('Interactions with the message of the day.')
class message {

    @Usage('View the current message of the day.')
    @Command
    def view(InvocationContext context) {
        return 'Hello'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Usage</code> annotations provide the help/usage documentation for the command, while the <code>@Command</code> annotation denotes that the <code>view</code> method is a command.</p>
</div>
<div class="paragraph">
<p>Now, when you run the application and list the shell commands, you will see our new command added to the list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>message    Interactions with the message of the day.</pre>
</div>
</div>
<div class="paragraph">
<p>If you run the command as <code>message view</code> you will get the static "Hello" message returned to you on the shell console.</p>
</div>
<div class="paragraph">
<p>Okay, we need the ability to view our current message of the day. The <code>InvocationContext</code> has <code>attributes</code> which are propulated by Spring, one of which is <code>spring.beanfactory</code> a reference to the Spring <code>BeanFactory</code> for your application. We can access the current message of the day by replacing the content of the <code>view</code> method with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">BeanFactory beans = context.attributes['spring.beanfactory']
return beans.getBean(SampleController).message</code></pre>
</div>
</div>
<div class="paragraph">
<p>where we find our controller bean and simply read the <code>message</code> property. Running the application and the shell command now, yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Message for you, sir!</pre>
</div>
</div>
<div class="paragraph">
<p>While that is pretty cool, we are actually here to modify the message, not just view it and this is just as easy. Add a new command named <code>update</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Usage('Update the current message of the day.')
@Command
def update(
    InvocationContext context,
    @Usage('The new message') @Argument String message
) {
    BeanFactory beans = context.attributes['spring.beanfactory']
    beans.getBean(SampleController).message = message
    return "Message updated to: $message"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, rebuild/restart the server and start up the shell. If you execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>message update "This is cool!"</pre>
</div>
</div>
<div class="paragraph">
<p>You will update the configured message, which you can verify using the <code>message view</code> command, or better yet, you can hit your server and see that the returned message has been updated&#8230;&#8203; no restart required. Indeed, this is cool.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can find a lot more information about writing your own commands in the CRaSH documentation for <a href="http://www.crashub.org/1.3/reference.html#developping_commands">Developing Commands</a>. There is a lot of functionality that I am not covering here.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, we are functionally complete. We can view and update the message of the day without requiring a restart of the server. But, there are still some added goodies provided by the shell, especially around shell UI support - yes, it&#8217;s text, but it can still be pretty and one of the ways CRaSH allows you to pretty things up is with colors and formatting via styles and the <code>UIBuilder</code> (which is sadly under-documented).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add another property to our controller to make things more interesting. Just add a <code>Date lastUpdated = new Date()</code> field. This will give us two properties to play with. Update the <code>view</code> action as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">SampleController controller = context.attributes['spring.beanfactory'].getBean(SampleController)

String message = controller.message
String date = controller.lastUpdated.format('MM/dd/yyyy HH:mm')

out.print new UIBuilder().table(separator: dashed, overflow: Overflow.HIDDEN, rightCellPadding: 1) {
    header(decoration: bold, foreground: black, background: white) {
        label('Date')
        label('Message')
    }

    row {
        label(date, foreground: green)
        label(message, foreground: yellow)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We still retrieve the instance of the controller as before; however, now our output rendering is a bit more complicated, though still pretty understandable. We are creating a new <code>UIBuilder</code> for a <code>table</code> and then applying the <code>header</code> and <code>row</code> contents to it. It&#8217;s actually a very powerful construct, I just had to dig around in the project source code to actually figure out how to make it work.</p>
</div>
<div class="paragraph">
<p>You will also need to update the <code>update</code> command to set the new date field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">SampleController controller = context.attributes['spring.beanfactory'].getBean(SampleController)
controller.message = message
controller.lastUpdated = new Date()

return "Message updated to: $message"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have that built and running you can run the <code>message view</code> command and get a much nicer multi-colored table output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; message view
Date             Message
-------------------------------------------------------------
11/05/2015 10:37 And now for something completely different.</pre>
</div>
</div>
<div class="paragraph">
<p>Which puts wraps up what we are trying to do here and even puts a bow on it. You can find more information on the remote shell configuration options in the Spring Boot documentation in <a href="http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#common-application-properties">Appendix A: Common Application Properties</a>. This is where you can configure the port, change the authentication settings, and even disable some of the default provided commands.</p>
</div>
<div class="paragraph">
<p>The remote shell support is one of the more interesting, but underused features in Spring Boot. Before Spring Boot was around, I was working on a project where we did a similar integration of CRaSH shell with a Spring-based server project and it provided a wealth of interesting and useful opportunities to dig into our running system and observe or make changes. Very powerful.</p>
</div></p>
  	
		<a href="blog/2015/multi-pagination.html"><h1>Multi-Collection Pagination</h1></a>
		<p><em>31 October 2015</em> ~ <a href='/tags/blog.html'>blog</a></p>
		<p><div class="paragraph">
<p>A few years ago, I was working on a project where we had collections of data spread across multiple rows of data&#8230;&#8203; and then we had to provide a paginated view of that data. This research was the result of those efforts. The discussion here is a bit more rigorous than I usually go into, so if you just want the implementation code jump to the bottom.</p>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider that you have a data set representing a collection of collections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
    [ A0, A1, A2, A3, A4, A5 ],
    [ B0, B1, B2, B3, B4, B5 ],
    [ C0, C1, C2, C3, C4, C5 ]
]</pre>
</div>
</div>
<div class="paragraph">
<p>We want to retrieve the data in a paginated fashion where the subset (page) with index <code>P</code> and subset size (page size) <code>S</code> is used to retrieve only the desired elements in the most efficient means possible.</p>
</div>
<div class="paragraph">
<p>Consider also that the data sets may be very large and that the internal collections may not be directly associated with the enclosing collection (e.g. two different databases).</p>
</div>
<div class="paragraph">
<p>Also consider that the subsets may cross collection boundaries or contain fewer than the desired number of elements.</p>
</div>
<div class="paragraph">
<p>Lastly, requests for data subsets will be more likely discrete events – one subset per request, rather than iterating over all results.</p>
</div>
<div class="paragraph">
<p>For a page size of four (<code>S = 4</code>) you would have the following five pages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>P0 : [ A0, A1, A2, A3 ]
P1 : [ A4, A5, B0, B1 ]
P2 : [ B2, B3, B4, B5 ]
P3 : [ C0, C1, C2, C3 ]
P4 : [ C4, C5 ]</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_computations">Computations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The overall collection is traversed to determine how many elements are contained within each sub-collection; this may be pre-computed or done at runtime. Three counts are calculated or derived for each sub-collection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Count (<code>CI</code>) - the number of elements in the sub-collection.</p>
</li>
<li>
<p>Count-before (<code>CB</code>) - the total count of all sub-collection elements counted before this collection, but not including this collection.</p>
</li>
<li>
<p>Count-with (<code>CW</code>) - the total count of all sub-collection elements counted before and including this collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For our example data set we would have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
    { CI:6, CB:0, CW:6 [ A0, A1, A2, A3, A4, A5 ] },
    { CI:6, CB:6, CW:12 [ B0, B1, B2, B3, B4, B5 ] },
    { CI:6, CB:12, CW:18 [ C0, C1, C2, C3, C4, C5 ] }
]</pre>
</div>
</div>
<div class="paragraph">
<p>This allows for a simple means of selecting only the sub-collections we are interested in; those containing the desired elements based on the starting and ending indices for the subset (<code>START</code> and <code>END</code> respectively). These indices can easily be calculated as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>START = P * S

END = START + S – 1</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The indices referenced here are for the overall collection, not the individual sub-collections.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The desired elements will reside in sub-collections whose inclusive count (<code>CW</code>) is greater than the starting index and whose preceding count (<code>CB</code>) is less than or equal to the ending index, or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CW &gt; START and CB ≤ END</pre>
</div>
</div>
<div class="paragraph">
<p>For the case of selecting the second subset of data (<code>P = 1</code>) with a page size of four (<code>S = 4</code>) we would have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>START = 4

END = 7</pre>
</div>
</div>
<div class="paragraph">
<p>This will select the first two or the three sub-collections as "interesting" sub-collections containing at least some of our desired elements, namely:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ CI:6, CB:0, CW:6 [ A0, A1, A2, A3, A4, A5 ] },
{ CI:6, CB:6, CW:12 [ B0, B1, B2, B3, B4, B5 ] }</pre>
</div>
</div>
<div class="paragraph">
<p>What remains is to gather from these sub-collections (call them <code>SC[0]</code>, <code>SC[1]</code>) the desired number of elements (<code>S</code>).</p>
</div>
<div class="paragraph">
<p>To achieve this, a local starting and ending index must be calculated while iterating through the "interesting" sub-collections to gather the elements until either the desired amount is obtained (<code>S</code>) or there are no more elements available.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Calculate the initial local starting index (<code>LOCAL_START</code>) by subtracting the non-inclusive preceding count value of the first selected collection (<code>SC[0]</code>) from the overall starting index.</p>
</li>
<li>
<p>Iterate the selected collections (in order) until the desired amount has been gathered</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is more clearly represented in pseudo code as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>LOCAL_START = START – SC[0].CB
REMAINING = S

for-each sc in SC while REMAINING &gt; 0

    if( REMAINING &lt; (sc.size() - LOCAL_START) )
        LOCAL_END = LOCAL_START + REMAINING - 1
    else
        LOCAL_END = sc.size()-1

    FOUND = sc.sub( LOCAL_START, LOCAL_END )
    G.addAll( FOUND )
    REMAINING = REMAINING – FOUND.size()
    LOCAL_START = 0

end</pre>
</div>
</div>
<div class="paragraph">
<p>Where the gathered collection of elements (<code>G</code>) is your resulting data set containing the elements for the specified data page.</p>
</div>
<div class="paragraph">
<p>It must be stated that the ordering of the overall collection and the sub-collections must be consistent across multiple data requests for this procedure to work properly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ok now, enough discussion. Let&#8217;s see what this looks like with some real Groovy code. First, we need our collections of collections data to work with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def data = [
    [ 'A0', 'A1', 'A2', 'A3', 'A4', 'A5' ],
    [ 'B0', 'B1', 'B2', 'B3', 'B4', 'B5' ],
    [ 'C0', 'C1', 'C2', 'C3', 'C4', 'C5' ]
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we need to implement the algorithm in Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">int page = 1
int pageSize = 4

// pre-computation

int before = 0
def prepared = data.collect {d -&gt;
    def result = [
        countIn: d.size(),
        countBefore: before,
        countWith: before + d.size(),
        values:d
    ]

    before += d.size()

    return result
}

// main computation

def localStart = (page * pageSize ) - prepared[0].countBefore
def remaining = pageSize

def gathered = []

prepared.each { sc-&gt;
    if( remaining ){
        def localEnd
        if( remaining &lt; (sc.values.size() - localStart) ){
            localEnd = localStart + remaining - 1
        } else {
            localEnd = sc.values.size() - 1
        }

        def found = sc.values[localStart..localEnd]
        gathered.addAll(found)

        remaining -= found.size()
        localStart = 0
    }
}

println "P$page : $gathered"</code></pre>
</div>
</div>
<div class="paragraph">
<p>which yields</p>
</div>
<div class="listingblock">
<div class="content">
<pre>P1 : [A4, A5, B0, B1]</pre>
</div>
</div>
<div class="paragraph">
<p>and if you look all the way back up to the beginning of the article, you see that this is the expected data set for page 1 of the example data.</p>
</div>
<div class="paragraph">
<p>It&#8217;s not a scenario I have run into often, but it was a bit of a tricky one to unravel. The pre-computation steps ended up being the key to keeping it simple and stable.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2015/gsp-view-resolver.html"><h1>Spring ViewResolver for "GSP"</h1></a>
		<p><em>26 October 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/vanilla.html'>vanilla</a>, <a href='/tags/spring.html'>spring</a></p>
		<p><div class="paragraph">
<p>Recently, while working on a <a href="http://springframework.org">Spring MVC</a> application, I was considering which template framework to use for my views and I was surprised to realize that there was no implementation using the Groovy <a href="http://docs.groovy-lang.org/latest/html/gapi/groovy/text/GStringTemplateEngine.html">GStringTemplateEngine</a>. There is one for the Groovy Markup Templates; however, in my opinion, that format seems pretty terrible - they are interesting in themselves, but they seem like they would be a
nightmare to maintain, and your designers would kill you if they ever had to work with them.</p>
</div>
<div class="paragraph">
<p>This obvious gap in functionality surprised me and even a quick Google search did not turn up any implementations, though there was some documentation around using the Grails GSP framework in a standard Spring Boot application, but this seemed like overkill for how simple the templates can be. Generally, implementing extensions to the Spring Framework is pretty simple so I decided to give it a quick try&#8230;&#8203; and I was right, it was not hard at all.</p>
</div>
<div class="paragraph">
<p>The <code>ViewResolver</code> implementation I came up with is an extension of the <code>AbstractTemplateViewResolver</code> with one main method of interest, the <code>buildView(String)</code> method
which contains the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">protected AbstractUrlBasedView buildView(final String viewName) throws Exception {
    GroovyTemplateView view = super.buildView(viewName) as GroovyTemplateView <b class="conum">(1)</b>

    URL templateUrl = applicationContext.getResource(view.url).getURL() <b class="conum">(2)</b>

    view.template = templateEngine.createTemplate(
        applicationContext.getResource(view.url).getURL()
    ) <b class="conum">(3)</b>

    view.encoding = defaultEncoding

    return view
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Call the super class to create a configured instance of the <code>View</code></p>
</li>
<li>
<p>Load the template from the <code>ApplicationContext</code> using the <code>url</code> property of the <code>View</code></p>
</li>
<li>
<p>Create the <code>Template</code> from the contents of the URL</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This method basically just uses the view resolver framework to find the template file
and load it with the <code>GSTringTemplateEngine</code> - the framework takes care of the
caching and model attribute management.</p>
</div>
<div class="paragraph">
<p>The <code>View</code> implementation is also quite simple; it is an extension of the <code>AbstractTemplateview</code>, with the only implmented method being the <code>renderMergedTemplateModel()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">protected void renderMergedTemplateModel(
    Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse res
) throws Exception {
    res.contentType = contentType
    res.characterEncoding = encoding

    res.writer.withPrintWriter { PrintWriter out -&gt;
        out.write(template.make(model) as String)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Template</code> content is rendered using the configured model data and then written to the <code>PrintWriter</code> from the <code>HttpServletResponse</code>, which sends it to the client.</p>
</div>
<div class="paragraph">
<p>Lastly, you need to configure the resolver in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Bean ViewResolver viewResolver() {
    new GroovyTemplateViewResolver(
        contentType: 'text/html',
        cache: true,
        prefix: '/WEB-INF/gsp/',
        suffix: '.gsp'
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to notice here is all the functionality you get by default from the Spring <code>ViewResolver</code> framework for very little added code on your part.</p>
</div>
<div class="paragraph">
<p>Another thing to note is that "GSP" file in this case is not really a true GSP; however, you have all the functionality provided by the <code>GStringTemplateEngine</code>, which is quite similar. An example template could be something like:</p>
</div>
<div id="app-listing" class="listingblock">
<div class="title">hello.gsp</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-gsp" data-lang="gsp">&lt;html&gt;
    &lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        [${new Date()}] Hello, ${name ?: 'stranger'}

        &lt;% if(personService.seen(name)){ %&gt;
            You have been here ${personService.visits(name)} times.
        &lt;% } %&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s definitely a nice clean template language if you are already coding everything else in Groovy anyway.</p>
</div>
<div class="paragraph">
<p>I will be adding a spring helper library to my vanilla project; the "vanilla-spring"
project will have the final version of this code, though it should be similar to
what is dicussed here. The full source for the code discussed above is provided below for reference until the actual code is released.</p>
</div>
<div id="app-listing" class="listingblock">
<div class="title">GroovyTemplateViewResolver.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.vanilla.spring.view

// imports removed...

@TypeChecked
class GroovyTemplateViewResolver extends AbstractTemplateViewResolver {

    /**
     * The default character encoding to be used by the template views. Defaults to UTF-8 if not specified.
     */
    String defaultEncoding = StandardCharsets.UTF_8.name()

    private final TemplateEngine templateEngine = new GStringTemplateEngine()

    GroovyTemplateViewResolver() {
        viewClass = requiredViewClass()
    }

    @Override
    protected Class&lt;?&gt; requiredViewClass() {
        GroovyTemplateView
    }

    @Override
    protected AbstractUrlBasedView buildView(final String viewName) throws Exception {
        GroovyTemplateView view = super.buildView(viewName) as GroovyTemplateView

        view.template = templateEngine.createTemplate(
            applicationContext.getResource(view.url).getURL()
        )

        view.encoding = defaultEncoding
        return view
    }
}</code></pre>
</div>
</div>
<div id="app-listing" class="listingblock">
<div class="title">GroovyTemplateView.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.vanilla.spring.view

// imports removed...

@TypeChecked
class GroovyTemplateView extends AbstractTemplateView {

    Template template
    String encoding

    @Override
    protected void renderMergedTemplateModel(
        Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse res
    ) throws Exception {
        res.contentType = contentType
        res.characterEncoding = encoding

        res.writer.withPrintWriter { PrintWriter out -&gt;
            out.write(template.make(model) as String)
        }
    }
}</code></pre>
</div>
</div></p>
  	
		<a href="blog/2015/object-mappers.html"><h1>Copying Data with ObjectMappers</h1></a>
		<p><em>10 October 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/vanilla.html'>vanilla</a></p>
		<p><p>When working with legacy codebases, I tend to run into a lot of scenarios where I am copying data objects from one format to another while an API is in transition or due to some data model mismatch. </p><p>Suppose we have an object in one system - I am using Groovy because it keeps things simple, but it could be Java as well:</p>
<pre><code class="groovy">class Person {
    long id
    String firstName
    String lastName
    LocalDate birthDate
}
</code></pre><p>and then you are working with a legacy (or external) API which provides similar data in the form of:</p>
<pre><code class="groovy">class Individual {
    long id
    String givenName
    String familyName
    String birthDate
}
</code></pre><p>and now you have to integrate the conversion from the old/external format (<code>Individual</code>) to your internal format (<code>Person</code>).</p><p>You can write the code in Java using the <code>Transformer</code> interface from <a href="http://commons.apache.org/proper/commons-collections/">Apache Commons Collections</a>, which ends up with something like this:</p>
<pre><code class="java">public class IndividualToPerson implements Transformer&lt;Individual,Person&gt;{
    
    public Person transform(Individual indiv){
        Person person = new Person();
        person.setId( indiv.getId() );
        person.setFirstName( indiv.getGivenName() );
        person.setLastName( indiv.getFamilyName() );
        person.setBirthDate( LocalDate.parse(indiv.getBirthDate()) );
        return person;
    }
}
</code></pre><p>I wrote a blog post about this many years ago (<a href="http://coffeaelectronica.com/blog/2005/commons-collections-transformers.html">Commons Collections - Transformers</a>); however, if you have more than a handful of these conversions, you can end up handwriting a lot of the same code over and over, which can be error prone and time consuming. Even switching the code above to full-on Groovy does not really save you much, though it is better:</p>
<pre><code class="java">class IndividualToPerson implements Transformer&lt;Individual,Person&gt;{
    
    Person transform(Individual indiv){
        new Person(
            id: indiv.id,
            firstName: indiv.givenName,
            lastName: indiv.familyName,
            birthDate: LocalDate.parse(indiv.birthDate)
        )
    }
}
</code></pre><p>What I came up with was a simple mapping DSL which allows for straight-forward definitions of the property mappings in the simplest code possible:</p>
<pre><code class="groovy">ObjectMapper inividualToPerson = mapper {
    map &#39;id&#39;
    map &#39;givenName&#39; into &#39;firstName&#39;
    map &#39;familyName&#39; into &#39;lastName&#39;
    map &#39;birthDate&#39; using { d-&gt; LocaleDate.parse(d) }
}
</code></pre><p>which builds an instance of <code>RuntimeObjectMapper</code> which is stateless and thread-safe. The <code>ObjectMapper</code> interface has a method <code>copy(Object source, Object dest)</code> which will copy the properties from the source object to the destination object. Your transformation code ends up something like this:</p>
<pre><code class="groovy">def people = individuals.collect { indiv-&gt;
    Person person = new Person()
    individualToPerson.copy(indiv, person)
    person
}
</code></pre><p>or we can use the <code>create(Object, Class)</code> method as:</p>
<pre><code class="groovy">def people = individuals.collect { indiv-&gt;
    individualToPerson.create(indiv, Person)
}
</code></pre><p>which is just a shortcut method for the same code, as long as you are able to create your destination object with a default constructor, which we are able to do.</p><p>There is also a third, slightly more useful option in this specific collector case:</p>
<pre><code class="groovy">def people = individuals.collect( individualToPerson.collector(Person) )
</code></pre><p>The <code>collector(Class)</code> method returns a <code>Closure</code> that is also a shortcut to the conversion code shown previously. It's mostly syntactic sugar, but it's nice and clean to work with.</p><p>Notice the 'using' method - this allows for conversion of the source data before it is set into the destination object. This is one of the more powerful features of the DSL. Consider the case where your <code>Person</code> class has an embedded <code>Name</code> class:</p>
<pre><code class="groovy">class Person {
    long id
    Name name
    LocalDate birthDate
}

@Canonical
class Name {
    String first
    String last
}
</code></pre><p>Now we want to map the name properties into this new embedded object rather than into the main object. The mapper DSL can do this too:</p>
<pre><code class="groovy">ObjectMapper individualToPerson = mapper {
    map &#39;id&#39;
    map &#39;givenName&#39; into &#39;name&#39; using { p,src-&gt; 
        new Name(src.givenName, src.familyName)
    }
    map &#39;birthDate&#39; using { d-&gt; LocaleDate.parse(d) }
}
</code></pre><p>It's a bit odd since you are mapping two properties into one property, but it gets the job done. The conversion closure will accept up to three parameters (or none) - the first being the source property being converted, the second is the source object instance and the third is the destination object instance. The one thing to keep in mind when using the two and three parameter versions is that the order of your property mapping definitions may begin to matter, especially if you are working with the destination object.</p><p>So far, we have been talking about runtime-based mappers that take your configuration and resolve your property mappings at runtime. It's reasonably efficient since it doesn't do all that much, but consider the case where you have a million objects to transform; those extra property mapping operations start to add up - that's when you go back to hand-coding it unless there is a way to build the mappers at compile time rather than run time...</p><p>There is. This was something I have really wanted to get a hold of for this project and others; the ability to use a DSL to control the AST transformations used in code generation... or, using the mapper DSL in an annotation to create the mapper class at compile time so that it is closer to what you would have hand-coded yourself (and also becomes a bit more performant since there are fewer operations being executed at runtime).</p><p>Using the static approach is simple, you just write the DSL code in the <code>@Mapper</code> annotation on a method, property or field:</p>
<pre><code class="groovy">class Mappers {

    @Mapper({
        map &#39;id&#39;
        map &#39;givenName&#39; into &#39;firstName&#39;
        map &#39;familyName&#39; into &#39;lastName&#39;
        map &#39;birthDate&#39; using { d-&gt; LocaleDate.parse(d) }    
    })
    static final ObjectMapper personMapper(){}
}
</code></pre><p>When the code compiles, a new implementation of <code>ObjectMapper</code> will be created and installed as the return value for the <code>personMapper()</code> method. The static version of the DSL has all of the same functionality of the dynamic version except that it does not support using <code>ObjectMappers</code> direction in the <code>using</code> command; however, a workaround for this is to use a closure.</p><p>Object property mapping/copying is one of those things you don't run into all that often, but it is useful to have a simple alternative to hand-writing the code for it. Both the dynamic and static version of the object mappers discussed here are available in my <a href="http://stehno.com/vanilla">Vanilla</a> library.</p></p>
  	
		<a href="blog/2015/lazy-immutable.html"><h1>Lazy Immutables</h1></a>
		<p><em>23 September 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/vanilla.html'>vanilla</a></p>
		<p><p>A co-worker and I were discussing the Groovy <code>@Immutable</code> annotation recently where I was thinking it would be useful if it allowed you to work on the object as a mutable object until you were ready to make it permanent, and then you could "seal" it and make it immutable. This would give you a bit more freedom in how the object is configured - sometimes the standard immutable approach can be overly restrictive.</p><p>Consider the case of of an immutable <code>Person</code> object:</p>
<pre><code class="groovy">@Immutable
class Person {
    String firstName
    String middleName
    String lastName
    int age
}
</code></pre><p>With <code>@Immutable</code> you have to create the object all at once:</p>
<pre><code class="groovy">def person = new Person(&#39;Chris&#39;,&#39;J&#39;,&#39;Stehno&#39;,42)
</code></pre><p>and then you're stuck with it. You can create a copy of it with one or more different properties using the <code>copyWith</code> method, but you need to specify the <code>copyWith=true</code> in the annotation itself, then you can do something like:</p>
<pre><code class="groovy">Person otherPerson = person.copyWith(firstName:&#39;Bob&#39;, age:50)
</code></pre><p>I'm not sure who "Bob J Stehno" is though. With more complicated immutables, this all at once requirement can be annoying. This is where the <code>@LazyImmutable</code> annotation comes in (part of my <a href="http://stehno.com/vanilla/">Vanilla - Core library</a>). With a similar <code>Person</code> class:</p>
<pre><code class="groovy">@LazyImmutable @Canonical
class Person {
    String firstName
    String middleName
    String lastName
    int age
}
</code></pre><p>using the new annotation, you can create and populate the instance over time:</p>
<pre><code class="groovy">def person = new Person(&#39;Chris&#39;)
person.middleName = &#39;J&#39;
person.lastName = &#39;Stehno&#39;
person.age = 42
</code></pre><p>Notice that the <code>@LazyImmutable</code> annotation does not apply any other transforms (as the standard <code>@Immutable</code> does). It's a standard Groovy object, but with an added method: the <code>asImmutable()</code> method is injected via AST Transformation. This method will take the current state of the object and create an immutable version of the object - this does imply that the properties of lazy immutable objects should follow the same rules as those of the standard immutable so that the conversion is determinate. For our example case:</p>
<pre><code class="groovy">Person immutablePerson = person.asImmutable()
</code></pre><p>The created object is the same immutable object as would have been created by using the <code>@Immutable</code> annotation and it is generated as an extension of the class you created so that it's type is still valid. The immutable version of the object also has a useful added method, the <code>asMutable()</code> method is used to create a copy of the original mutable object.</p>
<pre><code class="groovy">Person otherMutable = immutablePerson.asMutable()
</code></pre><p>It's a fairly simple helper annotation, but it just fills one of those little functional gaps that you run into every now and then. Maybe someone else will find it useful.</p></p>
  	
		<a href="blog/2015/baking-with-groovy-and-github.html"><h1>Baking Your Blog with JBake, Groovy and GitHub</h1></a>
		<p><em>02 September 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a></p>
		<p><p>As a developer, it has always bugged me to have my blog or web site content stored on a server managed by someone else, outside of my control. Granted, WordPress and the like are very stable and generally have means of pulling out your data if you need it, but I really just like to have my content under my own control. Likewise, I have other projects I want to work on, so building content management software is not really on my radar at this point; that's where <a href="http://jbake.org">JBake</a> comes in.</p><p>JBake is a simple JVM-based static site generation tool that makes casual blogging quite simple once you get everything set up. It's a bit of a raw project at this point, so there are a few rough edges to work with, but I will help to file them down in the discussions below.</p><p>Getting started with JBake, you have a couple options. You can install JBake locally and use it as a command line tool, or you can use the <a href="https://github.com/jbake-org/jbake-gradle-plugin">JBake Gradle Plugin</a>. The Gradle plugin is currently lacking the local server feature provided by the command line tools; however, it does provide a more portable development environment along with the universe of other Gradle plugins. We will use the Gradle plugin approach here and I will provide some workarounds for the missing features to bring the functionality back on even ground with the command line tool.</p><p>The first thing we need is our base project and for that I am going to use a <a href="https://github.com/pledbrook/lazybones">Lazybones</a> template that I have created (which may be found in my <a href="https://github.com/cjstehno/lazybones-templates">lazybones-templates</a> repository). You can use the Gradle plugin and do all the setup yourself, but it was fairly simple and having a template for it allowed me to add in the missing features we need.</p>
<blockquote><p>If you are unfamiliar with Lazybones, it's a Groovy-based project template framework along the lines of Yeoman and the old Maven Archetype plugin. Details for adding my template repo to your configuration can be found on the <a href="https://github.com/cjstehno/lazybones-templates/blob/master/README.md">README page</a> for my templates.</p>
</blockquote><p>Create the empty project with the following:</p>
<pre><code>lazybones create jbake-groovy cookies
</code></pre><p>where "cookies" is the name of our project and the name of the project directory to be created. You will be asked a few questions related to template generation. You should have something similar to the following:</p>
<pre><code>$ lazybones create jbake-groovy cookies
Creating project from template jbake-groovy (latest) in &#39;cookies&#39;
Define value for &#39;JBake Plugin Version&#39; [0.2]:
Define value for &#39;JBake Version&#39; [2.3.2]:
Define value for &#39;Gradle version&#39; [2.3]:
GitHub project: [username/projectname.git]: cjstehno/cookies.git
</code></pre><p>The "username" should reflect the username of your GitHub account, we'll see what this is used for later. If you look at the generated "cookies" directory now you will see a standard-looking Gradle project structure. The JBake source files reside in the <code>src/jbake</code> directory with the following sub-directories:</p>
<ul>
  <li>assets - this is where your static assets live (CSS files, JavaScript files, images, etc)</li>
  <li>templates - this is where your GSP page templates live</li>
  <li>content - this is where your site content lives (will be applied to the templates)</li>
</ul><p>You will see that by default, a simple Bootstrap-based blog site is provided with sample blog posts in HTML, ASCII Doc, and Markdown formats. This is the same sample content as provided by the command line version of the project setup tool. At this point we can build the sample content using:</p>
<pre><code>./gradlew jbake
</code></pre><p>The Gradle plugin does <em>not</em> provide a means of serving up the "baked" content yet. There is work in progress so hopefully this will be merged in soon. One of the goodies my template provides is a simple Groovy web server script. This allows you to serve up the content with:</p>
<pre><code>groovy serve.groovy
</code></pre><p>which will start a Jetty instance pointed at the content in <code>build/jbake</code> on the configured port (8080 by default, which can be changed by adding a port number to the command line). Now when you hit <code>http://localhost:8080/</code> you should see the sample content. Also, you can leave this server running in a separate console while you develop, running the jbake command as needed to rebuild the content.</p><p>First, let's update the general site information. Our site's title is not "JBake", so let's change it to "JCookies" by updating it in the <code>src/jbake/templates/header.gsp</code> and <code>src/jbake/templates/menu.gsp</code> files. While we're in there we can also update the site meta information as well:</p>
<pre><code class="jsp">&lt;title&gt;&lt;%if (content.title) {%&gt;${content.title}&lt;% } else { %&gt;JCookies&lt;% }%&gt;&lt;/title&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
&lt;meta name=&quot;description&quot; content=&quot;A site about cookies.&quot;&gt;
&lt;meta name=&quot;author&quot; content=&quot;Chris Stehno&quot;&gt;
&lt;meta name=&quot;keywords&quot; content=&quot;cookies,baking&quot;&gt;
&lt;meta name=&quot;generator&quot; content=&quot;JBake&quot;&gt;
</code></pre><p>Then to apply the changes, run <code>./gradlew jbake</code> and refresh the browser. Now we see our correct site name.</p>
<blockquote><p>Note that JBake makes no requirements about the templates or content to be used. It provides special support for blog-style sites; however, you can remove all the content and make a standard simple static site if you wish.</p>
</blockquote><p>Let's add a new blog entry. The blog entries are stored in the <code>src/jbake/content/blog</code> directory by year so we need to create a new directory for <code>2015</code>. Content may be written in HTML, ASCII Doc, or Markdown, based on the file extension. I am a fan of Markdown so we'll use that for our new blog entry. Let's create an entry file named <code>chocolate-chip.md</code>.</p><p>JBake uses a custom header block at the top of content files to store meta information. For our entry we will use the following:</p>
<pre><code>title=Chocolate Chip Cookies
date=2015-05-04
type=post
tags=blog,recipe
status=published
~~~~~~
</code></pre><p>The <code>title</code> and <code>date</code> are self-explanatory. The <code>type</code> can be <code>post</code> or <code>page</code> to denote a blog post or a standard page. The <code>tags</code> are used to provide extra tag information to categorize the content. The <code>status</code> field may be <code>draft</code> or <code>published</code> to denote whether or not the content should be included in the rendered site. Everything below the line of tildes is your standard markdown content.</p><p>For the content of our entry we are going to use the <a href="https://www.verybestbaking.com/recipes/18476/original-nestle-toll-house-chocolate-chip-cookies/">Nestle Chocolate Chip Cookie recipe</a> - it gives us a nice overview of the content capabilities, and they are yummy!</p><p>The content in Markdown format, is as follows:</p>
<pre><code>## Ingredients

* 2 1/4 cups all-purpose flour
* 1 teaspoon baking soda
* 1 teaspoon salt
* 1 cup (2 sticks) butter, softened
* 3/4 cup granulated sugar
* 3/4 cup packed brown sugar
* 1 teaspoon vanilla extract
* 2 large eggs
* 2 cups (12-oz. pkg.) NESTLÉ® TOLL HOUSE® Semi-Sweet Chocolate Morsels
* 1 cup chopped nuts

## Instructions

1. Preheat oven to 375° F.
1. Combine flour, baking soda and salt in small bowl. Beat butter, granulated sugar, brown sugar and vanilla extract in large mixer bowl until creamy. Add eggs, one at a time, beating well after each addition. Gradually beat in flour mixture. Stir in morsels and nuts. Drop by rounded tablespoon onto ungreased baking sheets. 
1. BAKE for 9 to 11 minutes or until golden brown. Cool on baking sheets for 2 minutes; remove to wire racks to cool completely. 

May be stored in refrigerator for up to 1 week or in freezer for up to 8 weeks.
</code></pre><p>Rebuild/refresh and now you see we have a new blog post. Now, since we <strike>stole</strike>borrowed this recipe from another site, we should provide an attribution link back to the original source. The content header fields are dynamic; you can create your own and use them in your pages. Let's add an <code>attribution</code> field and put our link in it.</p>
<pre><code>attribution=https://www.verybestbaking.com/recipes/18476/original-nestle-toll-house-chocolate-chip-cookies/
</code></pre><p>Then we will want to add it to our rendered page, so we need to open up the blog entry template, the <code>src/jbake/templates/post.gsp</code> file and add the following line after the page header:</p>
<pre><code class="html">&lt;p&gt;Borrowed from: &lt;a href=&quot;${content.attribution}&quot;&gt;${content.attribution}&lt;/a&gt;&lt;/p&gt;
</code></pre><p>Notice now, that the templates are just GSP files which may have Groovy code embedded into them in order to perform rendering logic. The header data is accessible via the <code>content</code> object in the page.</p><p>This post is kind of boring at this point. Yes, it's a recipe for chocolate chip cookies, and that's hard to beat, but the page full of text is not selling it to me. Let's add a photo to really make your mouth water. Grab an image of your favorite chocolate chip cookies and save it in <code>src/jbake/assets/images</code> as <code>cookies.jpg</code>. Static content like images live in the <code>assets</code> folder. The contents of the assets folder will be copied into the root of the rendered site directory.</p><p>Now, we need to add the photo to the page. Markdown allows simple HTML tags to be used so we can add:</p>
<pre><code class="html">&lt;img src=&quot;/images/cookies.jpg&quot; style=&quot;width:300px;float:right;&quot;/&gt;
</code></pre><p>to the top of our blog post content, which will add the image at the top of the page, floated to the right of the main content text. Now that looks tasty!</p><p>You can also create tandard pages in a similar manner to blog posts; however, they are based on the <code>page.gsp</code> template. This allows for different contextual formatting for each content type.</p><p>You can customize any of the templates to get the desired content and functionality for your static site, but what about the overall visual theme? As I mentioned earlier, the default templates use the Twitter Bootstrap library and there are quite a few resources available for changing the theme to fit your needs and they range from free to somewhat expensive. We just want a free one for demonstration purposes so let's download the <code>bootstrap.min.css</code> file for the <a href="https://bootswatch.com/cerulean/">Bootswatch Cerulean</a> theme. Overwrite the existing theme in the <code>src/jbake/assets/css</code> directory with this new file then rebuild the site and refresh your browser. Now you can see that we have a nice blue banner along with other style changes.</p><p>The end result at this point will look something like this:</p>
<div style="text-align:center;margin-bottom:15px;"><img src="/images/cookiesblog.png"/></div><p>All-in-all not too bad for a few minutes of coding work!</p><p>Another nice feature of JBake is delayed publishing. The <code>status</code> field in the content header has three accepted values:</p>
<ul>
  <li>published - the content will be rendered and listed in the list of available pages.</li>
  <li>draft - the content will be rendered, but with a "-draft" suffix added to the file name. The content will not appear in the list of available pages.</li>
  <li>published-date - the content will be rendered normally, but will not appear in the list of available pages until the site is built after the value of its <code>date</code> field has passed.</li>
</ul><p>We used the <code>published</code> option since we wanted our content to be available right away. You could easily create a bunch of blog entries ahead of time, specifying the <code>date</code> values for when they should be published but having the <code>status</code> values set to <code>published-date</code> so that they are released only after the appropriate date. The downside of this is that since JBake is a static generator, you would have to be sure and build the site often enough to pick up the newly available content - maybe with a nightly scheduled build and deployment job.</p><p>When you are ready to release your site out into the greater internet wilderness, you will need a way to publish it; this is another place where my lazybones template comes in handy. If you are hosting your site as <a href="https://pages.github.com/">github-pages</a>, the template comes with a publishing task built-in, based on the gradle-git plugin. This is where the GitHub username and repository information from the initial project creation comes into play. For this to work, you need a repository named "cookies" associated with your GitHub account. You will also want to double check that the repo clone URL is correct in the <code>publish.gradle</code> file. Then, to publish your site you simply run:</p>
<pre><code>./gradlew publish
</code></pre><p>and then go check your project site for the updated content (sometimes it takes a minute or two, though it's usually instantaneous).</p><p>At this point we have a easily managed static web site; what's left to be done? Well, you could associate it with your own custom domain name rather than the one GitHub provides. I will not go into that here, since I really don't want to purchase a domain name just for this demo; however, I do have a blog post (<a href="http://coffeaelectronica.com/blog/2015/custom-github-hosting.html">Custom GitHub Hosting</a>) that goes into how it's done (at least on GoDaddy).</p><p>JBake and GitHub with a dash of Groovy provide a nice environment for quick custom blogs and web sites, with little fuss. Everything I have shown here is what I use to create and manage this blog, so, I'd say it works pretty well.</p>
<blockquote><p>Portions of this discussion are based on a blog post by Cédric Champeau, "<a href="http://melix.github.io/blog/2014/02/hosting-jbake-github.html">Authoring your blog on GitHub with JBake and Gradle</a>", who is also a contributor to JBake (among other things). </p>
</blockquote></p>
  	
		<a href="blog/2015/test-fixtures.html"><h1>Vanilla Test Fixtures</h1></a>
		<p><em>15 May 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/testing.html'>testing</a>, <a href='/tags/vanilla.html'>vanilla</a></p>
		<p><p>Unit testing with data fixtures is good practice to get into, and having a simple means of creating and managing reusable fixture data makes it much more likely. I have added a <code>FixtureBuilder</code> and <code>Fixture</code> class to my <a href="http://github.com/cjstehno/vanilla">Vanilla-Testing</a> library.</p><p>Unit testing with domain object, entities and DTOs can become tedious and you can end up with a lot of duplication around creating the test fixtures for each test. Say you have an object, <code>Person</code> defined as:</p>
<pre><code class="groovy">class Person {
    Name name
    LocalDate birthDate
    int score
}
</code></pre><p>You are writing your unit tests for services and controllers that may need to create and compare various instances of <code>Person</code> and you end up with some constants somewhere or duplication of code with custom instances all over the test code.</p><p>Using <code>com.stehno.vanilla.test.FixtureBuilder</code> you can create reusable fixtures with a simple DSL. I tend to create a main class to contain my fixtures and to also provide the set of supported fixture keys, something like:</p>
<pre><code class="groovy">class PersonFixtures {

    static final String BOB = &#39;Bob&#39;
    static final String LARRY = &#39;Larry&#39;
    
    static final Fixture FIXTURES = define {
        fix BOB, [ name:new Name(&#39;Bob&#39;,&#39;Q&#39;,&#39;Public&#39;), birthDate:LocalDate.of(1952,5,14), score:120 ]
        fix LARRY, [ name:new Name(&#39;Larry&#39;,&#39;G&#39;,&#39;Larson&#39;), birthDate:LocalDate.of(1970,2,8), score:100 ]
    }
}
</code></pre><p>Notice that the <code>define</code> method is where you create the data contained by the fixtures, each mapped with an object key. The key can be any object which may be used as a Map key (proper <code>equals</code> and <code>hashCode</code> implementation).</p><p>The reasoning behind using Maps is that Groovy allows them to be used as constructor arguments for creating objects; therefore, the maps give you a reusable and detached dataset for use in creating your test fixture instances. Two objects instances created from the same fixture data will be equivalent at the level of the properties defined by the fixture; however, each can be manipulated without effecting the other.</p><p>Once your fixtures are defined, you can use them in various ways. You can request the immutable data map for a fixture:</p>
<pre><code>Map data = PersonFixtures.FIXTURES.map(PersonFixtures.BOB)
</code></pre><p>You can create an instance of the target object using the data mapped to a specified fixture:</p>
<pre><code>Person person = PersonFixtures.FIXTURES.object(Person, PersonFixtures.LARRY)
</code></pre><p>Or, you can request the data or an instance for a fixture while applying additional (or overridden) properties to the fixture data:</p>
<pre><code>Map data = PersonFixtures.FIXTURES.map(PersonFixtures.BOB, score:53)
Person person = PersonFixtures.FIXTURES.object(Person, PersonFixtures.LARRY, score:200)
</code></pre><p>You can easily retrieve field property values for each fixture for use in your tests:</p>
<pre><code>assert 100 == PersonFixtures.FIXTURES.field(&#39;score&#39;, PersonFixtures.LARRY)
</code></pre><p>This allows field-by-field comparisons for testing and the ability to use the field values as parameters as needed.</p><p>Lastly, you can verify that an object instance contains the expected data that is associated with a fixture:</p>
<pre><code>assert PersonFixtures.FIXTURES.verify(person, PersonFixtures.LARRY)
</code></pre><p>which will compare the given object to the specified fixture and return true of all of the properties defined in the fixture match the same properties of the given object. There is also a second version of the method which allows property customizations before comparison.</p><p>One step farther... you can combine fixtures with <a href="http://coffeaelectronica.com/blog/2015/property-randomization.html">property randomizaiton</a> to make fixture creation even simpler for those cases where you don't care about what the properties are, just that you can get at them reliably.</p>
<pre><code class="groovy">static final Fixture FIXTURES = define {
    fix FIX_A, [ name:randomize(Name).one(), birthDate:LocalDate.of(1952,5,14), score:120 ]
    fix FIX_B, randomize(Person){
        typeRandomizers(
            (Name): randomize(Name),
            (LocalDate): { LocalDate.now() }
        )
    }
}
</code></pre><p>The fixture mapper accepts <code>PropertyRandomizer</code> instances and will use them to generate the random content once, when the fixture is created and then it will be available unchanged during the testing.</p><p>One thing to note about the fixtures is that the fixture container and the maps that are passed in as individual fixture data are all made immutable via the <code>asImmutable()</code> method; however, if the data inside the fixture is mutable, it still may have the potential for being changed. Be aware of this and take proper precautions when you create an interact with such data types.</p><p>Reusable text fixtures can really help to clean up your test code base, and they are a good habit to get into.</p></p>
  	
		<a href="blog/2015/property-randomization.html"><h1>Property Randomization for Testing</h1></a>
		<p><em>06 May 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/vanilla.html'>vanilla</a></p>
		<p><p>Unit tests are great, but sometimes you end up creating a lot of test objects requiring data, such as DTOs and domain objects. Generally, I have always come up with movie quotes or other interesting content for test data. Recently, while working on a Groovy project, I thought it would be interesting to have a way to randomly generate and populate the data for these objects. The randomization would provide a simpler approach to test data as well as providing the potential for stumbling on test data that would break your code in interesting ways.</p><p>My <a href="http://github.com/cjstehno/vanilla">Vanilla</a> project now has a <code>PropertyRandomizer</code> class, which provides this property randomization functionality in two ways. You can use it as a builder or as a DSL.</p><p>Say you have a <code>Person</code> domain class, defined as:</p>
<pre><code class="groovy">@ToString
class Person {
    String name
    Date birthDate
}
</code></pre><p>You could generate a random instance of it using:</p>
<pre><code class="groovy">def rando = randomize(Person).typeRandomizers( (Date):{ new Date() } )
def instance = rando.one()
</code></pre><p>Note, that there is no default randomizer for <code>Date</code> so we had to provide one. The other fields, <code>name</code> in this case would be randomized by the default randomizer.</p><p>The DSL usage style for the use case above would be:</p>
<pre><code class="groovy">def rando = randomize(Person){
    typeRandomizers( 
        (Date):{ new Date() } 
    )
}
def instance = rando.one()
</code></pre><p>Not really much difference, but sometimes a DSL style construct is cleaner to work with.</p><p>What if you need three random instances for the same class, all different? You just ask for them:</p>
<pre><code class="groovy">def instances = rando.times(3)

// or 

instances = rando * 3
</code></pre><p>The multiplication operator is overridden to provide a nice shortcut for requesting multiple random instances.</p><p>You can customize the randomizers at either the type or property level or you can configure certain properties to be ignored by the randomization. This allows for nested randomized objects. Say your <code>Person</code> has a new <code>pet</code> property.</p>
<pre><code class="groovy">@ToString
class Person {
    String name
    Date birthDate
    Pet pet
}

@ToString
class Pet {
    String name
}
</code></pre><p>You can easily provide randomized pets for your randomized people:</p>
<pre><code class="groovy">def rando = randomize(Person){
    typeRandomizers( 
        (Date):{ new Date() },
        (Pet): { randomize(Pet).one() }
    )
}
def instance = rando.one()
</code></pre><p>I have started using this in some of my testing, at it comes in pretty handy. My Vanilla library is not yet available via any public repositories; however, it will be soon, and if there is expressed interest, I can speed this up.</p></p>
  	
		<a href="blog/2015/secure-rest-spring.html"><h1>Secure REST in Spring</h1></a>
		<p><em>04 May 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a></p>
		<p><p>Getting HTTPS to play nice with REST and non-browser web clients in development (with a self-signed certificate) can be a frustrating effort. I struggled for a while down the path of using the Spring <code>RestTemplate</code> thinking that since I was using Spring MVC as my REST provider, it would make things easier; in this case, Spring did not come to the rescue, but Groovy did or rather the Groovy <a href="https://github.com/jgritman/httpbuilder">HTTPBuilder</a> did.</p><p>To keep this discussion simple, we need a simple REST project using HTTPS. I found the <a href="https://github.com/spring-guides/gs-rest-service">Spring REST Service Guide</a> project useful for this (with a few modifications to follow).</p><p>Go ahead and clone the project:</p>
<pre><code>git clone git@github.com:spring-guides/gs-rest-service.git
</code></pre><p>Since this is a tutorial project, it has a few versions of the code in it. We are going to work with the "complete" version, which is a Gradle project. Let's go ahead and do a build and run just to ensure everything works out of the box:</p>
<pre><code>cd gs-rest-service/complete
./gradlew bootRun
</code></pre><p>After a bunch of downloading and startup logging you should see that the application has started. You can give it a test by opening <code>http://localhost:8080/greeting?name=Chris</code> in your browser, which should respond with:</p>
<pre><code class="json">{
    &quot;id&quot;: 2,
    &quot;content&quot;: &quot;Hello, Chris!&quot;
}
</code></pre><p>Now that we have that running, we want a RESTful client to call it rather that hitting it using the browser. Let's get it working with the simple HTTP case first to ensure that we have everything working before we go into the HTTPS configuration. Create a groovy script, <code>rest-client.groovy</code> with the following content:</p>
<pre><code class="groovy">@Grapes(
    @Grab(group=&#39;org.codehaus.groovy.modules.http-builder&#39;, module=&#39;http-builder&#39;, version=&#39;0.7.1&#39;)
)

import groovyx.net.http.HTTPBuilder
import static groovyx.net.http.Method.GET

def http = new HTTPBuilder( &#39;http://localhost:8080/&#39; )

http.get( path: &#39;greeting&#39;, query:[name:&#39;Chris&#39;] ) { resp, json -&gt;
    println &quot;Status: ${resp.status}&quot;
    println &quot;Content: $json&quot;
}
</code></pre><p>Since this is not a discussion of HTTPBuilder itself, I will leave most of the details to your own research; however, it's pretty straight forward. We are making the same request we made in the browser, and after another initial batch of dependency downloads (grapes) it should yield:</p>
<pre><code>Status: 200
Content: [content:Hello, Chris!, id:6]
</code></pre><p>Ok, our control group is working. Now, let's add in the HTTPS. For the Spring Boot project, it's pretty trivial. We need to add an <code>application.properties</code> file in <code>src/main/resources</code> with the following content:</p>
<pre><code>server.port = 8443
server.ssl.key-store = /home/cjstehno/.keystore
server.ssl.key-store-password = tomcat
server.ssl.key-password = tomcat
</code></pre><p>Of course, update the key-store path to your home directory. For the server, we also need to install a certificate for our use. </p>
<blockquote><p>I am not a security certificate expert, so from here on out I will state that this stuff works in development but I make no claims that this is suitable for production use. Proceed at your own risk!</p>
</blockquote><p>From the <a href="http://tomcat.apache.org/tomcat-8.0-doc/ssl-howto.html">Tomcat 8 SSL How To</a>, run the <code>keytool -genkey -alias tomcat -keyalg RSA</code> and run through the questions answering everything with 'localhost' (there seems to be a reason for this).</p><p>At this point you should be able to restart the server and hit it via HTTPS (<a href="https://localhost:8443/greeting?name=Chris">https://localhost:8443/greeting?name=Chris</a>) to retrieve a successful response as before, though you will need to accept the self-signed certificate.</p><p>Now try the client. Update the URL to the new HTTPS version:</p>
<pre><code>def http = new HTTPBuilder( &#39;https://localhost:8443/&#39; )
</code></pre><p>and give it a run. You should see something like:</p>
<pre><code>Caught: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated
javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated
</code></pre><p>I will start with the simplest method of resolving this problem. HTTPBuilder provides a configuration method that will just ignore these types of SSL errors. If you add:</p>
<pre><code>http.ignoreSSLIssues()
</code></pre><p>before you make a request, it will succeed as normal. This should be used only as a development configuration, but there are times when you just want to get something workign for testing. If that's all you want here, you're done. From here on out I will show how to get the SSL configuration working for a more formal use case.</p><p>Still with me? Alright, let's have fun with certificates! The <a href="https://github.com/jgritman/httpbuilder/wiki/SSL">HTTPBuilder wiki page for SSL</a> gives us most of what we need. To summarize, we need to export our server certificate and then import it into a keyfile that our client can use. To export the server certificate, run:</p>
<pre><code>keytool -exportcert -alias &quot;tomcat&quot; -file mytomcat.crt -keystore ~/.keystore -storepass tomcat
</code></pre><p>which will export the "tomcat" certificate from the keystore at "~/.keystore" (the one we created earlier) and save it into "mytomcat.crt". Next, we need to import this certificate into the keystore that will be used by our client as follows:</p>
<pre><code>keytool -importcert -alias &quot;tomcat&quot; -file mytomcat.crt -keystore clientstore.jks -storepass clientpass
</code></pre><p>You will be asked to trust this certificate, which you should answer "yes" to continue.</p><p>Now that we have our certificate ready, we can update the client script to use it. The client script becomes:</p>
<pre><code class="groovy">@Grapes(
    @Grab(group=&#39;org.codehaus.groovy.modules.http-builder&#39;, module=&#39;http-builder&#39;, version=&#39;0.7.1&#39;)
)

import groovyx.net.http.HTTPBuilder
import static groovyx.net.http.Method.GET
import java.security.KeyStore
import org.apache.http.conn.scheme.Scheme
import org.apache.http.conn.ssl.SSLSocketFactory

def http = new HTTPBuilder( &#39;https://localhost:8443/&#39; )

def keyStore = KeyStore.getInstance( KeyStore.defaultType )

new File( args[0] ).withInputStream {
   keyStore.load( it, args[1].toCharArray() )
}

http.client.connectionManager.schemeRegistry.register(new Scheme(&quot;https&quot;, new SSLSocketFactory(keyStore), 443) )

http.get( path: &#39;greeting&#39;, query:[name:&#39;Chris&#39;] ) { resp, json -&gt;
    println &quot;Status: ${resp.status}&quot;
    println &quot;Content: $json&quot;
}
</code></pre><p>The main changes from the previous version are the loading and use of the keystore by the connection manager. When you run this version of the script, with:</p>
<pre><code>groovy rest-client.groovy clientstore.jks clientpass
</code></pre><p>you get:</p>
<pre><code>Status: 200
Content: [content:Hello, Chris!, id:1]
</code></pre><p>We are now using HTTPS on both the server and client for our rest service. It's not all that bad to setup once you figure out the steps, but in general the information seems to be tough to find.</p></p>
  	
		<a href="blog/2015/tour-de-mock-6-spock.html"><h1>Tour de Mock 6: Spock</h1></a>
		<p><em>09 April 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/testing.html'>testing</a></p>
		<p><p>My last entry in my "Tour de Mock" series was focused on basic <a href="http://coffeaelectronica.com/blog/2010/tour-de-mock-5.html">Groovy mocking</a>. In this post, I am going to take a look at the <a href="https://code.google.com/p/spock/">Spock Framework</a>, which is an alternative testing framework with a lot of features, including its own mocking API.</p><p>Since it's been a while, let's refer back to the <a href="http://coffeaelectronica.com/blog/2009/tour-de-mock-1.html">original posting</a> as a refresher of what is being tested. We have a <code>Servlet</code>, the <code>EmailListServlet</code> </p>
<pre><code class="groovy">public class EmailListServlet extends HttpServlet {

    private EmailListService emailListService;

    public void init() throws ServletException {
        final ServletContext servletContext = getServletContext();
        this.emailListService = (EmailListService)servletContext.getAttribute(EmailListService.KEY);

        if(emailListService == null) throw new ServletException(&quot;No ListService available!&quot;);
    }

    protected void doGet(final HttpServletRequest req, final HttpServletResponse res) throws ServletException, IOException {
        final String listName = req.getParameter(&quot;listName&quot;);
        final List&lt;String&gt; list = emailListService.getListByName(listName);
        PrintWriter writer = null;
        try {
            writer = res.getWriter();
            for(final String email : list){
                writer.println(email);
            }
        } finally {
            if(writer != null) writer.close();
        }
    }
}
</code></pre><p>which uses an <code>EmailListService</code></p>
<pre><code class="groovy">public interface EmailListService {

    public static final String KEY = &quot;com.stehno.mockery.service.EmailListService&quot;;

    /**
     * Retrieves the list of email addresses with the specified name. If no list
     * exists with that name an IOException is thrown.
     */
    List&lt;String&gt; getListByName(String listName) throws IOException;
}
</code></pre><p>to retrieve lists of email addresses, because that's what you do, right? It's just an example. :-)</p><p>First, we need to add Spock to our build (recently converted to Gradle, but basically the same) by adding the following line to the <code>build.gradle</code> file:</p>
<pre><code>testCompile &quot;org.spockframework:spock-core:1.0-groovy-2.4&quot;
</code></pre><p>Next, we need a test class. Spock uses the concept of a test "Specification" so we create a simple test class as:</p>
<pre><code class="groovy">class EmailListServlet_SpockSpec extends Specification {
    // test stuff here...
}
</code></pre><p>Not all that different from a JUnit test; conceptually they are very similar.</p><p>Just as in the other examples of testing this system, we need to setup our mock objects for the servlet environment and other collaborators:</p>
<pre><code class="groovy">def setup() {
    def emailListService = Mock(EmailListService) {
        _ * getListByName(null) &gt;&gt; { throw new IOException() }
        _ * getListByName(&#39;foolist&#39;) &gt;&gt; LIST
    }

    def servletContext = Mock(ServletContext) {
        1 * getAttribute(EmailListService.KEY) &gt;&gt; emailListService
    }

    def servletConfig = Mock(ServletConfig) {
        1 * getServletContext() &gt;&gt; servletContext
    }

    emailListServlet = new EmailListServlet()
    emailListServlet.init servletConfig

    request = Mock(HttpServletRequest)
    response = Mock(HttpServletResponse)
}
</code></pre><p>Spock provides a <code>setup</code> method that you can override to perform your test setup operations, such as mocking. In this example, we are mocking the service interface, and the servlet API interfaces so that they behave in the deisred manner.</p><p>The mocking provided by Spock took a little getting used to when coming from a primarily mockito-based background, but once you grasp the overall syntax, it's actually pretty expressive. In the code above for the <code>EmailListService</code>, I am mocking the <code>getListByName(String)</code> method such that it will accept any number of calls with a <code>null</code> parameter and throw an exception, as well as any number of calls with a <code>foolist</code> parameter which will return a reference to the email address list. Similarly, you can specify that you expect only N calls to a method as was done in the other mocks. You can dig a little deeper into the mocking part of the framework in the <a href="http://spockframework.github.io/spock/docs/1.0/interaction_based_testing.html">Interaction-based Testing</a> section of the Spock documentation.</p><p>Now that we have our basic mocks ready, we can test something. As in the earlier examples, we want to test the condition when no list name is specified and ensure that we get the expected <code>Exception</code> thrown:</p>
<pre><code class="groovy">def &#39;doGet: without list&#39;() {
    setup:
    1 * request.getParameter(&#39;listName&#39;) &gt;&gt; null

    when:
    emailListServlet.doGet request, response

    then:
    thrown(IOException)
}
</code></pre><p>One thing you should notice right away is that Spock uses label blocks to denote different parts of a test method. Here, the <code>setup</code> block is where we do any additional mocking or setup specific to this test method. The <code>when</code> block is where the actual operations being tested are performed while the <code>then</code> block is where the results are verified and conditions examined.</p><p>In our case, we need to mock out the reuest parameter to return <code>null</code> and then we need to ensure that an <code>IOException</code> is thrown.</p><p>Our other test is the case when a valid list name is provided:</p>
<pre><code class="groovy">def &#39;doGet: with list&#39;() {
    setup:
    1 * request.getParameter(&#39;listName&#39;) &gt;&gt; &#39;foolist&#39;

    def writer = Mock(PrintWriter)

    1 * response.getWriter() &gt;&gt; writer

    when:
    emailListServlet.doGet request, response

    then:
    1 * writer.println(LIST[0])
    1 * writer.println(LIST[1])
    1 * writer.println(LIST[2])
}
</code></pre><p>In the <code>then</code> block here, we verify that the <code>println(String)</code> method of the mocked <code>PrintWriter</code> is called with the correct arguments in the correct order.</p><p>Overall, Spock is a pretty clean and expressive framework for testing and mocking. It actually has quite a few other interesting features that beg to be explored.</p>
<blockquote><p>You can find the source code used in this posting in my <a href="http://github.com/cjstehno/coffeaelectronica/tree/master/tourdemock">TourDeMock</a> project.</p>
</blockquote></p>
  	
		<a href="blog/2015/ast-testing.html"><h1>Testing AST Transformations</h1></a>
		<p><em>08 March 2015</em> ~ <a href='/tags/blog.html'>blog</a>, <a href='/tags/groovy.html'>groovy</a>, <a href='/tags/testing.html'>testing</a>, <a href='/tags/vanilla.html'>vanilla</a></p>
		<p><p>While working on my <a href="https://github.com/cjstehno/effigy">Effigy</a> project, I have gone deep into the world of Groovy AST Transformations and found that they are, in my opinion, the most interesting and useful feature of the Groovy language; however, developing them is a bit of a poorly-documented black art, especially around writing unit tests for your transformations. Since the code you are writing is run at compile-time, you generally have little access or view to what is going on at that point and it can be quite frustrating to try and figure out why something is failing.</p><p>After some Googling and experimentation, I have been able to piece together a good method for testing your transformation code, and it's actually not all that hard. Also, you can do your development and testing in a single project, rather than in a main project and testing project (to account for the need to compile the code for testing)</p><p>The key to making transforms testable is the <code>GroovyClassLoader</code> which gives you the ability to compile Groovy code on the fly:</p>
<pre><code>def clazz = new GroovyClassLoader().parseClass(sourceCode)
</code></pre><p>During that <code>parseClass</code> method is when all the AST magic happens. This means you can not only easily test your code, but also debug into your transformations to get a better feel for what is going wrong when things break - and they often do.</p><p>For my testing, I have started building a <code>ClassBuilder</code> code helper that is a shell for String-based source code. You provide a code template that acts as your class shell, and then you inject code for your specific test case. You end up with a reasonably clean means of building test code and instantiating it:</p>
<pre><code class="groovy">private final ClassBuilder code = forCode(&#39;&#39;&#39;
    package testing

    import com.stehno.ast.annotation.Counted

    class CountingTester {
        $code
    }
&#39;&#39;&#39;)

@Test void &#39;single method&#39;(){
    def instance = code.inject(&#39;&#39;&#39;
        @Counted
        String sayHello(String name){
            &quot;Hello, $name&quot;
        }
    &#39;&#39;&#39;).instantiate()

    assert instance.sayHello(&#39;AST&#39;) == &#39;Hello, AST&#39;
    assert instance.getSayHelloCount() == 1

    assert instance.sayHello(&#39;Counting&#39;) == &#39;Hello, Counting&#39;
    assert instance.getSayHelloCount() == 2
}
</code></pre><p>The <code>forCode</code> method creates the builder and prepares the code shell. This construct may be reused for each of your tests.</p><p>The <code>inject</code> method adds in the actual code you care about, meaning your transformation code being tested.</p><p>The <code>instantiate</code> method uses the <code>GroovyClassLoader</code> internally to load the class and then instantiate it for testing.</p><p>I am going to add a version of the <code>ClassBuilder</code> to my <a href="https://github.com/cjstehno/vanilla">Vanilla</a> project once it is more stable; however, I have a version of it and a simple AST testing demo project in the <a href="https://github.com/cjstehno/coffeaelectronica/tree/master/ast-testing">ast-testing</a> CoffeaElectronica sub-repo. This sample code builds a simple AST Transformation for counting method invocations and writes normal unit tests for it (the code above is taken from one of the tests).</p>
<blockquote><p>Note: I have recently discovered the <a href="http://docs.groovy-lang.org/latest/html/gapi/org/codehaus/groovy/tools/ast/TransformTestHelper.html">groovy.tools.ast.TransformTestHelper</a> class; I have not yet tried it out, but it seems to provide a similar base functionality set to what I have described here.</p>
</blockquote></p>
  	
	
	<hr />
	
	<p>Older posts are available in the <a href="/archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2015 <a href="https://plus.google.com/+ChristopherStehno">Christopher J. Stehno</a> | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-27165855-1', 'auto');
      ga('send', 'pageview');
    </script>
    
  </body>
</html>