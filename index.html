<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CoffeaElectronica.com</title>

    <meta name="description" content="A technical blog.">
    <meta name="author" content="Christopher J. Stehno">
    <meta name="keywords" content="java,groovy,blog">
    <meta name="generator" content="JBake">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/asciidoctor.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/favicon.ico">
</head>

<body onload="prettyPrint()">

<div class="container-fluid">

    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <img src="/images/coffee-banner.jpg" class="img-responsive" />
        </div>
    </div>

    <nav class="navbar navbar-inverse" style="margin-bottom: 2px;">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/index.html">&nbsp;CoffeaElectronica</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/archive.html" title="Archives"><span class="glyphicon glyphicon-calendar"></span></a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" title="Tags"><span class="glyphicon glyphicon-tags"></span> <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            
                                    <li><a href="/tags/ant.html">ant</a></li>
                            
                                    <li><a href="/tags/blog.html">blog</a></li>
                            
                                    <li><a href="/tags/gradle.html">gradle</a></li>
                            
                                    <li><a href="/tags/groovy.html">groovy</a></li>
                            
                                    <li><a href="/tags/java.html">java</a></li>
                            
                                    <li><a href="/tags/javascript.html">javascript</a></li>
                            
                                    <li><a href="/tags/maven.html">maven</a></li>
                            
                                    <li><a href="/tags/python.html">python</a></li>
                            
                                    <li><a href="/tags/spring.html">spring</a></li>
                            
                                    <li><a href="/tags/testing.html">testing</a></li>
                            
                                    <li><a href="/tags/vanilla.html">vanilla</a></li>
                            
                        </ul>
                    </li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://stehno.com" title="Web Site" target="_blank"><span class="glyphicon glyphicon-user"></span></a></li>
                    <li><a href="http://github.com/cjstehno" title="Projects" target="_blank"><span class="glyphicon glyphicon-wrench"></span></a></li>
                    <li><a href="/feed.xml" title="Feed"><span class="glyphicon glyphicon-bullhorn"></span></a></li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>


	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2017/fuzzy-matching.html">Fuzzy Text Matching</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 12 January 2017</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a>
                <p><div class="paragraph">
<p>From time to time I have needed to find matching text data based on some user input data, for example given a list of known company names, return a list of potential matches to a company name entered by the user - or for our example here: given a list of people&#8217;s first names, find the best matches to the user-provided name. Yes, there are tools, libraries and frameworks to do this in really efficient ways and in large volume, but if you are not already using them and if this is the only such problem you have to solve, it&#8217;s better to have a simple solution that works well-enough without adding bulk to your application.</p>
</div>
<div class="paragraph">
<p>As I mentioned above, let&#8217;s say we have a list of first names - I collected 100 from a <a href="http://listofrandomnames.com/index.cfm?textarea">random name generator site</a> and put them in a text file (a sample is shown below):</p>
</div>
<div class="listingblock">
<div class="title">names.txt</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-text" data-lang="text">Sona
Terisa
Shasta
Jerold
Joetta
Harrison
Earle
Isaiah
Torrie
Valarie
Lynell
Mignon
Sharla
Kiesha
Art</code></pre>
</div>
</div>
<div class="paragraph">
<p>When given a name, such as "Harry", how can we filter the list of names to provide the best matches? I have found the <a href="http://commons.apache.org/proper/commons-lang/javadocs/api-release/org/apache/commons/lang3/StringUtils.html#getJaroWinklerDistance-java.lang.CharSequence-java.lang.CharSequence-">getJaroWinklerDistance</a> in the <a href="http://commons.apache.org/proper/commons-lang">Apache Commons Lang</a> <code>StringUtils</code> class to be quite useful. It&#8217;s a string similarity algorithm that returns a <code>double</code> similarity result given two strings - the larger the number, the better the match.</p>
</div>
<div class="paragraph">
<p>With that you can load the names into a collection and process each of them against your given name to find the best <code>N</code> results (let&#8217;s say 10). The script is as follows:</p>
</div>
<div class="listingblock">
<div class="title">find_name.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Grapes(
    @Grab('org.apache.commons:commons-lang3:3.5')
)

import static org.apache.commons.lang3.StringUtils.getJaroWinklerDistance

def query = args[0].toLowerCase()
def names = new File('./names.txt').readLines().unique()*.toLowerCase()

println "Searching for: ${query}\n"
println 'Name           Score'
println '--------------------'

names.collect { n-&gt;
    new Tuple(n, getJaroWinklerDistance(n, query))
}.sort { -it.get(1) }[0..10].each { r-&gt;
    println "${r.get(0).padRight(15)}${r.get(1)}"
}
println ''</code></pre>
</div>
</div>
<div class="paragraph">
<p>If I run this against the set of 100 names I used, I get the following result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; groovy find_name.groovy Harry
Searching for: harry

Name           Score
--------------------
harrison       0.86
gary           0.78
sharla         0.7
darrin         0.7
art            0.69
margart        0.68
maryellen      0.64
sari           0.63
hana           0.63
earle          0.6
shana          0.6</pre>
</div>
</div>
<div class="paragraph">
<p>We see that there is actually a pretty good match, "Harrison", and even "Gary" for that matter. I have used this method to provide a list of suggestions back to the user so that they can make the final selection from them (being the list of items actually available in your system).</p>
</div>
<div class="paragraph">
<p>It&#8217;s an interesting technique and I am sure that there are better ways - feel free to suggest them.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/introducing-ersatz.html">Introducing Ersatz</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 10 December 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/testing.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> testing</span></a>
                <p><div class="paragraph">
<p>While working on tests for the <a href="https://http-builder-ng.github.io/http-builder-ng/">HttpBuilder-NG</a> project, I tried out a couple different mock server
libraries, my old go-to <a href="http://www.mock-server.com/">Mock Server</a> and then the
<a href="https://github.com/square/okhttp/tree/master/mockwebserver">OkHttp Mock Server</a>, but both had their own issues and just didn&#8217;t really fit the bill for
what I wanted to be able to do with mock server testing. So, I decided to do some prototyping over a long weekend and I was able to come up with the
<a href="http://stehno.com/ersatz/">Ersatz Server</a>.</p>
</div>
<div class="paragraph">
<p>My goal was to use an standardized embedded HTTP server and then provide a rich DSL to configure expectations on it with all the bells and whistles of
any other mocking library. I used the <a href="http://undertow.io">Undertow</a> web server with both a Java 8 chained builder and a Groovy DSL approach to
configuration to allow very simple and expressive expectation configuration.</p>
</div>
<div class="paragraph">
<p>With the Groovy DSL you can define expectations such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ErsatzServer ersatz = new ErsatzServer()

server.expectations {
    get('/say/hello'){
        verifier once()
        query 'name','Ersatz'
        responder {
            content 'Hello Ersatz','text/plain'
        }
    }
}

ersatz.start()

URL url = "${ersatz.serverUrl}/say/hello?name=Ersatz".toURL()
assert url.text == 'Hello Ersatz'

assert ersatz.verify()

ersatz.stop()</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will respond to a <code>GET</code> request to <code>/say/hello?name=Ersatz</code> with the text content <code>Hello Ersatz</code> and it will be expected that this request is
called exactly once, or the <code>verify()</code> call will fail. This could also be written in standard Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">server.expectations( expect -&gt; {
    expect.get("/say/hello").verifier(once()).query("name","Ersatz").responds().content("Hello Ersatz","text/plain");
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The builder form and the DSL form are equivalent and may be used together when developing in Groovy.</p>
</div>
<div class="paragraph">
<p>Expectations can be configured across the major HTTP request methods and can be matched by path as well as headers, cookies, body contents and other
custom conditions. Multiple responses may be configured on a request so, for example, the first call would respond with some value, but all subsequent
calls would respond with a 500 error status, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">server.expectations {
    post('/save'){
        body data, 'application/json'
        responder {
            content outdata, 'application/json'
        }
        responder {
            code 500
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows for some interesting and flexible configuration options.</p>
</div>
<div class="paragraph">
<p>It&#8217;s a new library but I have replaced the mock server code in HttpBuilder-NG with it and it makes the tests a bit cleaner and adds some nice features
that we can utilize going forward that were not present in the other mock server libraries. Give it a try.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/gradle-plugins-intro.html">Writing Gradle Plugins</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 07 December 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/gradle.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> gradle</span></a>
                <p><div class="paragraph">
<p>In my last post, <a href="http://coffeaelectronica.com/blog/2016/gradle-introduction.html">Gradle: A Gentle Introduction</a>, I discussed the basics of Gradle and how to get up and running quickly. Now, I am going to dive into the deeper part of the pool and talk about how to write your own Gradle plugins.</p>
</div>
<div class="paragraph">
<p>First, we need a project to work with. Let&#8217;s say that we want to add a custom banner to our build output - who doesn&#8217;t love banners? Something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  _______ _            ____        _ _     _
 |__   __| |          |  _ \      (_) |   | |
    | |  | |__   ___  | |_) |_   _ _| | __| |
    | |  | '_ \ / _ \ |  _ &lt;| | | | | |/ _` |
    | |  | | | |  __/ | |_) | |_| | | | (_| |_ _ _
    |_|  |_| |_|\___| |____/ \__,_|_|_|\__,_(_|_|_)</pre>
</div>
</div>
<div class="paragraph">
<p>We need to create a directory named <code>banner-build</code> and then create a <code>build.gradle</code> file in it with the following starting content:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id 'groovy'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We just need a basic starting point. Run <code>./gradle wrapper --gradle-version=3.2</code> to generate the wrapper and we are ready to start (we can run <code>/gradlew</code> from here on out).</p>
</div>
<div class="paragraph">
<p>Now, in order to write out a banner we need to create a custom task that will render it for us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">task banner {
    doFirst {
        if( !project.hasProperty('noBanner') ){
            file('banner.txt').eachLine { line-&gt;
                logger.lifecycle line
            }
        }
    }
}

gradle.startParameter.taskNames = [':banner'] + gradle.startParameter.taskNames</code></pre>
</div>
</div>
<div class="paragraph">
<p>This task will add our action to the top of the execution list (the <code>startPrameter</code> modification makes it always run) so that if the <code>noBanner</code> property is not specified, our banner will be loaded from the specified file and displayed to the output log.</p>
</div>
<div class="paragraph">
<p>We will read our banner from a file, <code>banner.txt</code> in the root of the project - so we will need to create that with the banner content from above. Then, when you run <code>./gradlew build</code> you will see something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; ./gradlew build
:banner
  _______ _            ____        _ _     _
 |__   __| |          |  _ \      (_) |   | |
    | |  | |__   ___  | |_) |_   _ _| | __| |
    | |  | '_ \ / _ \ |  _ &lt;| | | | | |/ _` |
    | |  | | | |  __/ | |_) | |_| | | | (_| |_ _ _
    |_|  |_| |_|\___| |____/ \__,_|_|_|\__,_(_|_|_)
:compileJava UP-TO-DATE
:compileGroovy UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:jar
:assemble
:compileTestJava UP-TO-DATE
:compileTestGroovy UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build

BUILD SUCCESSFUL

Total time: 0.559 secs</pre>
</div>
</div>
<div class="paragraph">
<p>Notice also, that we can turn off the banner, passing the <code>-PnoBanner</code> option on the command line or as a property in your <code>gradle.properties</code> file, if you have one - if you run under one of those conditions, the banner will not be printed.</p>
</div>
<div class="paragraph">
<p>At this point, we have accomplished our original goal and we can go on with our lives&#8230;&#8203; until the next project comes along and you need the same sort of functionality. You could just copy and paste this code into your project, but you don&#8217;t do that&#8230;&#8203; right? That&#8217;s where plugins come into play; they allow us to share functionality across different project builds.</p>
</div>
<div class="paragraph">
<p>To create the plugin, first we need a separate Gradle project for it; create a directory (outside of the one for our demo project), called <code>banner-plugin</code> and add a <code>build.gradle</code> file to it with:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id 'groovy'
    id 'java-gradle-plugin'
}

version = "0.1.0"
group = "com.stehno.gradle"

sourceCompatibility = 8
targetCompatibility = 8

repositories {
    jcenter()
}

dependencies {
    compile gradleApi()
    compile localGroovy()

    testCompile('org.spockframework:spock-core:1.0-groovy-2.4') {
        exclude module: 'groovy-all'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and run <code>gradle wrapper --gradle-version=3.2</code> in it to generate our wrapper. The build file for a plugin project is a standard Gradle build file, but with the <code>java-gradle-plugin</code> plugin to provide extra tools needed for plugins, as well as dependencies for the Gradle API and it&#8217;s associated Groovy distribution. With plugins, the project name is used as part of the unique plugin ID, so it&#8217;s generally a good practice to be explicit about the project name using a <code>settings.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/settings.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">rootProject.name = 'banner-plugin'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last piece of plugin-specific configuration is the plugin properties file, which is a file in the <code>resources/META-INF/gradle-plugins</code> directory named <code>&lt;group&gt;.&lt;name&gt;.properties</code>, for this example:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/src/main/resources/META-INF/gradle-plugins/com.stehno.gradle.banner-plugin.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">implementation-class=com.stehno.gradle.banner.BannerPlugin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can create the basic skeleton for our plugin, which is an implementation of the Gradle <code>Plugin&lt;Project&gt;</code> interface:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/src/main/groovy/com/stehno/gradle/banner/BannerPlugin.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.gradle.banner

import org.gradle.api.Plugin
import org.gradle.api.Project

class BannerPlugin implements Plugin&lt;Project&gt; {

    @Override void apply(final Project project) {
        // your config here...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the main entry point for our plugin. When it is "applied" to the project, the <code>apply(Project)</code> method will be called. If we do a <code>clean build</code> of the project at this point, it will pass, but it does nothing. We need to transfer our functionality (the <code>banner</code> task) from our original <code>build.gradle</code>
file to the plugin. Let&#8217;s create the plugin task skeleton:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/src/main/groovy/com/stehno/gradle/banner/BannerTask.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.gradle.banner

import org.gradle.api.DefaultTask
import org.gradle.api.tasks.TaskAction

class BannerTask extends DefaultTask {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and give it something to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@TaskAction
void displayBanner(){
    logger.lifecycle 'Doing something!'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have a task, we need to wire it into the plugin so that it is applied to the project. Change the <code>apply(Project)</code> method of our <code>BannerPlugin</code> class to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Override void apply(final Project project) {
    project.task 'banner', type:BannerTask

    project.gradle.startParameter.taskNames = [':banner'] + project.gradle.startParameter.taskNames
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will apply our new task and then cause it to be called whenever the build is run. Now, how do we check our progress? We could build the plugin and deploy it to our original project but that would be quite a lot of round-trip time every time we wanted to test a change, but there is no need for that, Gradle provides a rich test framework which works well with Spock. Let&#8217;s create a Spock test for our task:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/src/test/groovy/com/stehno/gradle/banner/BannerTaskSpec.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.gradle.banner

import spock.lang.Specification
import org.junit.Rule
import org.junit.rules.TemporaryFolder
import org.gradle.testkit.runner.BuildResult
import org.gradle.testkit.runner.BuildTask
import org.gradle.testkit.runner.GradleRunner
import org.gradle.testkit.runner.TaskOutcome

class BannerTaskSpec extends Specification {

    @Rule TemporaryFolder projectRoot = new TemporaryFolder()

    def 'simple run'(){
        given:
        File buildFile = projectRoot.newFile('build.gradle')
        buildFile.text = '''
            plugins {
                id 'groovy'
                id 'com.stehno.gradle.banner-plugin'
            }
        '''.stripIndent()

        projectRoot.newFile('banner.txt').text = 'Awesome Banner!'

        when:
        BuildResult result = GradleRunner.create()
            .withPluginClasspath()
            .withProjectDir(projectRoot.root)
            .withArguments('clean build'.split(' '))
            .build()

        then:
        println result.output
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a bit of code, but it&#8217;s not too bad once you dig in. We have a standard Spock test, with a <code>TemporaryFolder</code> rule - this will be our test project directory. Then, we create a <code>build.gradle</code> file for our test with our plugin and the <code>groovy</code> plugin, similar to what our original Gradle file looked like. Next, we use the <code>GradleRunner</code> to create and configure a Gradle environment using our file, which is then executed as a build. The results are then printed out to the command line. If you run <code>./gradlew test</code> on the project now and view the test output (in the report standard out), you
 will see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:banner
Doing something!
:clean UP-TO-DATE
:compileJava UP-TO-DATE
:compileGroovy UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:jar
:assemble
:compileTestJava UP-TO-DATE
:compileTestGroovy UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build

BUILD SUCCESSFUL

Total time: 2.019 secs</pre>
</div>
</div>
<div class="paragraph">
<p>where we can see our output and we have a way to quickly test our new task. So, moving onward, we need to add the real functionality to our task. Update the <code>displayBanner()</code> method to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@TaskAction
void displayBanner(){
    if( !project.hasProperty('noBanner') ){
        project.file('banner.txt').eachLine { line-&gt;
            logger.lifecycle line
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we prefixed <code>project.</code> before the <code>file()</code> call since we are no longer directly in the "project" scope, but other than that this code was copied right from our original build file. If you run the test, you see our message in the test output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:banner
Awesome banner!
:clean UP-TO-DATE
:compileJava UP-TO-DATE
:compileGroovy UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:jar
:assemble
:compileTestJava UP-TO-DATE
:compileTestGroovy UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build

BUILD SUCCESSFUL

Total time: 2.019 secs</pre>
</div>
</div>
<div class="paragraph">
<p>Our test is good, but it doesn&#8217;t really verify anything, it just prints out the build output. Let&#8217;s make it verify that the build passed and that our expected message is in the output - the <code>then:</code> block becomes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">then:
result.tasks.every { BuildTask task -&gt;
    task.outcome == TaskOutcome.SUCCESS || task.outcome == TaskOutcome.UP_TO_DATE
}

result.output.contains('Awesome Banner!')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test will no longer generate the build output to the command line, but we are actually verifying the expected behavior.</p>
</div>
<div class="paragraph">
<p>We can test the <code>noBanner</code> property support as well, but we should also refactor the test a bit so that shared code is reused - now our test looks like:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/src/test/groovy/com/stehno/gradle/banner/BannerTaskSpec.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.gradle.banner

import spock.lang.Specification
import org.junit.Rule
import org.junit.rules.TemporaryFolder
import org.gradle.testkit.runner.BuildResult
import org.gradle.testkit.runner.BuildTask
import org.gradle.testkit.runner.GradleRunner
import org.gradle.testkit.runner.TaskOutcome

class BannerTaskSpec extends Specification {

    @Rule TemporaryFolder projectRoot = new TemporaryFolder()

    private File buildFile

    def setup(){
        buildFile = projectRoot.newFile('build.gradle')
        buildFile.text = '''
            plugins {
                id 'groovy'
                id 'com.stehno.gradle.banner-plugin'
            }
        '''.stripIndent()

        projectRoot.newFile('banner.txt').text = 'Awesome Banner!'
    }

    def 'simple run'(){
        when:
        BuildResult result = GradleRunner.create()
            .withPluginClasspath()
            .withProjectDir(projectRoot.root)
            .withArguments('clean build'.split(' '))
            .build()

        then:
        println result.output
        buildPassed result

        result.output.contains('Awesome Banner!')
    }

    def 'simple run with status hidden'(){
        when:
        BuildResult result = GradleRunner.create()
            .withPluginClasspath()
            .withProjectDir(projectRoot.root)
            .withArguments('clean build -PnoBanner'.split(' '))
            .build()

        then:
        buildPassed result

        !result.output.contains('Awesome Banner!')
    }

    private boolean buildPassed(final BuildResult result){
        result.tasks.every { BuildTask task -&gt;
            task.outcome == TaskOutcome.SUCCESS || task.outcome == TaskOutcome.UP_TO_DATE
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mostly I just extracted the <code>setup</code> code and the <code>buildPassed</code> check, then added a test for the <code>noBanner</code> property support.</p>
</div>
<div class="paragraph">
<p>Wouldn&#8217;t it be nice to make the banner file location configurable? Gradle plugins have a "extension" construct that allows for rich configuration of plugins by adding functionality to the Gradle DSL. For our plugin, we would like to support something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">banner {
    enabled = true
    location = file('banner.txt')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which would be used to toggle the banner display on and off and also provide a means of configuring the banner file location. This structure and both of its properties are optional, but allow additional configuration. Adding them to the plugin is fairly simple. The extension itself is just a POGO class, which for our case would be:</p>
</div>
<div class="listingblock">
<div class="title">banner-plugin/src/main/groovy/com/stehno/gradle/banner/BannerExtension.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.stehno.gradle.banner

class BannerExtension {

    boolean enabled = true
    File location
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To register the extension with the plugin, you add the following to the first line of the <code>BannerPlugin</code> <code>apply(Project)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">project.extensions.create('banner', BannerExtension)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last part of adding the extension support is to have the task actually make use of it. The <code>displayBanner</code> method of the task will look like the
following when we are done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@TaskAction
void displayBanner(){
    BannerExtension extension = project.extensions.getByType(BannerExtension)

    boolean enabled = project.hasProperty('bannerEnabled') ? project.property('bannerEnabled').equalsIgnoreCase('true') : extension.enabled

    File bannerFile = project.hasProperty('bannerFile') ? new File(project.property('bannerFile')) : (extension.location ?: project.file('banner.txt'))


    if( enabled ){
        bannerFile.eachLine { line-&gt;
            logger.lifecycle line
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I modified the <code>noBanner</code> property and converted it to a flag so that now you would pass in <code>-PbannerEnabled=false</code> to disable it. I also added a means
of configuring the banner file from the command line or via the extension, with the default still being <code>banner.txt</code>. The CLI and settings properties
will override the extension values if they are present. We need to modify the <code>'simple run with status hidden'</code> test to handle the new parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def 'simple run with status hidden'(){
    when:
    BuildResult result = GradleRunner.create()
        .withPluginClasspath()
        .withProjectDir(projectRoot.root)
        .withArguments('clean build -PbannerEnabled=false'.split(' '))
        .build()

    then:
    buildPassed result

    !result.output.contains('Awesome Banner!')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if you run the tests, everything still passes - so the defaults work as expected. Let&#8217;s add some tests using the extension to override the file
location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def 'extension run'(){
    setup:
    buildFile.text = '''
        plugins {
            id 'groovy'
            id 'com.stehno.gradle.banner-plugin'
        }

        banner {
            location = file('other-banner.txt')
        }
    '''.stripIndent()

    when:
    BuildResult result = GradleRunner.create()
        .withPluginClasspath()
        .withProjectDir(projectRoot.root)
        .withArguments('clean build'.split(' '))
        .build()

    then:
    buildPassed result

    result.output.contains('Awesome-er Banner!')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this test we have to override the default build file we created in <code>setup</code>. I also added the creation of the other banner file in the <code>setup</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">projectRoot.newFile('other-banner.txt').text = 'Awesome-er Banner!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, run the tests again and see that our extension works as expected.</p>
</div>
<div class="paragraph">
<p>With our newly minted Gradle plugin we should be able to use it in our original project as a local test before deployment. An easy way to do this is to publish it to your local maven repository and then configure the other project to use it. In the plugin project, add <code>id 'maven-publish'</code> to the <code>plugins</code> block, which will allow us to publish to the local maven repo. Then run <code>./gradlew publishToMavenLocal</code>, which does what it says.</p>
</div>
<div class="paragraph">
<p>In the original external <code>build.gradle</code> file we need to add bootstrapping code to bring in the local plugin and also remove the old <code>banner</code> task. The
updated <code>build.gradle</code> file will look like this:</p>
</div>
<div class="listingblock">
<div class="title">build-banner/build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">buildscript {
    repositories {
        mavenLocal()
    }
    dependencies {
        classpath "com.stehno.gradle:banner-plugin:0.1.0"
    }
}

plugins {
    id 'groovy'
}

apply plugin: "com.stehno.gradle.banner-plugin"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we are pulling the plugin from the local maven repository. If you run the build now, you get your expected banner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; ./gradlew build
:banner
  _______ _            ____        _ _     _
 |__   __| |          |  _ \      (_) |   | |
    | |  | |__   ___  | |_) |_   _ _| | __| |
    | |  | '_ \ / _ \ |  _ &lt;| | | | | |/ _` |
    | |  | | | |  __/ | |_) | |_| | | | (_| |_ _ _
    |_|  |_| |_|\___| |____/ \__,_|_|_|\__,_(_|_|_)
:build

BUILD SUCCESSFUL

Total time: 0.543 secs</pre>
</div>
</div>
<div class="paragraph">
<p>However, we should be able to use a different banner file. Create another banner file as <code>flag.txt</code> (with whatever you want in it) and configure the
build to use it by adding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">banner {
    location = file('flag.txt')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>to the bottom of the build file. Now, with my new version, I get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; ./gradlew build
:banner
This is GRADLE!!!
:build

BUILD SUCCESSFUL

Total time: 0.474 secs</pre>
</div>
</div>
<div class="paragraph">
<p>We can also disable the banner via config, set <code>enabled = false</code> in the extension code, and it will not appear. But, you can force it on the command
line by adding <code>-PbannerEnabled=true</code>.</p>
</div>
<div class="paragraph">
<p>From here, you can distribute your plugin to friends and coworkers as long as you have some shared repository that you can point them to, but what if
you came up with something cool enough to share to a larger audience? For that you want to publish to the <a href="http://plugins.gradle.com" class="bare">http://plugins.gradle.com</a> repo, which is
what is used by the <code>plugins</code> block of the <code>build.gradle</code> file. I won&#8217;t go too far down that path in this post, but basically you will need to add the
<code>id 'com.gradle.plugin-publish' version '0.9.4'</code> plugin to the plugin project, which will handle the actual publishing for you once you configure it
for your project. In our case this would be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">pluginBundle {
    website = 'http://yourdomain.com/banner-plugin'
    vcsUrl = 'https://github.com/cjstehno/banner-plugin'
    description = 'Gradle plugin to add a fancy banner to your build log.'
    tags = ['gradle', 'groovy']

    plugins {
        webpreviewPlugin {
            id = 'com.stehno.gradle.banner-plugin'
            displayName = 'Gradle Build Banner Plugin'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have that in place and have signed up with the plugins portal (free) you run <code>./gradlew publishPlugins</code> and if all goes well, you have a
publicly available plugin.</p>
</div>
<div class="paragraph">
<p>This tutorial has really only scratched the surface of plugin development, there is a lot more there to work with and most of it is well documented in
the Gradle User Guide or through some Google searches. It&#8217;s a powerful framework and well worth spending the time to learn if you are working in Gradle.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/gradle-introduction.html">Gradle: A Gentle Introduction</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 02 November 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/gradle.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> gradle</span></a>
                <p><div class="paragraph">
<p>The <a href="http://gradle.org">Gradle</a> build tool has become widely-used over the past few years, but there are still a lot of developers who are unfamiliar with
it, and like any new framework or technology it is easier to get started with some guidance. Hopefully this will provide a nice jump start
into doing some actual work with Gradle. With that being said, let&#8217;s dig in!</p>
</div>
<div class="paragraph">
<p>I will forgo installing Gradle - you can read about how to do that for your platform in the Gradle documentation. Let&#8217;s assume you have Gradle installed,
preferably a current version. If you run <code>gradle --version</code> you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>------------------------------------------------------------
Gradle 3.1
------------------------------------------------------------

Build time:   2016-09-19 10:53:53 UTC
Revision:     13f38ba699afd86d7cdc4ed8fd7dd3960c0b1f97

Groovy:       2.4.7
Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015
JVM:          1.8.0_102 (Oracle Corporation 25.102-b14)
OS:           Linux 4.8.0-26-generic amd64</pre>
</div>
</div>
<div class="paragraph">
<p>First, create a directory for your project and <code>cd</code> into it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir hellogradle
cd hellogradle</pre>
</div>
</div>
<div class="paragraph">
<p>Every Gradle project needs at least a <code>build.gradle</code> file so we will start with the minimal requirement. Create the following file in your project
directory:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id 'groovy'
}

repositories {
    jcenter()
}

dependencies {
    compile 'org.codehaus.groovy:groovy-all:2.4.6'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>plugins</code> block is used to specify the Gradle plugins used in the build; in this case we just need <code>groovy</code> since we are making a Groovy project.
The <code>groovy</code> plugin extends the <code>java</code> plugin so we get its functionality as well.</p>
</div>
<div class="paragraph">
<p>The <code>repositories</code> block specifies which repositories are available for resolving dependency artifacts - in most cases <code>jcenter()</code> (the Bintray
repository) is enough to start with.</p>
</div>
<div class="paragraph">
<p>Lastly, the <code>dependencies</code> block is where the project dependencies are defined as <code>&lt;configuration&gt; '&lt;group&gt;:&lt;artifact&gt;:&lt;version&gt;'</code>.</p>
</div>
<div class="paragraph">
<p>At this point you have a working Gradle project. You can build it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>gradle clean build</pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; hellogradle gradle clean build
:clean
:compileJava UP-TO-DATE
:compileGroovy UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:jar
:assemble
:compileTestJava UP-TO-DATE
:compileTestGroovy UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build

BUILD SUCCESSFUL

Total time: 0.492 secs</pre>
</div>
</div>
<div class="paragraph">
<p>You can see that it is already doing quite a bit for so few lines of build code. You can run <code>gradle tasks</code> to see a list of the tasks available to your
project.</p>
</div>
<div class="paragraph">
<p>So far, we have been running against my local version of Gradle. One of the nice features of Gradle is the wrapper functionality. The wrapper allows
the project to specify the version of Gradle it should be built under; this code is then checked into your source control system so that a new
developer can checkout the project and build it with the correct version of Gradle without it being installed on their system.</p>
</div>
<div class="paragraph">
<p>Add the following to the bottom of the <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">task wrapper(type: Wrapper) {
    gradleVersion = '3.1'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, whenever you add the wrapper or change the supported version, you need to execute the <code>gradle wrapper</code> task to regenerate the configuration. Once
the wrapper is in place, you will want to execute all your Gradle tasks using it rather than your local installation. You do this using the <code>gradlew</code>
or <code>gradlew.bat</code> scripts provided in the root of your project. Now let&#8217;s do a clean build again with the wrapper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; hellogradle ./gradlew clean build
:clean
:compileJava UP-TO-DATE
:compileGroovy UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:jar
:assemble
:compileTestJava UP-TO-DATE
:compileTestGroovy UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build

BUILD SUCCESSFUL

Total time: 0.678 secs</pre>
</div>
</div>
<div class="paragraph">
<p>We end up with the same result as before.</p>
</div>
<div class="paragraph">
<p>This project doesn&#8217;t do anything at this point - there is no code. Let&#8217;s add some Groovy code; create the directories for <code>src/main/groovy/demo</code> and
then add the file:</p>
</div>
<div class="listingblock">
<div class="title">HelloGradle.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package demo

class HelloGradle {

    String greet(final String name){
        "Hello, ${name ?: 'Gradle'}!"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code simply says hello to the name passed in as an argument, or Gradle by default. Now we will need to unit test our work, so let&#8217;s add support
for the <a href="http://spockframework.org/spock/docs/1.1-rc-2/index.html">Spock testing framework</a>. Add the following to your <code>dependencies</code> closure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">testCompile 'org.spockframework:spock-core:1.0-groovy-2.4'</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now have Spock available, so let&#8217;s write a unit test for our code. Create the test directories: <code>src/test/groovy/demo</code> and then create the file:</p>
</div>
<div class="listingblock">
<div class="title">HelloGradleSpec.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package demo

import spock.lang.Specification
import spock.lang.Unroll

class HelloGradleSpec extends Specification {

    private final HelloGradle greeter = new HelloGradle()

    @Unroll def 'say hello #name'(){
        expect:
        greeter.greet(name) == result

        where:
        name    | result
        null    | 'Hello, Gradle!'
        ''      | 'Hello, Gradle!'
        'Chris' | 'Hello, Chris!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This test will verify that our greeter returns the expected values for <code>null</code>-ish inputs as well as when a name is provided. I won&#8217;t go into the details
of the Spock test at this point. Now, when you build the project, you will also run the tests by default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; hellogradle ./gradlew clean build
:clean
:compileJava UP-TO-DATE
:compileGroovy
:processResources UP-TO-DATE
:classes
:jar
:assemble
:compileTestJava UP-TO-DATE
:compileTestGroovy
:processTestResources UP-TO-DATE
:testClasses
:test
:check
:build

BUILD SUCCESSFUL

Total time: 1.789 secs</pre>
</div>
</div>
<div class="paragraph">
<p>Notice <code>:test</code> near the bottom. Gradle also provides an HTML report of your test results. The report will be generated in the <code>build/reports</code> directory
and will look something like the following image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/gradle-test-report.png" alt="gradle test report">
</div>
</div>
<div class="paragraph">
<p>Now that we have a test, it might be nice to have some idea of our test coverage. Gradle provides a plugin for the <a href="http://www.eclemma.org/jacoco/">jacoco</a>
code coverage library. You can add the plugin by adding <code>id 'jacoco'</code> to the <code>plugins</code> block of your <code>build.gradle</code> file, which allows you to run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew clean build jacocoTestReport</pre>
</div>
</div>
<div class="paragraph">
<p>to build the project with tests and a generated test coverage report. Again, the report is generated in the <code>build/reports</code> directory - it will look
something like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/gradle-coverage-report.png" alt="gradle coverage report">
</div>
</div>
<div class="paragraph">
<p>The coverage report allows you to drill down into the source code and see what is and is not covered by your tests.</p>
</div>
<div class="paragraph">
<p>Testing your code is nice, but you need a way to run your application outside of testing. Let&#8217;s first add a <code>main</code> method to our Groovy code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">static void main(args){
    println new HelloGradle().greet(args ? args[0] : null)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nothing fancy, just instantiate the <code>HelloGradle</code> class and call the <code>greet(String)</code> method with the first argument, if there is one. To make the project
runnable, we need to add the <code>application</code> plugin and specify a "main class". To do this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>id 'application'</code> to the <code>plugins</code> block</p>
</li>
<li>
<p>Add <code>group = 'demo'</code> to give the project an artifact group</p>
</li>
<li>
<p>Add <code>version = '0.0.1'</code> to give your project a version</p>
</li>
<li>
<p>Add <code>mainClassName = 'demo.HelloGradle'</code> to the <code>build.gradle</code> file outside of other configuration blocks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With that, you now have a new task <code>run</code> which will run the application for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; hellogradle ./gradlew run
:compileJava UP-TO-DATE
:compileGroovy
:processResources UP-TO-DATE
:classes
:run
Hello, Gradle!

BUILD SUCCESSFUL

Total time: 1.526 secs</pre>
</div>
</div>
<div class="paragraph">
<p>It also generates <code>.tar</code> and <code>.zip</code> distributions of the project which contain starter scripts and all required dependencies to deploy and run your
application outside of the project itself.</p>
</div>
<div class="paragraph">
<p>Code quality analysis tools are also available as Gradle plugins. A common one for Groovy development is <a href="http://codenarc.sourceforge.net/">CodeNarc</a>
which runs quality rules against your code to generate a report of possible issues. We can add this to the project by adding <code>id 'codenarc'</code> to the
<code>plugins</code> block and adding some additional config to <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">codenarcMain {
    ignoreFailures false
    configFile file('config/codenarc-main.rules')

    maxPriority1Violations 0
    maxPriority2Violations 5
    maxPriority3Violations 10
}

codenarcTest {
    ignoreFailures true
    configFile file('config/codenarc-test.rules')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which configures a different rules and criteria for main source code vs test source code. The main and test rule sets are based on their suggested
configurations, personal preference and experience - I generally use the files from my Vanilla project
(<a href="https://github.com/cjstehno/vanilla/blob/master/config/codenarc-main.rules">main</a>, <a href="https://github.com/cjstehno/vanilla/blob/master/config/codenarc-test.rules">test</a>)
for simplicity. This configuration will fail the build when the violation thresholds are exceeded for the main classes, but will simply report on the
violations for test classes. The build will now run the codenarc checks when a build is executed.</p>
</div>
<div class="paragraph">
<p>The build will let you know if violations were found, and in any case will generate a report in the <code>build/reports/codenarc</code> directory. The report will
look something like the following:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/gradle-codenarc-report.png" alt="gradle codenarc report">
</div>
</div>
<div class="paragraph">
<p>At this point, we have a Gradle-based Groovy project with portable support for building, testing, coverage, code quality and application run/deployment, all
 with a few dozen lines of understandable code. While there is a lot more you can and should do with Gradle, this is a good starting point. From here, you
 should read through their documentation in general or touch on topics as you need them to figure out how to do something. Also Google is your best
 reference for finding how-tos or 3rd-party plugins; however, there is an official <a href="https://plugins.gradle.org/">plugin repository</a> that is starting to catch on.</p>
</div>
<div class="paragraph">
<p>Once you get the hang of it Gradle is hard to let go of due to its compact code, expressiveness and flexibility without the pains and rigor of older tools, like
Maven and Ant.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/gradle-natives-update.html">Gradle Natives Plugin Update</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 19 September 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/java.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> java</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/gradle.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> gradle</span></a>
                <p><div class="paragraph">
<p>A few years ago I wrote a post about my <a href="https://github.com/cjstehno/gradle-natives">Gradle-Natives plugin</a>, called <a href="http://coffeaelectronica.com/blog/2014/going-native-with-gradle.html">"Going Native with Gradle"</a>. The plugin was the result of some failed attempts at game programming and it pretty much stopped there; however, it seems there are some users who found it useful. In the years since it was written, it sat and got buggy and then recently just became useless due to external library changes and the rigidity of the plugin functionality. Tryign to be a good open source citizen, I figured it would be a good time to do some updates that will hopefully keep the plugin viable for a while.</p>
</div>
<div class="paragraph">
<p>With the new release, I figured it would be good to go back to the original post and attempt a similar example. Using the example code from the
LWJGL <a href="https://www.lwjgl.org/guide">Getting Started Guide</a> we have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import org.lwjgl.*;
import org.lwjgl.glfw.*;
import org.lwjgl.opengl.*;

import static org.lwjgl.glfw.Callbacks.*;
import static org.lwjgl.glfw.GLFW.*;
import static org.lwjgl.opengl.GL11.*;
import static org.lwjgl.system.MemoryUtil.*;

public class HelloWorld {

	// The window handle
	private long window;

	public void run() {
		System.out.println("Hello LWJGL " + Version.getVersion() + "!");

		try {
			init();
			loop();

			// Free the window callbacks and destroy the window
			glfwFreeCallbacks(window);
			glfwDestroyWindow(window);
		} finally {
			// Terminate GLFW and free the error callback
			glfwTerminate();
			glfwSetErrorCallback(null).free();
		}
	}

	private void init() {
		// Setup an error callback. The default implementation
		// will print the error message in System.err.
		GLFWErrorCallback.createPrint(System.err).set();

		// Initialize GLFW. Most GLFW functions will not work before doing this.
		if ( !glfwInit() )
			throw new IllegalStateException("Unable to initialize GLFW");

		// Configure our window
		glfwDefaultWindowHints(); // optional, the current window hints are already the default
		glfwWindowHint(GLFW_VISIBLE, GLFW_FALSE); // the window will stay hidden after creation
		glfwWindowHint(GLFW_RESIZABLE, GLFW_TRUE); // the window will be resizable

		int WIDTH = 300;
		int HEIGHT = 300;

		// Create the window
		window = glfwCreateWindow(WIDTH, HEIGHT, "Hello World!", NULL, NULL);
		if ( window == NULL )
			throw new RuntimeException("Failed to create the GLFW window");

		// Setup a key callback. It will be called every time a key is pressed, repeated or released.
		glfwSetKeyCallback(window, (window, key, scancode, action, mods) -&gt; {
			if ( key == GLFW_KEY_ESCAPE &amp;&amp; action == GLFW_RELEASE )
				glfwSetWindowShouldClose(window, true); // We will detect this in our rendering loop
		});

		// Get the resolution of the primary monitor
		GLFWVidMode vidmode = glfwGetVideoMode(glfwGetPrimaryMonitor());
		// Center our window
		glfwSetWindowPos(
			window,
			(vidmode.width() - WIDTH) / 2,
			(vidmode.height() - HEIGHT) / 2
		);

		// Make the OpenGL context current
		glfwMakeContextCurrent(window);
		// Enable v-sync
		glfwSwapInterval(1);

		// Make the window visible
		glfwShowWindow(window);
	}

	private void loop() {
		// This line is critical for LWJGL's interoperation with GLFW's
		// OpenGL context, or any context that is managed externally.
		// LWJGL detects the context that is current in the current thread,
		// creates the GLCapabilities instance and makes the OpenGL
		// bindings available for use.
		GL.createCapabilities();

		// Set the clear color
		glClearColor(1.0f, 0.0f, 0.0f, 0.0f);

		// Run the rendering loop until the user has attempted to close
		// the window or has pressed the ESCAPE key.
		while ( !glfwWindowShouldClose(window) ) {
			glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT); // clear the framebuffer

			glfwSwapBuffers(window); // swap the color buffers

			// Poll for window events. The key callback above will only be
			// invoked during this call.
			glfwPollEvents();
		}
	}

	public static void main(String[] args) {
		new HelloWorld().run();
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we put this in a simple Gradle project with <code>build.gradle</code> as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id 'com.stehno.natives' version '0.2.4'
    id 'java'
    id 'application'
}

version = "0.0.1"
group = "com.stehno"
mainClassName = 'hello.HelloWorld'

sourceCompatibility = 8
targetCompatibility = 8

repositories {
    jcenter()
}

dependencies {
    compile 'org.lwjgl:lwjgl:3.0.0'
    compile 'org.lwjgl:lwjgl-platform:3.0.0:natives-windows'
    compile 'org.lwjgl:lwjgl-platform:3.0.0:natives-linux'
    compile 'org.lwjgl:lwjgl-platform:3.0.0:natives-osx'
}

task wrapper(type: Wrapper) {
    gradleVersion = "2.14"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can view the native libraries for all platforms using <code>./gradlew listNatives</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:listNatives
Native libraries found for configurations (compile, runtime)...
 - lwjgl-platform-3.0.0-natives-linux.jar:
        [LINUX] libjemalloc.so
        [LINUX] liblwjgl.so
        [LINUX] libglfw.so
        [LINUX] libopenal.so
 - lwjgl-platform-3.0.0-natives-osx.jar:
        [MAC] liblwjgl.dylib
        [MAC] libjemalloc.dylib
        [MAC] libglfw.dylib
        [MAC] libopenal.dylib
 - lwjgl-platform-3.0.0-natives-windows.jar:
        [WINDOWS] lwjgl.dll
        [WINDOWS] lwjgl32.dll
        [WINDOWS] OpenAL.dll
        [WINDOWS] jemalloc.dll
        [WINDOWS] glfw.dll
        [WINDOWS] glfw32.dll
        [WINDOWS] jemalloc32.dll
        [WINDOWS] OpenAL32.dll</pre>
</div>
</div>
<div class="paragraph">
<p>and we can build and run the <code>HelloWorld</code> application with <code>./gradlew clean build run</code>, which begs the question of whether or not this plugin is needed, since at this point the application works and we have not used the plugin at all. I will leave that to developers who actually work with this stuff and may use the plugin - I am just updating the existing functionality.</p>
</div>
<div class="paragraph">
<p>You can inlude the native libraries in the build using <code>./gradlew clean build includeNatives</code> which will unpack the native libraries into the project
<code>build</code> directory.</p>
</div>
<div class="paragraph">
<p>There are still a number of configuration options available through the <code>natives</code> DSL extension, such as including and excluding libraries, as well as limiting the scan to certain configurations and platforms, but I will leave those for the official documentation. Without any additional configuration you get all of the native libraries from the <code>compile</code> and <code>runtime</code> configurations for all platforms unpacked into the <code>build/natives</code> directory.</p>
</div>
<div class="paragraph">
<p>This plugin is still pretty raw, but hopefully it is useful enough to make some developers lives easier.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/httpbuilder-ng-demo.html">HTTP Builder NG for Groovy and Java</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 18 September 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a>
                <p><div class="paragraph">
<p>The <a href="https://github.com/jgritman/httpbuilder"><code>HttpBuilder</code></a> project has been a go-to library for the simplification of HTTP requests for years; however, development on the project has stalled and seemingly
died. A friend of mine (<a href="https://github.com/dwclark">Dave Clark</a>) decided to pick up where the project left off and to bring it up-to-date with modern Groovy and Java 8 support. The
<a href="https://github.com/dwclark/http-builder-ng">HTTP Builder NG</a> project is a major update and refactor of the original project. I joined on to help with development, documentation and testing. In my opinion,
this effort has brought the library back from the dead, better than ever. In this post, I will walk through accessing a simple REST service using the <code>HttpBuilder</code> with both Groovy and Java examples -
yes, the new version of the library supports standard Java 8 coding.</p>
</div>
<div class="paragraph">
<p>First, we need a REST service to work with. I have thrown together a simple set of endpoints using the <a href="http://sparkjava.com">Spark Web Framework</a> to make a "message of the day" service. There are three
endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /message</code> - retrieves the current stored message</p>
</li>
<li>
<p><code>POST /message</code> - saves the <code>text</code> field of the JSON body content as the new message</p>
</li>
<li>
<p><code>DELETE /message</code> - deletes the current message</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is not much to it, but it should be enough to play with. You can find the code in the [repo for this post](<a href="https://github.com/cjstehno/httpb-demo" class="bare">https://github.com/cjstehno/httpb-demo</a>). Startup the server by running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew run</pre>
</div>
</div>
<div class="paragraph">
<p>In the root of the project. The server will be running on <a href="http://localhost:4567" class="bare">http://localhost:4567</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start off by retrieving the current message from the server. We need a base configured <code>HttpBuilder</code> object to make requests from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">HttpBuilder http = HttpBuilder.configure {
    request.uri = 'http://localhost:4567'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we need to make a <code>GET</code> request to the <code>/message</code> path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def result = http.get {
    request.uri.path = '/message'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run this code, you will get the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[text:n/a, timestamp:2016-09-16T12:47:55+0000]</pre>
</div>
</div>
<div class="paragraph">
<p>which is a <code>Map</code> of the parsed JSON data coming back from the server - the <code>HttpBuilder</code> recognizes the <code>application/json</code> response content and parses it for you. In this case
all we really want is the text, so let&#8217;s transform the response data a bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String text = http.get(String){
    request.uri.path = '/message'
    response.success { FromServer from, Object body-&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added an expected result type of <code>String</code> and a <code>response.success()</code> handler. This handler will be called when a successful response code is received (code &lt; 400). When
it is called it will pull the text field out of our body object, which in this case, is the already-parsed JSON data. The return value from the <code>success()</code> method is returned
as the result - the text of the current message. When you run this version of the code you get the current message text:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>n/a</pre>
</div>
</div>
<div class="paragraph">
<p>This is the default "empty" message content. How do we update the message to something more interesting? The service exposes <code>POST /message</code> which will take the <code>text</code> field of the request body
content and use it as the new message. We can write a <code>POST</code> request just as easily as our <code>GET</code> request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String updated = http.post(String) {
    request.uri.path = '/message'
    request.contentType = 'application/json'
    request.body = { text 'HttpBuilder is alive!' }
    response.success { FromServer from, Object body -&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, we will expect the text of the new message back from the server, but this time we are calling the <code>post()</code> method with a JSON content type. Note that our body content is using the Groovy
<code>JsonBuilder</code> closure format, it could have just as easily been a <code>Map</code> of the data to be encoded. Similar to the response decoding, the request body is automatically encoded based on the content
type.</p>
</div>
<div class="paragraph">
<p>If you run the code now, you will get:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>HttpBuilder is alive!</pre>
</div>
</div>
<div class="paragraph">
<p>You could also call the <code>get()</code> method again and verify that it is the current message.</p>
</div>
<div class="paragraph">
<p>As a final example with our service, let&#8217;s call the <code>DELETE /message</code> endpoint to reset the message back to it&#8217;s "empty" state. A <code>DELETE</code> request is just as simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String deleted = http.delete(String){
    request.uri.path = '/message'
    response.success { FromServer from, Object body -&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be the new message after deletion:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>n/a</pre>
</div>
</div>
<div class="paragraph">
<p>which is the "empty" state.</p>
</div>
<div class="paragraph">
<p>One thing we notice now that we have written all of the verb calls is that there are a lot of similarities between them. They all call the same <code>path</code> and they all handle the successful response
content in the same manner. I am not a fan of duplication, so we can move the common configuration up into the main <code>configure</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">HttpBuilder http = HttpBuilder.configure {
    request.uri = 'http://localhost:4567/message'
    response.success { FromServer from, Object body -&gt;
        body.text
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and our verb methods, now contain only what they need to do their work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">String message = http.get(String) {}

String updated = http.post(String) {
    request.contentType = 'application/json'
    request.body = { text 'HttpBuilder is alive!' }
}

String deleted = http.delete(String) {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice and clean. Now wait, I know, I promised something similar in plain old Java, well Java 8 anyway&#8230;&#8203; ok, you can do the same operations in Java with a fairly similar expressiveness:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">HttpBuilder http = HttpBuilder.configure(config -&gt; {
    config.getRequest().setUri("http://localhost:4567/message");
    config.getResponse().success(new BiFunction&lt;FromServer, Object, String&gt;() {
        @Override public String apply(FromServer fromServer, Object body) {
            return ((Map&lt;String, Object&gt;) body).get("text").toString();
        }
    });
});

String message = http.get(String.class, config -&gt; {});

System.out.println("Starting content: " + message);

// update the content

String updated = http.post(String.class, config -&gt; {
    config.getRequest().setContentType("application/json");
    config.getRequest().setBody(singletonMap("text", "HttpBuilder works from Java too!"));
});

System.out.println("Updated content: " + updated);

// delete the content

String deleted = http.delete(String.class, config -&gt; {});

System.out.println("Post-delete content: " + deleted);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the Java 8 lambdas make the syntax about as simple as the Groovy DSL. When you run this version of the client you get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Starting content: n/a
Updated content: HttpBuilder works from Java too!
Post-delete content: n/a</pre>
</div>
</div>
<div class="paragraph">
<p>In Java or Groovy, the library makes HTTP interactions much easier to work with. Check out the <a href="https://github.com/dwclark/http-builder-ng">project</a> and feel free to submit bug reports and feature
requests, or even suggested details to be documented.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/nd4j-math.html">ND4J Matrix Math</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 12 August 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a>
                <p><div class="paragraph">
<p>In my last post (<a href="http://coffeaelectronica.com/blog/2016/commons-math-matrix.html">Commons Math - RealMatrix</a>), I discussed the matrix operations support provided by the Apache Commons Math API. In doing my research I also stumbled on a library that is much closer in functionality to the Python NumPy library (commonly used in Machine Learning examples). The <a href="http://nd4j.org/">ND4J</a> library is a scientific computing library for the JVM, meant to be used in production environments, which means routines are designed to run fast with minimum RAM requirements.</p>
</div>
<div class="paragraph">
<p>The main draw I had at this point was that their support for array-style element-by-element operations was much deeper than the matrix operations provided by the Apache Commons Math API and much closer to what I was seeing in the Python code I was working with, which makes conversion simpler.</p>
</div>
<div class="paragraph">
<p>With NumPy in Python you can multiply two arrays such that the result is the multiplication of each value of the array by the corresponding value in the second array. This is not so simple with matrices (as shown in my last post). With ND4J, it becomes much simpler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def arrA = Nd4j.create([1.0, 2.0, 3.0] as double[])
def arrB = Nd4j.create([2.0, 4.0, 6.0] as double[])
def arrC = arrA.mul(arrB)
println "$arrA + $arrB = $arrC"</code></pre>
</div>
</div>
<div class="paragraph">
<p>will result in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[1.00, 2.00, 3.00] * [2.00, 4.00, 6.00] = [ 2.00,  8.00, 18.00]</pre>
</div>
</div>
<div class="paragraph">
<p>which is as we would expect from the Python case. ND4J also has the ability to do two-dimensional (matrix-style) arrays:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def matA = Nd4j.create([
    [1.0, 2.0, 3.0] as double[],
    [4.0, 5.0, 6.0] as double[]
] as double[][])
println "Matrix: $matA\n"</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will produce:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Matrix: [[1.00, 2.00, 3.00],
 [4.00, 5.00, 6.00]]</pre>
</div>
</div>
<div class="paragraph">
<p>All of the other mathematical operations I mentioned in the previous post are available and with data structures that feel a lot more rich and refined for general use. This is barely scratching the surface of the available functionality. Also, the underlying code is native-based and has support for running on CUDA cores for higher performance. This library is definitely one to keep in mind for cases when you have a lot of array and matrix-based operations.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/commons-math-matrix.html">Apache Commons Math - RealMatrix</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 11 August 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a>
                <p><div class="paragraph">
<p>I have been reading <a href="https://www.manning.com/books/machine-learning-in-action">Machine Learning in Action</a>, which is a great book; however, all of the examples are in Python. While Python seems like a decent language, it is not one of my primary languages. With that in mind, I have been converting the Python examples into Groovy so that a few months from now when I come back and try to understand what I learned, I will be able to decipher the code.</p>
</div>
<div class="paragraph">
<p>What I have found is that, at least in the examples for this book, there are numerous Matrix-based operations. My Linear Algebra was a long time ago, but I think I remember some of the basics; however, it&#8217;s nice to have a Java-based implementation in the <a href="http://commons.apache.org/proper/commons-math/">Apache Commons Math</a> <code>RealMatrix</code> implementations (there are others but this is what I have been focussing on). It took me a little time to get back up to speed, especially since the Python examples will have something like:</p>
</div>
<div class="paragraph">
<p>someMatrix = someMatrix * anotherMatrix + thirdMatrix * number</p>
</div>
<div class="paragraph">
<p>where the resulting matrix is the product of two matrices added to the product of a matrix and a scalar number. Conceptually, this boils down to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Multiply <code>someMatrix</code> by <code>anotherMatrix</code></p>
</li>
<li>
<p>Multiply every element of <code>thirdMatrix</code> by the scalar <code>number</code> value</p>
</li>
<li>
<p>Add every element of the matrix in step 1 with the element at the same position of the matrix from step 2.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Not hard to grasp, and not even all that hard to code; however, this is something I&#8217;d rather push off to someone else&#8217;s implementation instead of writing it myself. That is where the Commons Math library comes into play. The <code>RealMatrix</code> interface defines matrix support for <code>double</code> values - there is also a more flexible <code>FieldMatrix&lt;T&gt;</code> interface, but <code>double</code> values work well as an example. Let&#8217;s start by setting up a simple Groovy script for playing with matrices. Create a file named <code>matrix-math.groovy</code> and add the following to it:</p>
</div>
<div class="listingblock">
<div class="title">matrix-math.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Grapes(
   @Grab('org.apache.commons:commons-math3:3.6.1')
)

import org.apache.commons.math3.linear.*

def mat = new Array2DRowRealMatrix(4,3)

println mat</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script will download the artifacts for the Apache Commons Math library and create a simple <code>RealMatrix</code> with 4 rows and 3 columns. It will then be printed to the console. When you run it, you should see</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Array2DRowRealMatrix{{0.0,0.0,0.0},{0.0,0.0,0.0},{0.0,0.0,0.0},{0.0,0.0,0.0}}</pre>
</div>
</div>
<div class="paragraph">
<p>which represents our empty 4x3 matrix. While this is not a bad representation, it would be nicer if we could get a better representation of the rows and columns of data for our poor human eyes. The library provides a <code>RealMatrixFormat</code> for this. Add the following to the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def formatter = new RealMatrixFormat('{', '}', '{', '}', ',\n ', ',\t')

println formatter.format(mat)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>println</code> line replaces the existing one. Now we get a better, more human-readable representation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{0,    0,      0},
 {0,    0,      0},
 {0,    0,      0},
 {0,    0,      0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Interesting so far, but we would really like some data. With the existing matrix, you can add data in rows or columns by index, similar to an array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">mat.setRow(0, [1.0, 2.0, 3.0] as double[])
mat.setColumn(1, [9.0, 8.0, 7.0, 6.0] as double[])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you run the code, notice that you get the first row and the second column populated with the provided data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    9,      3},
 {0,    8,      0},
 {0,    7,      0},
 {0,    6,      0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Also notice that the column data overwrote the row data we set for the second column (index 1). In our row data it was <code>2.0</code>, but the <code>9.0</code> value from the column was applied after and is the final value. The other main method of creating a matrix is by providing the data directly in the constructor. Say we want to create a matrix with the same dimensions, but with a sequential collection of values, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1  2  3
4  5  6
7  8  9
10 11 12</pre>
</div>
</div>
<div class="paragraph">
<p>You can do the following in the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def seqMat = new Array2DRowRealMatrix([
    [1.0, 2.0, 3.0] as double[],
    [4.0, 5.0, 6.0] as double[],
    [7.0, 8.0, 9.0] as double[],
    [10.0, 11.0, 12.0] as double[]
] as double[][])

println formatter.format(seqMat)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code creates a matrix with an array of arrays, where the inner arrays are the rows of data. When printed out, you get the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    2,      3},
 {4,    5,      6},
 {7,    8,      9},
 {10,   11,     12}}</pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s do some operations on our matrices. You can do common math operations on two matrices. Adding two matrices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def sum = mat.add(seqMat)
println formatter.format(sum)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives you the element-by-element sum of the values and yields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{2,    11,     6},
 {4,    13,     6},
 {7,    15,     9},
 {10,   17,     12}}</pre>
</div>
</div>
<div class="paragraph">
<p>Subtracting one matrix from another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def diff = seqMat.subtract(mat)
println formatter.format(diff)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{0,    -7,     0},
 {4,    -3,     6},
 {7,    1,      9},
 {10,   5,      12}}</pre>
</div>
</div>
<div class="paragraph">
<p>Multiplication of matrices is not what you might intuitively think it is, unless you are up on your Linear Algebra. Since there are whole wiki pages devoted to <a href="https://en.wikipedia.org/wiki/Matrix_multiplication">Matrix Multiplication</a>, I won&#8217;t go into it here beyond stating that it can be done when you have square matrices (ours are not). Not being a tutorial on Linear Algebra, I am going to leave it at that. You can also multiply a matrix by a scalar number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def prod = mat.scalarMultiply(2)
println formatter.format(prod)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which multiplies every element by the given value and results in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{2,    18,     6},
 {0,    16,     0},
 {0,    14,     0},
 {0,    12,     0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, there is a <code>scalarAdd(double)</code> method.</p>
</div>
<div class="paragraph">
<p>Other useful operations may be performed on matrices. You can "transpose" the matrix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def trans = seqMat.transpose()
println formatter.format(trans)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rotates the values of the matrix to turn rows into columns, as in our example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    2,      3},
 {4,    5,      6},
 {7,    8,      9},
 {10,   11,     12}}</pre>
</div>
</div>
<div class="paragraph">
<p>becomes</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{1,    4,      7,      10},
 {2,    5,      8,      11},
 {3,    6,      9,      12}}</pre>
</div>
</div>
<div class="paragraph">
<p>There are a handful of other built-in operations available to matrices that are probably useful if you know what you are doing, but at this point, I do not. Another useful construct is the set of "walker" methods that allow you to walk through the elements of the matrix in various ways, allowing you to modify the elements or simply read them. Let&#8217;s take our initial matrix as an example and multiply every element by <code>2.0</code> both in place and in an external collection.</p>
</div>
<div class="paragraph">
<p>For the in-place modification we need a <code>RealMatrixChangingVisitor</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class MultiplicationVisitor extends DefaultRealMatrixChangingVisitor {

    double factor

    double visit(int row, int column, double value){
        value * factor
    }
}

mat.walkInOptimizedOrder(new MultiplicationVisitor(factor:2.0))
println formatter.format(mat)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This visitor simply multiplies each value by the provided <code>factor</code> and returns it, which will update the value in the matrix. The resulting matrix has the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{2,    18,     6},
 {0,    16,     0},
 {0,    14,     0},
 {0,    12,     0}}</pre>
</div>
</div>
<div class="paragraph">
<p>You can also walk a matrix without the ability to change the internal values. This requires a <code>RealMatrixPreservingVisitor</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class CollectingVisitor extends DefaultRealMatrixPreservingVisitor {

    List values = []

    void visit(int row, int column, double value){
        values &lt;&lt; value
    }
}

def collectingVisitor = new CollectingVisitor()
mat.walkInOptimizedOrder(collectingVisitor)
println collectingVisitor.values</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the values are collected into a list and no matrix value is modified. You get the following result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[2.0, 18.0, 6.0, 0.0, 16.0, 0.0, 0.0, 14.0, 0.0, 0.0, 12.0, 0.0]</pre>
</div>
</div>
<div class="paragraph">
<p>This contains a list of all the values from our original matrix after the previous visitor has modified it.</p>
</div>
<div class="paragraph">
<p>Matrix operations can seem quite complicated; however, they are not bad with a helpful library. So far the Commons Math API seems pretty useful for these more advanced math concepts.</p>
</div>
<div class="paragraph">
<p>The entire script for this tutorial is provided below for completeness:</p>
</div>
<div class="listingblock">
<div class="title">matrix-math.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Grapes(
   @Grab('org.apache.commons:commons-math3:3.6.1')
)

import org.apache.commons.math3.linear.*

def formatter = new RealMatrixFormat('{', '}', '{', '}', ',\n ', ',\t')

def mat = new Array2DRowRealMatrix(4,3)
mat.setRow(0, [1.0, 2.0, 3.0] as double[])
mat.setColumn(1, [9.0, 8.0, 7.0, 6.0] as double[])

println formatter.format(mat)
println()

def seqMat = new Array2DRowRealMatrix([
    [1.0, 2.0, 3.0] as double[],
    [4.0, 5.0, 6.0] as double[],
    [7.0, 8.0, 9.0] as double[],
    [10.0, 11.0, 12.0] as double[]
] as double[][])

println formatter.format(seqMat)
println()

def sum = mat.add(seqMat)
println formatter.format(sum)
println()

def diff = seqMat.subtract(mat)
println formatter.format(diff)
println()

def prod = mat.scalarMultiply(2)
println formatter.format(prod)
println()

def trans = seqMat.transpose()
println formatter.format(trans)
println()

class MultiplicationVisitor extends DefaultRealMatrixChangingVisitor {

    double factor

    double visit(int row, int column, double value){
        value * factor
    }
}

mat.walkInOptimizedOrder(new MultiplicationVisitor(factor:2.0))
println formatter.format(mat)
println()

class CollectingVisitor extends DefaultRealMatrixPreservingVisitor {

    List values = []

    void visit(int row, int column, double value){
        values &lt;&lt; value
    }
}

def collectingVisitor = new CollectingVisitor()
mat.walkInOptimizedOrder(collectingVisitor)
println collectingVisitor.values
println()</code></pre>
</div>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/dependencies-behind-the-wall.html">Gradle Dependencies Behind the Wall</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 10 July 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/gradle.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> gradle</span></a>
                <p><div class="paragraph">
<p>Some companies like to take full control of their build environments and disallow builds that pull artifacts from external sources so that only approved internal artifact repositories are used containing only approved artifacts. While the validity of this is debatable, it exists and in my experience tends to add roadblocks to development, especially when working with new frameworks and libraries.</p>
</div>
<div class="paragraph">
<p>Consider the scenario where you are working on a poject that uses a newer version of the Spring Framework than has been previously used in the company. Now you need to get the new Spring artifacts into your approved repository, which requires an issue ticket of some sort and at least one or two architects to approve it. I am sure I am not shocking you when I say that Spring has numerous dependencies if you are doing anything interesting with it and they are all transient. How do you get a list of the dependencies that you need to have added without an arduous catalogging of artifacts and their dependencies or numerous iterations of the list-ticket-approval work flow( which is not generally speedy)? You write a Gradle plugin to do it for you.</p>
</div>
<div class="paragraph">
<p>I have added a <code>checkAvailability</code> task to my <a href="http://stehno.com/dependency-checker/">Dependency Checker Plugin</a>. This task allows you to do your development work using the standard <code>jcenter</code> or <code>mavenCentral</code> artifact repositories so that you can get things working, but when you are ready to lock down your dependencies you can run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew checkAvailability -PrepoUrls=http://artifacts.mycompany.com/repository</pre>
</div>
</div>
<div class="paragraph">
<p>Which will list out the dependencies missing from the specified repository without affecting your build. The reported console entries will look something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Availability check for (commons-lang:commons-lang:2.1.2): FAILED</pre>
</div>
</div>
<div class="paragraph">
<p>You can provide additional configuration to futher configure the task:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>checkAvailability {
    repoUrls = ['http://artifacts.mycompany.com/repository']
    configurations = ['runtime']
    ignored = ['com.something:thingifier:1.2.3']
    failOnMissing = true
}</pre>
</div>
</div>
<div class="paragraph">
<p>This configuration will specify the default <code>repoUrls</code> to be used, which may still be overridden on the command line. The <code>configurations</code> property allows you to limit the dependency configurations searched (to only <code>runtime</code> in this case). The <code>ignored</code> property allows specified artifacts to be ignored even if they are missing. And finally, the <code>failOnMissing</code> property will cause the build to fail when set to <code>true</code> after reporting all the missing dependencies - the default is <code>false</code> so that it will only list the status of the dependencies and allow the build to continue.</p>
</div>
<div class="paragraph">
<p>Now, armed with a full list of the dependencies missing from your internal artifact repository, you can create your issue ticket and get the approvals once and get back to actual work faster.</p>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/custom-shell-banner.html">Custom Spring Boot Shell Banner</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 25 March 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a> <a href='/tags/spring.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> spring</span></a>
                <p><div class="paragraph">
<p>I did a <a href="http://dfw2gug.org/blog/2016/march-2016.html">Groovy User Group talk</a> recently related to my <a href="http://coffeaelectronica.com/blog/2015/spring-shell.html">Spring Boot Remote Shell</a> blog post and while putting the talk together I stumbled across a bug in the integration between Spring Boot and the Crash shell (see <a href="https:///github.com/spring-projects/spring-boot/issues/3988">Spring-Boot-3988</a>). The custom banner you can add to your Spring Boot application (as /resources/banner.txt) is not applied by default to your crash shell, so you get the boring Spring logo every time you startup the shell. I had worked with the Crash shell previously and I remember that the banner was customizable so I did a little digging and figured out how to code a work-around - I also added this information to the bug ticket; I considered contributing a pull request, but I am not sure how this would be coded into the default application framework.</p>
</div>
<div class="paragraph">
<p>The work-around is pretty simple and straight-forward if you have worked with the crash shell before. You use their method of customization and then have it pull in your Spring Boot custom banner. In your <code>/src/main/resources/commands</code> directory you add a <code>login.groovy</code> file, which Crash will load with every shell connection. The file allows the customization of the banner and the prompt. We can then load our spring banner from the classpath. The basic code is as follows:</p>
</div>
<div class="listingblock">
<div class="title">login.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">welcome = { -&gt;
    def hostName;
    try {
        hostName = java.net.InetAddress.getLocalHost().getHostName();
    } catch (java.net.UnknownHostException ignore) {
        hostName = 'localhost';
    }

    String banner = YourApplication.getResourceAsStream('/banner.txt').text

    return """
${banner}
Logged into $hostName @ ${new Date()}
"""
}

prompt = { -&gt;
    return "% ";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a silly little thing to worry about, but sometimes it&#8217;s the little things that make an application feel more like your own.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I have created a <a href="https://github.com/spring-projects/spring-boot/pull/5453">pull request</a> in the spring-boot project to address this issue&#8230;&#8203; we&#8217;ll see what happens.</p>
</div>
</blockquote>
</div></p>
            </div>
        </div>
  	
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <h1><a href="blog/2016/groovy-di.html">Groovy Dependency Injection</a></h1>
                <p><em><span class="glyphicon glyphicon-calendar"></span> 19 March 2016</em> ~ <a href='/tags/blog.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> blog</span></a> <a href='/tags/groovy.html'><span class='label label-success'><span class='glyphicon glyphicon-tag'></span> groovy</span></a>
                <p><div class="paragraph">
<p>Dependency Injection frameworks were a dime a dozen for a while - everybody had their own and probably a spare just in case. For the most part the field has settled down to a few big players, the <a href="http://springframework.org">Spring Framework</a> and <a href="https://github.com/google/guice">Google Guice</a> are the only two that come to mind. While both of these have their pluses and minuses, they both have a certain level of overhead in libraries and understanding. Sometimes you want to throw something together quickly or you are in a scenario where you can&#8217;t use one of these off the shelf libraries. I had to do this recently and while I still wanted to do something spring/guice-like, I could not use either of them, but I did have Groovy available.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I want to preface the further discussion here to say that I am not suggesting you stop using Spring or Guice or whatever you are using now in favor of rolling your own Groovy DI - this is purely a sharing of information about how you can if you ever need to.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s use as an example a batch application used to process some game scores and report on the min/max/average values. We will use a database (H2) just to show a little more configuration depth and I will use the <code>TextFileReader</code> class from my <a href="http://stehno.com/vanilla">Vanilla</a> project to keep things simple and focussed on DI rather than logic.</p>
</div>
<div class="paragraph">
<p>First, we need the heart of our DI framework, the configuration class. Let&#8217;s call it <code>Config</code>; we will also need a means of loading external configuration properties and this is where our first Groovy helper comes in, the <code>ConfigSlurper</code>. The <code>ConfigSlurper</code> does what it sounds like, it slurps up a configuration file with a Groovy-like syntax and converts it to a <code>ConfigObject</code>. To start with, our <code>Config</code> class looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class Config {
    private final ConfigObject config

    Config(final URL configLocation) {
        config = new ConfigSlurper().parse(configLocation)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The backing configuration file we will use, looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>inputFile = 'classpath:/scores.csv'

datasource {
    url = 'jdbc:h2:mem:test'
    user = 'sa'
    pass = ''
}</pre>
</div>
</div>
<div class="paragraph">
<p>This will live in a file named <code>application.cfg</code> and as can be seen, it will store our externalized config properties.</p>
</div>
<div class="paragraph">
<p>Next, let&#8217;s configure our <code>DataSource</code>. Both Spring and Guice have a similar "bean definition" style, and what I am sure is based on those influences, I came up with something similar here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Memoized(protectedCacheSize = 1, maxCacheSize = 1)
DataSource dataSource() {
    JdbcConnectionPool.create(
        config.datasource.url,
        config.datasource.user,
        config.datasource.pass
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that I used the <code>@Memoized</code> Groovy transformation annotation. This ensures that once the "bean" is created, the same instance is reused, and since I will only ever have one, I can limit the cache size and make sure it sicks around. As an interesting side-item, I created a collected annotation version of the memoized functionality and named it <code>@OneInstance</code> since <code>@Singleton</code> was alread taken.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Memoized(protectedCacheSize = 1, maxCacheSize = 1)
@AnnotationCollector
@interface OneInstance {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It just keeps things a little cleaner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@OneInstance DataSource dataSource() {
    JdbcConnectionPool.create(
        config.datasource.url,
        config.datasource.user,
        config.datasource.pass
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, notice how the <code>ConfigObject</code> is used to retrieve the configuration property values, very clean and concise.</p>
</div>
<div class="paragraph">
<p>Next, we need to an input file to read and a <code>TextFileReader</code> to read it so we will configure those as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@OneInstance Path inputFilePath() {
    if (config.inputFile.startsWith('classpath:')) {
        return Paths.get(Config.getResource(config.inputFile - 'classpath:').toURI())
    } else {
        return new File(config.inputFile).toPath()
    }
}

@OneInstance TextFileReader fileReader() {
    new TextFileReader(
        filePath: inputFilePath(),
        firstLine: 2,
        lineParser: new CommaSeparatedLineParser(
            (0): { v -&gt; v as long },
            (2): { v -&gt; v as int }
        )
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I added a little configuration sugar so that you can define the input file as a classpath file or an external file. The <code>TextFileReader</code> is setup to convert the data csv file as three columns of data, an id (long), a username (string) and a score (int). The data file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># id,username,score
100,bhoser,4523
200,ripplehauer,235
300,jegenflur,576
400,bobknows,997</pre>
</div>
</div>
<div class="paragraph">
<p>The last thing we need in the configuration is our service which will do that data management and the stat calculations, we&#8217;ll call it the <code>StatsService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@TypeChecked
class StatsService {

    private Sql sql

    StatsService(DataSource dataSource) {
        sql = new Sql(dataSource)
    }

    StatsService init() {
        sql.execute('create table scores (id bigint PRIMARY KEY, username VARCHAR(20) NOT NULL, score int NOT NULL )')
        this
    }

    void input(long id, String username, int score) {
        sql.executeUpdate(
            'insert into scores (id,username,score) values (?,?,?)',
            id,
            username,
            score
        )
    }

    void report() {
        def row = sql.firstRow(
            '''
            select
                count(*) as score_count,
                avg(score) as average_score,
                min(score) as min_score,
                max(score) as max_score
            from scores
            '''
        )

        println "Count  : ${row.score_count}"
        println "Min    : ${row.min_score}"
        println "Max    : ${row.max_score}"
        println "Average: ${row.average_score}"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m just going to dump it out there since it&#8217;s mostly SQL logic to load the data into the table and then report the stats out to the standard output. We will wire this in like the others in <code>Config</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@OneInstance StatsService statsService() {
    new StatsService(dataSource()).init()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that, our configuration is done. Now we need to use it in an application, which we&#8217;ll call <code>Application</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class Application {

    static void main(args){
        Config config = Config.fromClasspath('/application.cfg')

        StatsService stats = config.statsService()
        TextFileReader reader = config.fileReader()

        reader.eachLine { Object[] line-&gt;
            stats.input(line[0], line[1], line[2])
        }

        stats.report()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We instantiate a <code>Config</code> object, call the bean accessor methods and use the beans to do the desired work. I added the <code>fromClasspath(String)</code> helper method to simplify loading config from the classpath.</p>
</div>
<div class="paragraph">
<p>Like I said, this is no fulltime replacement for a real DI framework; however, when I was in a pinch, this came in pretty handy and worked really well. Also, it was easy to extend the <code>Config</code> class in the testing source so that certain parts of the configuration could be overridden and mocked as needed during testing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The demo code for this post is on <a href="https://github.com/cjstehno/groovy-di">GitHub: cjstehno/groovy-di</a>.
</td>
</tr>
</table>
</div></p>
            </div>
        </div>
  	

<div class="well well-sm">
    <p><span class="glyphicon glyphicon-calendar"></span> Older posts are available in the <a href="/archive.html">archives</a>.</p>
</div>



            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <hr>
                    <div style="text-align:center;">
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a> CoffeaElectronica.com content is copyright &copy; 2016 <a href="http://stehno.com">Christopher J. Stehno</a> and available under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
                    </div>
                </div>
            </div>

        </div>

        <script src="/js/jquery-1.12.4.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/prettify.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-27165855-1', 'auto');
            ga('send', 'pageview');
        </script>
    </body>
</html>